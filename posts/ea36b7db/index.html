<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-wall.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-wall.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-jsxllPgZAX">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic|JetBrains Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"thysrael.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Log1 产品 Product1.1 创建 Product创建名为 project 的 rails 应用 rails new project">
<meta property="og:type" content="article">
<meta property="og:title" content="Ruby设计-开发日志">
<meta property="og:url" content="https://thysrael.github.io/posts/ea36b7db/index.html">
<meta property="og:site_name" content="钟鼓楼">
<meta property="og:description" content="Log1 产品 Product1.1 创建 Product创建名为 project 的 rails 应用 rails new project">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-01-05T04:10:36.000Z">
<meta property="article:modified_time" content="2025-08-15T12:16:47.800Z">
<meta property="article:author" content="Thysrael">
<meta property="article:tag" content="直观理解">
<meta property="article:tag" content="S5课上">
<meta property="article:tag" content="Ruby设计">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://thysrael.github.io/posts/ea36b7db/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Ruby设计-开发日志 | 钟鼓楼</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="钟鼓楼" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/thysrael" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">钟鼓楼</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">钟楼瘦，鼓楼胖</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">31</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">70</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">199</span></a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/resource/" rel="section"><i class="fa fa-book fa-fw"></i>Resource</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>Links</a>

  </li>
        <li class="menu-item menu-item-roam">

    <a href="/obsidian-quartz/" rel="section"><i class="fa fa-sitemap fa-fw"></i>Roam</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thysrael.github.io/posts/ea36b7db/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.png">
      <meta itemprop="name" content="Thysrael">
      <meta itemprop="description" content="Can you hear me ?">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="钟鼓楼">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ruby设计-开发日志
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-05 12:10:36" itemprop="dateCreated datePublished" datetime="2023-01-05T12:10:36+08:00">2023-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-15 20:16:47" itemprop="dateModified" datetime="2025-08-15T20:16:47+08:00">2025-08-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ruby%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">Ruby设计</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>33k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>30 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h1><h2 id="1-产品-Product"><a href="#1-产品-Product" class="headerlink" title="1 产品 Product"></a>1 产品 Product</h2><h3 id="1-1-创建-Product"><a href="#1-1-创建-Product" class="headerlink" title="1.1 创建 Product"></a>1.1 创建 Product</h3><p>创建名为 <code>project</code> 的 rails 应用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails new project<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建 <code>Product</code> 模型</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate scaffold Product title:string description:text image_url:string price:decimal<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这会生成一个 <code>migration</code> ，我们需要进一步修改这个迁移，保证价格拥有 8 位有效数字，同时小数点后保留两位。修改迁移文件</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">CreateProducts</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">7.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    create_table <span class="token symbol">:products</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
      t<span class="token punctuation">.</span>string <span class="token symbol">:title</span>
      t<span class="token punctuation">.</span>text <span class="token symbol">:description</span>
      t<span class="token punctuation">.</span>string <span class="token symbol">:image_url</span>
      t<span class="token punctuation">.</span>decimal <span class="token symbol">:price</span><span class="token punctuation">,</span> precision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> scale<span class="token punctuation">:</span> <span class="token number">2</span>

      t<span class="token punctuation">.</span>timestamps
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后就可以进行 <code>migrate</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rake db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里的 <code>rake</code> 可以被理解为一个脚本的管理器，<code>db:migrate</code> 是其中的一个脚本。还有一种说法是 <code>rake</code> 类似与 C 中的 <code>make</code></p>
<p>最终我们对于数据库的修改，都会被记录在 <code>db/schema.rb</code> 中，比如说现在</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Schema</span><span class="token punctuation">[</span><span class="token number">7.0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>define<span class="token punctuation">(</span>version<span class="token punctuation">:</span> <span class="token number">2022</span>_12_31_030243<span class="token punctuation">)</span> <span class="token keyword">do</span>
  create_table <span class="token string">"products"</span><span class="token punctuation">,</span> force<span class="token punctuation">:</span> <span class="token symbol">:cascade</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
    t<span class="token punctuation">.</span>string <span class="token string">"title"</span>
    t<span class="token punctuation">.</span>text <span class="token string">"description"</span>
    t<span class="token punctuation">.</span>string <span class="token string">"image_url"</span>
    t<span class="token punctuation">.</span>decimal <span class="token string">"price"</span><span class="token punctuation">,</span> precision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> scale<span class="token punctuation">:</span> <span class="token number">2</span>
    t<span class="token punctuation">.</span>datetime <span class="token string">"created_at"</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">false</span>
    t<span class="token punctuation">.</span>datetime <span class="token string">"updated_at"</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token keyword">end</span>

<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到基本上与 <code>migration</code> 是一致的，原来的 <code>t.timestamps</code> 时间戳变成了 <code>created_at</code> 和 <code>updated_at</code> 两个属性。此外主键被叫做 <code>product_id</code> ，并没有在这里显示，这应该是一种默认配置。</p>
<h3 id="1-2-本地服务器"><a href="#1-2-本地服务器" class="headerlink" title="1.2 本地服务器"></a>1.2 本地服务器</h3><p>我们输入如下命令，就可以在本地启动服务器</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>会看到如下字样</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token operator">=</span><span class="token operator">&gt;</span> Booting Puma
<span class="token operator">=</span><span class="token operator">&gt;</span> Rails <span class="token number">7.0</span>.4 application starting <span class="token keyword">in</span> development<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>其中的 <code>Puma</code> 似乎是一个线程管理器，每个线程都用于处理来自客户端的一个 <code>request</code> 。</p>
<h3 id="1-3-表单"><a href="#1-3-表单" class="headerlink" title="1.3 表单"></a>1.3 表单</h3><p><code>app/views/products/_form.html.erb</code> 是一个局部渲染文件，用于当做 <code>product</code> 信息的表单，这个表单会在 <code>new.html.erb, edit.html.erb</code> 这两个文件中用到，如下所示</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>New product<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 这里对表单进行局部渲染，并且传递局部参数 product --&gt;</span>
&lt;%= render "form", product: @product %&gt;

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  &lt;%= link_to "Back to products", products_path %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于局部渲染，有如下知识：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/weixin_30621711/article/details/96260112">https://blog.csdn.net/weixin_30621711/article/details/96260112</a></p>
<p>表单的具体内容如下</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- form_with 是 rails 所带的一种表单形式，类似的还有 form_for --&gt;</span>
&lt;%= form_with(model: product) do |form| %&gt;
  <span class="token comment">&lt;!-- product 如果存在问题 --&gt;</span>
  &lt;% if product.errors.any? %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>&lt;%= pluralize(product.errors.count, "error") %&gt; prohibited this product from being saved:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        &lt;% product.errors.each do |error| %&gt;
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= error.full_message %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        &lt;% end %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;

  <span class="token comment">&lt;!-- product 的 title --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- title 表项 --&gt;</span>
    &lt;%= form.label :title, style: "display: block" %&gt;
    <span class="token comment">&lt;!-- title 具体内容 --&gt;</span>
    &lt;%= form.text_field :title %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- product 的 description --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :description, style: "display: block" %&gt;
    <span class="token comment">&lt;!-- 这里将产品描述的行数和列数进行了自定义增大 --&gt;</span>
    &lt;%= form.text_area :description, rows: 10, cols: 60 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- product 的 image_url --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :image_url, style: "display: block" %&gt;
    &lt;%= form.text_field :image_url %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- product 的 price --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :price, style: "display: block" %&gt;
    &lt;%= form.text_field :price %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- 填完表单后提交 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.submit %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
&lt;% end %&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意我们将表单的产品描述部分的输入框变大了</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 这里将产品描述的行数和列数进行了自定义增大 --&gt;</span>
&lt;%= form.text_area :description, rows: 10, cols: 60 %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="1-4-seeds"><a href="#1-4-seeds" class="headerlink" title="1.4 seeds"></a>1.4 seeds</h3><p>如果数据库不是同一个（一般本地开发多个，云端一个），那么测试数据就成了“个人私有”的，显然是低效的，我们可以给数据库一组“初始值“（也就是种子，seeds），这组初始值我们可以在 <code>db/seeds.rb</code> 中给出，如下所示</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token constant">Product</span><span class="token punctuation">.</span>delete_all

<span class="token constant">Product</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string">'Programming Ruby 1.9'</span><span class="token punctuation">,</span>
               description<span class="token punctuation">:</span>
                 <span class="token string">%{
              &lt;p&gt;
                Ruby is the fastest growing and most exciting dynamic language out there.
              &lt;/p&gt;
              }</span><span class="token punctuation">,</span>
               image_url<span class="token punctuation">:</span> <span class="token string">'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.kfzimg.com%2Fsw%2Fkfzimg%2F1575%2F012f2857fe9a2966a5_b.jpg&amp;refer=http%3A%2F%2Fwww.kfzimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1668567051&amp;t=61ed25128b60ad15cbe2c21729511f99'</span><span class="token punctuation">,</span>
               price<span class="token punctuation">:</span> <span class="token number">49.50</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后运行</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rake db:seed<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>就可以添加这个数据。</p>
<h3 id="1-5-SCSS"><a href="#1-5-SCSS" class="headerlink" title="1.5 SCSS"></a>1.5 SCSS</h3><p>当前的 <code>products</code> 页面过于丑陋，可以考虑给所有的产品界面一组样式，这里我们用 <code>scss</code> 实现，在 <code>app/assets/stylesheets/</code> 中创建 <code>products.scss</code> 并写入下面的内容</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token selector">.products </span><span class="token punctuation">{</span>
  <span class="token selector">table </span><span class="token punctuation">{</span>
    <span class="token property">border-collapse</span><span class="token punctuation">:</span> collapse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">table tr td</span><span class="token punctuation">{</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    <span class="token property">vertical-align</span><span class="token punctuation">:</span> top<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">.list_image </span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 70px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">.list_description </span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 60%<span class="token punctuation">;</span>

    <span class="token selector">dl </span><span class="token punctuation">{</span>
      <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">dt </span><span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> #244<span class="token punctuation">;</span>
      <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
      <span class="token property">font-size</span><span class="token punctuation">:</span> larger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">dd </span><span class="token punctuation">{</span>
      <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token selector">.list_actions </span><span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> x-small<span class="token punctuation">;</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>
    <span class="token property">padding-left</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">.list_line_even </span><span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #e0f8f8<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">.list_line_odd </span><span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #e2c3e2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后就会发现运行不了，这是因为 <code>rails</code> 默认不能处理 <code>scss</code>，需要在 <code>gemfile</code> 中加入如下依赖</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># Use Sass to process CSS</span>
gem <span class="token string">"sassc-rails"</span>
gem <span class="token string">'bootstrap-sass'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后命令行运行</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bundle <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这是因为</p>
<blockquote>
<p>rake是Ruby语言的构建工具，它的配置文件是Rakefile。</p>
<p>gem是Ruby语言的包管理工具，它的配置文件后缀是.gemspec。</p>
<p>bundler是Ruby语言的外部依赖管理工具，它有一个别名叫”bundle”，它的配置文件是Gemfile。</p>
</blockquote>
<p>然后在 <code>views/layouts/application.html.erb</code> 中需要进行修改，加上每个类对应不同的 <code>scss</code> 。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&lt;%= controller.controller_name %&gt;<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    &lt;%= yield %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p> <code>views/layouts/application.html.erb</code> 是一个布局页面，会对每一个页面都适用。</p>
<p>最后写一下 <code>index.html.erb</code> 的具体信息</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>product_list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Products<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>
    &lt;% @products.each do |product| %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%= cycle(<span class="token punctuation">'</span>list_line_odd<span class="token punctuation">'</span>, <span class="token punctuation">'</span>list_line_even<span class="token punctuation">'</span>) %&gt;<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
          &lt;%= image_tag(product.image_url, class: 'list_image') %&gt;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list_description<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>&lt;%= product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span>&lt;%= truncate(strip_tags(product.description), :length =&gt; 80) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list_actions<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          &lt;%= link_to 'Show', product %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
          &lt;%= link_to 'Edit', edit_product_path(product) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
          &lt;%= link_to 'Destroy', product, :confirm =&gt; 'Are you sure?', :method =&gt; :delete %&gt;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
    &lt;% end %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>

&lt;%= link_to 'New product', new_product_path %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-6-验证"><a href="#1-6-验证" class="headerlink" title="1.6 验证"></a>1.6 验证</h3><p>可以在模型层对于模型的属性添加验证，对于 <code>Product</code> 来说有如下验证</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  validates <span class="token symbol">:title</span><span class="token punctuation">,</span> <span class="token symbol">:description</span><span class="token punctuation">,</span> <span class="token symbol">:image_url</span><span class="token punctuation">,</span> presence<span class="token punctuation">:</span> <span class="token boolean">true</span>
  validates <span class="token symbol">:price</span><span class="token punctuation">,</span> numericality<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token symbol">:greater_than_or_equal_to</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0.01</span><span class="token punctuation">}</span>
  validates <span class="token symbol">:title</span><span class="token punctuation">,</span> uniqueness<span class="token punctuation">:</span> <span class="token boolean">true</span>
  validates <span class="token symbol">:image_url</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token symbol">:with</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token regex">%r{\.(gif|jpg|png)}i</span><span class="token punctuation">,</span>
    <span class="token symbol">:message</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'must be a URL for GIF, JPG or PNG image.'</span>
  <span class="token punctuation">}</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>验证的格式如下</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">validate <span class="token punctuation">[</span>属性名<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>验证内容<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>具体的验证内容有</p>
<ul>
<li><code>presence</code></li>
<li><code>numericality</code></li>
<li><code>uniqueness</code></li>
<li><code>uniqueness</code></li>
</ul>
<h3 id="1-7-路由设置"><a href="#1-7-路由设置" class="headerlink" title="1.7 路由设置"></a>1.7 路由设置</h3><p>为了更好的展示产品（而不是需要通过 <code>get</code> 路由访问产品列表），我们可以另外再从用户的角度完善一个页面，这需要借助一个一个新的控制器（在后面的开发中，它被定义为“付费购买用户所使用的控制器”），在终端输入</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate controller Store index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>它的意思是生成一个叫做 <code>Store</code> 的控制器，同时只有一个 <code>index</code> 动作。</p>
<p>然后我们希望当访问根目录的时候，可以访问到 <code>Store#index</code> 对应的界面，所以我们在 <code>router.rb</code> 中加上这句话</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">root <span class="token string">'store#index'</span><span class="token punctuation">,</span> as<span class="token punctuation">:</span> <span class="token string">'store_index'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>至于这个是怎么来的，可以这样理解，在路由中，标准写法是这样的</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">get <span class="token string">'/test/:id'</span><span class="token punctuation">,</span> to<span class="token punctuation">:</span> <span class="token string">'test#test'</span><span class="token punctuation">,</span> as <span class="token string">'test_test'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个意思是，用户用 <code>get</code> 的方式访问 <code>test/:id</code> 这个 ulr 的时候，实际访问的是 <code>Test</code> 控制器对应的 <code>test</code> 动作对应的 <code>view</code> 。当我们有了 <code>as</code> 之后，我们可以通过 <code>test_test_path</code> 来指代 <code>xxxx/test/:id</code> ，用 <code>test_test_url</code> 指代 <code>http:/xxxx/test/:id</code>。也就是说path 类方法是对应的路径，不带协议部分。url 生成的带 http。两者差别在此。</p>
<p>这样看上面的 <code>root</code> ，只是某种意义的简写。</p>
<p>我们常见的</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">resoureces<span class="token punctuation">:</span> products<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其实就是一堆标准格式的声明，如下所示</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>HTTP Verb</strong></th>
<th>Path</th>
<th><strong>Action</strong></th>
<th><strong>Used for</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/products</td>
<td>index</td>
<td>display a list of all products</td>
</tr>
<tr>
<td>GET</td>
<td>/products/new</td>
<td>new</td>
<td>return an HTML form for creating a new product</td>
</tr>
<tr>
<td>POST</td>
<td>/products</td>
<td>create</td>
<td>create a new product</td>
</tr>
<tr>
<td>GET</td>
<td>/products/:id</td>
<td>show</td>
<td>display a specific product</td>
</tr>
<tr>
<td>GET</td>
<td>/products/:id/edit</td>
<td>edit</td>
<td>return an HTML form for editing a product</td>
</tr>
<tr>
<td>PATCH/PUT</td>
<td>/products/:id</td>
<td>update</td>
<td>update a specific product</td>
</tr>
<tr>
<td>DELETE</td>
<td>/products/:id</td>
<td>destroy</td>
<td>delete a specific product</td>
</tr>
</tbody>
</table>
</div>
<p>其中 <code>PATCH, PUT, POST</code> 都会被转换成 <code>POST</code></p>
<ul>
<li>PATCH： 实体中包含一个表，表中说明与该URI所表示的原内容的区别</li>
<li>PUT：上传资源</li>
<li>DELETE：删除资源</li>
</ul>
<h3 id="1-8-美化商品目录"><a href="#1-8-美化商品目录" class="headerlink" title="1.8 美化商品目录"></a>1.8 美化商品目录</h3><p>在 <code>store#index</code> 中补充如下代码，表示按字典序展示所有的 <code>Product</code></p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">StoreController</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">index</span></span>
    <span class="token variable">@products</span> <span class="token operator">=</span> <span class="token constant">Product</span><span class="token punctuation">.</span>order<span class="token punctuation">(</span><span class="token symbol">:title</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时调整相应的视图</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notice<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= notice %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Your Pragmatic Catalog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

&lt;% @products.each do |product| %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>entry<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    &lt;%= image_tag(product.image_url) %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>&lt;%= product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    &lt;%= sanitize(product.description) %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price_line<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        &lt;%= number_to_currency(product.price) %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
&lt;% end %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>相应的 scss 表</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token selector">.store </span><span class="token punctuation">{</span>
  <span class="token selector">h1 </span><span class="token punctuation">{</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 0.5em<span class="token punctuation">;</span>
    <span class="token property">font</span><span class="token punctuation">:</span> 150% Sans-Serif<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #226<span class="token punctuation">;</span>
    <span class="token property">border-bottom</span><span class="token punctuation">:</span> 3px dotted #77d<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">.entry </span><span class="token punctuation">{</span>
    <span class="token property">overflow</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
    <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px dotted #77d<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">img </span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 80px<span class="token punctuation">;</span>
    <span class="token property">margin-right</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">h3 </span><span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 120%<span class="token punctuation">;</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span>
    <span class="token property">margin-left</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 2px<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #277<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">p, div.price_line </span><span class="token punctuation">{</span>
    <span class="token property">margin-left</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> 0.5em<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">.price </span><span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #44a<span class="token punctuation">;</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
    <span class="token property">margin-right</span><span class="token punctuation">:</span> 3em<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-9-页面布局"><a href="#1-9-页面布局" class="headerlink" title="1.9 页面布局"></a>1.9 页面布局</h3><p>修改 <code>layouts/application.html.erb</code> 加入侧边栏和顶栏</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Pragprog Books Online Store<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width,initial-scale=1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  &lt;%= csrf_meta_tags %&gt;
  &lt;%= csp_meta_tag %&gt;

  &lt;%= stylesheet_link_tag "application", "data-turbo-track": "reload" %&gt;
  &lt;%= javascript_importmap_tags %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>&lt;%= controller.controller_name %&gt;<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>banner<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= @page_title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>columns<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>side<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Question<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>News<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Contact<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    &lt;%= yield %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时修改 <code>scss</code> 文件</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token selector">body, body &gt; p, body &gt; ol, body &gt; ul, body &gt; td </span><span class="token punctuation">{</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 8px <span class="token important">!important</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#banner </span><span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  <span class="token property">min-height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #9c9<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">border-bottom</span><span class="token punctuation">:</span> 2px solid<span class="token punctuation">;</span>
  <span class="token property">font</span><span class="token punctuation">:</span> small-caps 40px/40px <span class="token string">"Times New Roman"</span><span class="token punctuation">,</span> serif<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #282<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>

  <span class="token selector">img </span><span class="token punctuation">{</span>
    <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
    <span class="token property">top</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    <span class="token property">left</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token selector">#notice </span><span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #000 <span class="token important">!important</span><span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 2px solid red<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 2em<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #f0f0f0<span class="token punctuation">;</span>
  <span class="token property">font</span><span class="token punctuation">:</span> bold smaller sans-serif<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#notice:empty </span><span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#columns </span><span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #141<span class="token punctuation">;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>

  <span class="token selector">#main </span><span class="token punctuation">{</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
    <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token selector">#side </span><span class="token punctuation">{</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 1em 2em<span class="token punctuation">;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #141<span class="token punctuation">;</span>

    <span class="token selector">ul </span><span class="token punctuation">{</span>
      <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>

      <span class="token selector">li </span><span class="token punctuation">{</span>
        <span class="token property">list-style</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>

        <span class="token selector">a </span><span class="token punctuation">{</span>
          <span class="token property">color</span><span class="token punctuation">:</span> #bfb<span class="token punctuation">;</span>
          <span class="token property">font-size</span><span class="token punctuation">:</span> small<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@media</span> all <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 800px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">#columns </span><span class="token punctuation">{</span>
    <span class="token property">flex-direction</span><span class="token punctuation">:</span> column-reverse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@media</span> all <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 500px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">#banner </span><span class="token punctuation">{</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 1em<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token selector">#banner .title </span><span class="token punctuation">{</span>
    <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="2-购物车-Cart"><a href="#2-购物车-Cart" class="headerlink" title="2 购物车 Cart"></a>2 购物车 Cart</h2><h3 id="2-1-Cart-模型"><a href="#2-1-Cart-模型" class="headerlink" title="2.1 Cart 模型"></a>2.1 Cart 模型</h3><p>创建购物车</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate scaffold Cart
rake db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以看到 <code>Cart</code> 基本上没有任何属性，这是因为当前开发的时候我们还不需要它们。</p>
<h3 id="2-2-LineItem-商品模型"><a href="#2-2-LineItem-商品模型" class="headerlink" title="2.2 LineItem 商品模型"></a>2.2 LineItem 商品模型</h3><p>我们称在购物车中东西为“商品”，与之对应的还有“产品 Product”，两者的区别是 Product 具有某种静态的属性，没有办法说“两种香皂”，但是很容易形容“两个香皂”。<code>LineItem</code> 依附 <code>Product</code> 存在，同时也依附 <code>Cart</code>。</p>
<p>所以我们这样定义它</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate scaffold LineItem product:references cart:belongs_to
rake db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这种定义方式会在模型层自动生成如下代码</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">LineItem</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  belongs_to <span class="token symbol">:product</span>
  belongs_to <span class="token symbol">:cart</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时我们还需要在 <code>Cart</code> 和 <code>Product</code> 处进一步完善这种关系</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Cart</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  has_many <span class="token symbol">:line_items</span><span class="token punctuation">,</span> dependent<span class="token punctuation">:</span> <span class="token symbol">:destroy</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其中的 <code>dependent: :destroy</code> 表示当 <code>Cart</code> 销毁的时候，其中的 <code>LineItem</code> 都会被销毁。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># 与 line_item 关系</span>
has_many <span class="token symbol">:line_items</span>
before_destroy <span class="token symbol">:ensure_not_referenced_by_any_line_item</span>

<span class="token keyword">private</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">ensure_not_referenced_by_any_line_item</span></span>
    <span class="token keyword">unless</span> line_items<span class="token punctuation">.</span>empty<span class="token operator">?</span>
        errors<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token symbol">:base</span><span class="token punctuation">,</span> <span class="token string">'Line Items present'</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token symbol">:abort</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里说的是，在 <code>Product</code> 被销毁前，必须执行 <code>ensure_not_referenced_by_any_line_item</code>  这个方法，这个方法检测如果没有商品关联，才可以删除，否则报错。</p>
<p>我们可以对这个功能进行测试，有</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">test <span class="token string">"can't delete product in cart"</span> <span class="token keyword">do</span>
  assert_difference<span class="token punctuation">(</span><span class="token string">'Product.count'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    delete product_url<span class="token punctuation">(</span>products<span class="token punctuation">(</span><span class="token symbol">:two</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-3-会话"><a href="#2-3-会话" class="headerlink" title="2.3 会话"></a>2.3 会话</h3><p>出于一些原因，我们需要在会话中保存 <code>cart_id</code>，用户每添加一个商品，我们需要从会话中把 <code>cart_id</code> 取出来，然后通过标识符在数据库中查找购物车。</p>
<p>我们在 <code>app/controllers/concerns/current_cart.rb</code> 中写入如下代码</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">module</span> <span class="token constant">CurrentCart</span>
  
  <span class="token keyword">private</span>
    <span class="token comment"># 用 session 中的 cart_id 去查找 cart，如果没有找到，就创建一个新的 cart，并在 session 中存储 cart_id</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">set_cart</span></span>
      <span class="token variable">@cart</span> <span class="token operator">=</span> <span class="token constant">Cart</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token symbol">:cart_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">rescue</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">RecordNotFound</span>
      <span class="token variable">@cart</span> <span class="token operator">=</span> <span class="token constant">Cart</span><span class="token punctuation">.</span>create
      session<span class="token punctuation">[</span><span class="token symbol">:cart_id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">@cart</span><span class="token punctuation">.</span>id
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> <code>app/controllers/concerns/</code> 这个文件夹中一般来说是一些独立的逻辑模块或者是重复使用的功能模块，这样可以提升代码的可读性以及维护性。</p>
<h3 id="2-4-“加入购物车”"><a href="#2-4-“加入购物车”" class="headerlink" title="2.4 “加入购物车”"></a>2.4 “加入购物车”</h3><p>我们可以将某个 <code>Product</code> 加入某个 <code>Cart</code> ，其本质是利用 <code>Product</code> 产生一个 <code>LineItem</code>。</p>
<p>所以需要现在商品目录加上这个按钮，最终达到调用 <code>LineItem#create</code> 的目的。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price_line<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 显示价格 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= number_to_currency(product.price) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 加入购物车 --&gt;</span>
    &lt;%= button_to 'Add to Cart', line_items_path(product_id: product) %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">line_items_path<span class="token punctuation">(</span>product_id<span class="token punctuation">:</span> product<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>就是调用 <code>LineItem</code> 创建方法 <code>create</code> 的意思，同时给它传参 <code>product_id</code></p>
<p>然后我们来完善 <code>LineItem</code> 的 <code>create</code> 方法。</p>
<p>首先在 <code>LintItemController.rb</code> 中引入 <code>CurrentCart</code> 模块，并且在每次的 <code>create</code> 方法前都调用 <code>:set_cart</code> 方法</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">LineItemsController</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  <span class="token keyword">include</span> <span class="token constant">CurrentCart</span>
  before_action <span class="token symbol">:set_cart</span><span class="token punctuation">,</span> only<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token symbol">:create</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>因为在 <code>:set_cart</code> 中会对 <code>@cart</code> 赋值，让其为当前对话 <code>session</code> 独有的 <code>cart</code>，所以最终的效果就是 <code>LineItem</code> 创建前就有一个 <code>@cart</code> 属性了。</p>
<p>然后修改 <code>create</code> 方法</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># POST /line_items or /line_items.json</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span>
    <span class="token comment"># 根据传入的 product_id 查找 product</span>
    product <span class="token operator">=</span> <span class="token constant">Product</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:product_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># build 方法与 new 方法类似，会创建一个与 @cart 和 product 都相关的 @line_item</span>
    <span class="token variable">@line_item</span> <span class="token operator">=</span> <span class="token variable">@cart</span><span class="token punctuation">.</span>line_items<span class="token punctuation">.</span>build<span class="token punctuation">(</span>product<span class="token punctuation">:</span> product<span class="token punctuation">)</span>

    respond_to <span class="token keyword">do</span> <span class="token operator">|</span>format<span class="token operator">|</span>
      <span class="token keyword">if</span> <span class="token variable">@line_item</span><span class="token punctuation">.</span>save
        <span class="token comment"># 跳转的对象不再是 @line_item，而是它的购物车</span>
        format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> redirect_to <span class="token variable">@line_item</span><span class="token punctuation">.</span>cart<span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">"Line item was successfully created."</span> <span class="token punctuation">}</span>
        format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render <span class="token symbol">:show</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:created</span><span class="token punctuation">,</span> location<span class="token punctuation">:</span> <span class="token variable">@line_item</span> <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> render <span class="token symbol">:new</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
        format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render json<span class="token punctuation">:</span> <span class="token variable">@line_item</span><span class="token punctuation">.</span>errors<span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后修改 <code>cart</code> 的 <code>show</code> 页面，让其可以显示里面的 LineItem。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notice<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= notice %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Your Pragmatic Cart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  &lt;% @cart.line_items.each do |item| %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= item.product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-5-加入数量"><a href="#2-5-加入数量" class="headerlink" title="2.5 加入数量"></a>2.5 加入数量</h3><p>对于一个商品来说，之前的设计是有问题的，比如说我们买了两个香皂，那么不应该是“香皂，香皂”的显示两遍，而是应该“2 x 香皂”这样的显示，所以对于 <code>LineItem</code> 来说，数量是极其必要的。</p>
<p>所以创建迁移</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate migration add_quantity_to_line_items quantity:integer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>但是还需要接着修改这个迁移，因为要设置其默认值为 1</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">AddQuantityToLineItems</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">7.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    <span class="token comment"># 默认值是 1</span>
    add_column <span class="token symbol">:line_items</span><span class="token punctuation">,</span> <span class="token symbol">:quantity</span><span class="token punctuation">,</span> <span class="token symbol">:integer</span><span class="token punctuation">,</span> default<span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后需要修改 <code>add_cart</code> 的行为，并不是每次“加入购物车”，都是会产生一个新的 <code>LineItem</code> 的。首先在 <code>app/models/cart.rb</code> 中加入方法</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">add_product</span></span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>
    <span class="token comment"># 根据 product_id 查找 current_item</span>
    current_item <span class="token operator">=</span> line_items<span class="token punctuation">.</span>find_by<span class="token punctuation">(</span>product<span class="token punctuation">:</span> product<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

    <span class="token keyword">if</span> current_item
        <span class="token comment"># 查找到了，就数量增加 1</span>
        current_item<span class="token punctuation">.</span>quantity <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">else</span>
        <span class="token comment"># 没查找到，就创建 line_item</span>
        current_item <span class="token operator">=</span> line_items<span class="token punctuation">.</span>build<span class="token punctuation">(</span>product_id<span class="token punctuation">:</span> product<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment"># 返回 current_item</span>
    current_item
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后修改 <code>line_item#create</code></p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token variable">@line_item</span> <span class="token operator">=</span> <span class="token variable">@cart</span><span class="token punctuation">.</span>add_product<span class="token punctuation">(</span>product<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同时为了让已有的 <code>LineItem</code> 数据依然显示正确，需要创建一个迁移进行修改</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate migration combine_items_in_cart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个迁移没法按照“约定”自动产生 <code>change</code>，所以需要自己手写 <code>up, down</code>（这两个方法似乎也是某种约定）</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">CombineItemsInCart</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">7.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">up</span></span>
    <span class="token constant">Cart</span><span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>cart<span class="token operator">|</span>
      <span class="token comment"># 把购物车中同一个产品的多个商品替换为单个商品</span>
      sums <span class="token operator">=</span> cart<span class="token punctuation">.</span>line_items<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token symbol">:product_id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token symbol">:quantity</span><span class="token punctuation">)</span>

      sums<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>product_id<span class="token punctuation">,</span> quantity<span class="token operator">|</span>
        <span class="token keyword">if</span> quantity <span class="token operator">&gt;</span> <span class="token number">1</span>
          <span class="token comment"># 删除同一个产品的多个商品</span>
          cart<span class="token punctuation">.</span>line_items<span class="token punctuation">.</span>where<span class="token punctuation">(</span>product_id<span class="token punctuation">:</span> product_id<span class="token punctuation">)</span><span class="token punctuation">.</span>delete_all

          <span class="token comment"># 替换为单个商品</span>
          item <span class="token operator">=</span> cart<span class="token punctuation">.</span>line_items<span class="token punctuation">.</span>build<span class="token punctuation">(</span>product_id<span class="token punctuation">:</span> product_id<span class="token punctuation">)</span>
          item<span class="token punctuation">.</span>quantity <span class="token operator">=</span> quantity
          item<span class="token punctuation">.</span>save<span class="token operator">!</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">down</span></span>
    <span class="token constant">LineItem</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token string">"quantity&gt;1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>line_item<span class="token operator">|</span>
      line_item<span class="token punctuation">.</span>quantity<span class="token punctuation">.</span>times <span class="token keyword">do</span>
        <span class="token constant">LineItem</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span>
          cart_id<span class="token punctuation">:</span> line_item<span class="token punctuation">.</span>cart_id<span class="token punctuation">,</span>
          product_id<span class="token punctuation">:</span> line_item<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span>
          quantity<span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">)</span>
      <span class="token keyword">end</span>
      line_item<span class="token punctuation">.</span>destroy
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-6-清空购物车"><a href="#2-6-清空购物车" class="headerlink" title="2.6 清空购物车"></a>2.6 清空购物车</h3><p>清空购物车的本质是将当前的购物车删除，所以先加入“清空按钮”在 <code>show.html</code> 中</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notice<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= notice %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Your Cart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 购物清单 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>
  &lt;% @cart.line_items.each do |item| %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>&lt;%= item.quantity %&gt; <span class="token entity named-entity" title="×">&amp;times;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>&lt;%= item.product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item_price<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= number_to_currency(item.total_price) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;
  <span class="token comment">&lt;!-- 总金额 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total_line<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">colspan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Total<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total_cell<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= number_to_currency(@cart.total_price) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 清空购物车 --&gt;</span>
&lt;%= button_to 'Empty Cart', @cart, method: :delete, data: {confirm: 'Are you sure?'} %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并且补充相应的方法即可。</p>
<h3 id="2-7-局部渲染"><a href="#2-7-局部渲染" class="headerlink" title="2.7 局部渲染"></a>2.7 局部渲染</h3><p>我们希望在侧边栏也有购物车信息，所以我们考虑利用局部渲染。具体的知识在前面有，所以按照递归的思路，我们需要在 <code>application.html.erb</code> 中加入购物车</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cart<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
   &lt;%= render @cart %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个东西会去渲染 <code>_cart.html.erb</code> 文件，所以需要将它的内容改得和 <code>carts/show.html.erb</code> 一样</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Your Cart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 购物清单 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>
  &lt;%= render(cart.line_items) %&gt;
  <span class="token comment">&lt;!-- 总金额 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total_line<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">colspan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Total<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total_cell<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= number_to_currency(cart.total_price) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 清空购物车 --&gt;</span>
&lt;%= button_to 'Empty Cart', @cart, method: :delete, data: {confirm: 'Are you sure?'} %&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面有一个</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;%= render(cart.line_items) %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这是因为对于 <code>line_items</code> 的渲染，在 <code>cart_html.erb</code> 中也出现了。这种局部渲染是一种集合渲染，所以渲染的模板在 <code>_line_item.html.erb</code> 中，修改如下</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>&lt;%= line_item.quantity %&gt; <span class="token entity named-entity" title="×">&amp;times;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>&lt;%= line_item.product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item_price<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= number_to_currency(line_item.total_price) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最终意识到其实没有必要对 <code>carts/show.html.erb</code> 重复内容，所以将其改为</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notice<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= notice %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

&lt;%= render @cart %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>因为在侧边栏中现在也有了 <code>cart</code> ，所以同样需要 <code>set_cart</code> ，所以对于 <code>StoreController</code> 中加入如下代码</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">StoreController</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  <span class="token keyword">include</span> <span class="token constant">CurrentCart</span>
  before_action <span class="token symbol">:set_cart</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">index</span></span>
    <span class="token variable">@products</span> <span class="token operator">=</span> <span class="token constant">Product</span><span class="token punctuation">.</span>order<span class="token punctuation">(</span><span class="token symbol">:title</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-8-Ajax-购物车"><a href="#2-8-Ajax-购物车" class="headerlink" title="2.8 Ajax 购物车"></a>2.8 Ajax 购物车</h3><p>现在每次进行 <code>Add Cart</code> 操作，本质都是在渲染整个 <code>application.html.erb</code> 页面，这无疑是低效的，所以考虑只渲染侧边栏的购物车部分。</p>
<p>首先需要在 <code>Add Cart</code> 按钮上添加 <code>remote</code> 参数</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;%= button_to 'Add to Cart', line_items_path(product_id: product), remote:true %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后在 <code>create</code> 方法上加入神秘的 <code>format.js</code> ，我暂时还理解不了为啥，可以理解为启用了 js 脚本</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># POST /line_items or /line_items.json</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span>
    <span class="token comment"># 根据传入的 product_id 查找 product</span>
    product <span class="token operator">=</span> <span class="token constant">Product</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:product_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># build 方法与 new 方法类似，会创建一个与 @cart 和 product 都相关的 @line_item</span>
    <span class="token variable">@line_item</span> <span class="token operator">=</span> <span class="token variable">@cart</span><span class="token punctuation">.</span>add_product<span class="token punctuation">(</span>product<span class="token punctuation">)</span>

    <span class="token comment"># respond_to 是一个方法，其参数为一个 block</span>
    <span class="token comment"># 我现在的理解是 respond_to 描述的是服务器对于客户端的反应，或者说，这是浏览器上将执行的步骤</span>
    <span class="token comment"># 这里就是先对于 html 进行一个重定向操作，然后调用 js，最后 json</span>
    respond_to <span class="token keyword">do</span> <span class="token operator">|</span>format<span class="token operator">|</span>
      <span class="token keyword">if</span> <span class="token variable">@line_item</span><span class="token punctuation">.</span>save
        <span class="token comment"># 跳转的对象不再是 @line_item，而是 store 页面</span>
        format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> redirect_to store_index_url <span class="token punctuation">}</span>
        <span class="token comment"># 调用 js 脚本</span>
        format<span class="token punctuation">.</span>js
        format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render <span class="token symbol">:show</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:created</span><span class="token punctuation">,</span> location<span class="token punctuation">:</span> <span class="token variable">@line_item</span> <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> render <span class="token symbol">:new</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
        format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render json<span class="token punctuation">:</span> <span class="token variable">@line_item</span><span class="token punctuation">.</span>errors<span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后就会调用 <code>views/line_items/create.js.erb</code> 这个文件，将这个文件写入以下内容</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token string">"&lt;%= j render(@cart) %&gt;"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个脚本描述了将 <code>id = cart</code> 的节点替换成 <code>render(@cart)</code> 的操作。</p>
<h3 id="2-9-突出显示"><a href="#2-9-突出显示" class="headerlink" title="2.9 突出显示"></a>2.9 突出显示</h3><p>为了增强美工性，考虑引入 <code>jQuery-ui</code>。</p>
<p><code>jQuery</code> 是 <code>JavaScript</code> 的一个好用的库，里面有常见的 html 操作和一组简单的 UI，我们需要更改 <code>Gemfile</code> 来安装它</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># Use jquery as the JavaScript library</span>
gem <span class="token string">'jquery-rails'</span>
gem <span class="token string">'jquery-ui-rails'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后执行</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bundle <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后新建 <code>app/assets/javascripts/application.js</code> 内容为</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//= require jquery</span>
<span class="token comment">//= require jquery_ujs</span>
<span class="token comment">//= require jquery-ui/effect.all</span>
<span class="token comment">//= require_tree .</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>至于为啥是这个，并不知道为啥。这样之后我们就可以使用 <code>jquery-ui</code> 了。</p>
<p>然后考虑如何对“刚刚点击过”的 <code>LineItem</code> 做一个突出显示，可以考虑在 <code>create</code> 中维护一个 <code>@current_item</code></p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">format<span class="token punctuation">.</span>js <span class="token punctuation">{</span> <span class="token variable">@current_item</span> <span class="token operator">=</span> <span class="token variable">@line_item</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后在 <code>_line_item.html.erb</code> 中，将 <code>current</code> 标出来</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;% if line_item == @current_item %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>current_item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
&lt;% else %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
&lt;% end %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>&lt;%= line_item.quantity %&gt; <span class="token entity named-entity" title="×">&amp;times;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>&lt;%= line_item.product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item_price<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= number_to_currency(line_item.total_price) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在 <code>create.js.erb</code> 中进行渲染</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#current_item'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'background-color'</span><span class="token operator">:</span> <span class="token string">'#88ff88'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                  <span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'background-color'</span><span class="token operator">:</span> <span class="token string">'#114411'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="2-10-辅助方法"><a href="#2-10-辅助方法" class="headerlink" title="2.10 辅助方法"></a>2.10 辅助方法</h3><p>我们希望可以在购物车内商品数量为 0 的时候，不显示购物车。</p>
<p>可以利用购物车长度作为判断，这里我们用到了辅助方法（主要是为了让代码更加整洁）</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 购物车 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cart<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  &lt;% if @cart %&gt;
    &lt;%= hidden_div_if(@cart.line_items.empty?, id: 'cart') do %&gt;
      &lt;%= render @cart %&gt;
    &lt;% end %&gt;
  &lt;% end %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>辅助方法为在 <code>app/helpers</code> 下的方法，脚手架会自动帮我们建好这些文件。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">module</span> <span class="token constant">ApplicationHelper</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">hidden_div_if</span></span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> attributes<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>block<span class="token punctuation">)</span>
    <span class="token comment"># 将 html 中具有 attributes 并满足 condition 条件的 div 设置为 display: none</span>
    <span class="token keyword">if</span> condition
      attributes<span class="token punctuation">[</span><span class="token string">"style"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"display: none"</span>
    <span class="token keyword">end</span>
    content_tag<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>block<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时我们需要修改 js 文件，使得购物车显示的时候比较平滑</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#cart tr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">'blind'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<h2 id="3-订单-Order"><a href="#3-订单-Order" class="headerlink" title="3 订单 Order"></a>3 订单 Order</h2><h3 id="3-1-Order-模型"><a href="#3-1-Order-模型" class="headerlink" title="3.1 Order 模型"></a>3.1 Order 模型</h3><p>订单模型本质上信息全都是收货的信息，订单具体有什么商品，其实并不是由 Order 决定的，而是由 LineItem 决定的。因此建立如下如下模型</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate scaffold Order name address:text email phone pay_type:integer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同时给 <code>LineItem</code> 添加外键</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate migration add_order_to_line_item order:references <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后融合迁移</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后就会发现融合不了，这是因为对于 LineItem，他有三个外键，分别是 <code>Product, Cart, Order</code> ，在迁移中自动生成的外键，都是不允许为空的，而现在，对于一个 <code>LineItem</code> ，它要么在 <code>Cart</code> 中，要么在 <code>Order</code> 中，所以总会有一个外键为空，所以需要修改多处地方。</p>
<p>首先要修改 <code>LineItem</code> 的两个 migration</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># 20230101081559_create_line_items.rb</span>
<span class="token keyword">class</span> <span class="token class-name">CreateLineItems</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">7.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    create_table <span class="token symbol">:line_items</span> <span class="token keyword">do</span> <span class="token operator">|</span>t<span class="token operator">|</span>
      t<span class="token punctuation">.</span>references <span class="token symbol">:product</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> foreign_key<span class="token punctuation">:</span> <span class="token boolean">true</span>
      t<span class="token punctuation">.</span>belongs_to <span class="token symbol">:cart</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> foreign_key<span class="token punctuation">:</span> <span class="token boolean">true</span>

      t<span class="token punctuation">.</span>timestamps
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment"># 20230102121647_add_order_to_line_item.rb</span>
<span class="token keyword">class</span> <span class="token class-name">AddOrderToLineItem</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">7.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_reference <span class="token symbol">:line_items</span><span class="token punctuation">,</span> <span class="token symbol">:order</span><span class="token punctuation">,</span> null<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span> foreign_key<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 然后还要在 <code>model</code> 中进行数据关系的定义</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">LineItem</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  belongs_to <span class="token symbol">:product</span>
  <span class="token comment"># optional 表示外键可以为空</span>
  belongs_to <span class="token symbol">:cart</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token boolean">true</span>
  belongs_to <span class="token symbol">:order</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token boolean">true</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">total_price</span></span>
    product<span class="token punctuation">.</span>price <span class="token operator">*</span> quantity
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  enum pay_type<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"Check"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"Credit card"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"Purchase order"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>

  has_many <span class="token symbol">:line_items</span><span class="token punctuation">,</span> dependent<span class="token punctuation">:</span> <span class="token symbol">:destroy</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-2-生成订单"><a href="#3-2-生成订单" class="headerlink" title="3.2 生成订单"></a>3.2 生成订单</h3><p>生成订单的过程是一个将购物车中所有的 <code>LineItem</code> 都放到 <code>Order</code> 中的一个过程，我们可以用一个方法描述这个过程，定义在 <code>model</code> 中。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  enum pay_type<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"Check"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"Credit card"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"Purchase order"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>

  has_many <span class="token symbol">:line_items</span><span class="token punctuation">,</span> dependent<span class="token punctuation">:</span> <span class="token symbol">:destroy</span>

  validates <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:address</span><span class="token punctuation">,</span> <span class="token symbol">:email</span><span class="token punctuation">,</span> <span class="token symbol">:phone</span><span class="token punctuation">,</span> presence<span class="token punctuation">:</span> <span class="token boolean">true</span>
  validates <span class="token symbol">:pay_type</span><span class="token punctuation">,</span> inclusion<span class="token punctuation">:</span> pay_types<span class="token punctuation">.</span>keys

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">add_line_items_from_cart</span></span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span>
    cart<span class="token punctuation">.</span>line_items<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>item<span class="token operator">|</span>
      item<span class="token punctuation">.</span>cart_id <span class="token operator">=</span> <span class="token keyword">nil</span>
      line_items <span class="token operator">&lt;</span><span class="token operator">&lt;</span> item
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到还新增了一些字段的验证约束，然后考虑生成表格，首先在 <code>_cart.html.erb</code> 加上生成 <code>Order</code> 的按钮</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 结算购物车 --&gt;</span>
&lt;%= button_to 'Checkout', new_order_path, method: :get %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个方法会调用 <code>new</code> 方法，所以我们需要写一下 <code>new.html.erb</code> 这个模板</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>project_form<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Please Enter Your Details<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    &lt;%= render 'form', order: @order %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有与之相关的 <code>_form.html.erb</code></p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;%= form_with(model: order) do |form| %&gt;
  &lt;% if order.errors.any? %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>&lt;%= pluralize(order.errors.count, "error") %&gt; prohibited this order from being saved:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        &lt;% order.errors.each do |error| %&gt;
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= error.full_message %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        &lt;% end %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :name, style: "display: block" %&gt;
    &lt;%= form.text_field :name, size: 40 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :address, style: "display: block" %&gt;
    &lt;%= form.text_area :address, rows: 3, cols: 37 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :email, style: "display: block" %&gt;
    &lt;%= form.text_field :email, size: 40 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :phone, style: "display: block" %&gt;
    &lt;%= form.text_field :phone, size: 40 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :pay_type, style: "display: block" %&gt;
    &lt;%= form.select :pay_type, Order.pay_types.keys, prompt: 'Select a payment method' %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>actions<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.submit 'Place Order'%&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
&lt;% end %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并且美化样式</p>
<pre class="line-numbers language-scss" data-language="scss"><code class="language-scss"><span class="token selector">.project_form </span><span class="token punctuation">{</span>
  <span class="token selector">fieldset </span><span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> #efe<span class="token punctuation">;</span>

    <span class="token selector">h2 </span><span class="token punctuation">{</span>
      <span class="token property">color</span><span class="token punctuation">:</span> #dfd<span class="token punctuation">;</span>
      <span class="token property">background</span><span class="token punctuation">:</span> #141<span class="token punctuation">;</span>
      <span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span>
      <span class="token property">padding</span><span class="token punctuation">:</span> 0.2em 1em<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">div </span><span class="token punctuation">{</span>
      <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0.3em<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token selector">form </span><span class="token punctuation">{</span>
    <span class="token selector">label </span><span class="token punctuation">{</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 5em<span class="token punctuation">;</span>
      <span class="token property">float</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
      <span class="token property">text-align</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span>
      <span class="token property">padding-top</span><span class="token punctuation">:</span> 0.2em<span class="token punctuation">;</span>
      <span class="token property">margin-right</span><span class="token punctuation">:</span> 0.1em<span class="token punctuation">;</span>
      <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">select, textarea, input </span><span class="token punctuation">{</span>
      <span class="token property">margin-left</span><span class="token punctuation">:</span> 0.5em<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">.submit </span><span class="token punctuation">{</span>
      <span class="token property">margin-left</span><span class="token punctuation">:</span> 4em<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">br </span><span class="token punctuation">{</span>
      <span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 <code>Order#create</code> 的过程中，需要清空购物车，所以需要修改一下 <code>create</code> 方法</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># POST /orders or /orders.json</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span>
    <span class="token variable">@order</span> <span class="token operator">=</span> <span class="token constant">Order</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>order_params<span class="token punctuation">)</span>
    <span class="token variable">@order</span><span class="token punctuation">.</span>add_line_items_from_cart<span class="token punctuation">(</span><span class="token variable">@cart</span><span class="token punctuation">)</span>

    respond_to <span class="token keyword">do</span> <span class="token operator">|</span>format<span class="token operator">|</span>
      <span class="token keyword">if</span> <span class="token variable">@order</span><span class="token punctuation">.</span>save
        <span class="token comment"># 清空购物车</span>
        <span class="token constant">Cart</span><span class="token punctuation">.</span>destroy<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token symbol">:cart_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        session<span class="token punctuation">[</span><span class="token symbol">:cart_id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>
        
        format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> redirect_to store_index_url<span class="token punctuation">(</span><span class="token variable">@order</span><span class="token punctuation">)</span><span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">"Thank you for your order."</span> <span class="token punctuation">}</span>
        format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render <span class="token symbol">:show</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:created</span><span class="token punctuation">,</span> location<span class="token punctuation">:</span> <span class="token variable">@order</span> <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
        format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> render <span class="token symbol">:new</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
        format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render json<span class="token punctuation">:</span> <span class="token variable">@order</span><span class="token punctuation">.</span>errors<span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-订单展示"><a href="#3-3-订单展示" class="headerlink" title="3.3 订单展示"></a>3.3 订单展示</h3><p>作为管理端，需要看到所有的订单，所以考虑修改 <code>index.html.erb</code> 这个模板，将其改成表格形式会更漂亮一些，同时加上一些操作和跳转。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;%= form_with(model: order) do |form| %&gt;
  &lt;% if order.errors.any? %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>&lt;%= pluralize(order.errors.count, "error") %&gt; prohibited this order from being saved:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        &lt;% order.errors.each do |error| %&gt;
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= error.full_message %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        &lt;% end %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :name, style: "display: block" %&gt;
    &lt;%= form.text_field :name, size: 40 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :address, style: "display: block" %&gt;
    &lt;%= form.text_area :address, rows: 3, cols: 37 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :email, style: "display: block" %&gt;
    &lt;%= form.text_field :email, size: 40 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :phone, style: "display: block" %&gt;
    &lt;%= form.text_field :phone, size: 40 %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.label :pay_type, style: "display: block" %&gt;
    &lt;%= form.select :pay_type, Order.pay_types.keys, prompt: 'Select a payment method' %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>actions<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    &lt;%= form.submit 'Place Order'%&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
&lt;% end %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于订单的详情展示，可以仿照 <code>_cart.html.erb</code> 书写</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>
  &lt;%= render(order.line_items) %&gt;
  <span class="token comment">&lt;!-- 总金额 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total_line<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">colspan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Total<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total_cell<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= number_to_currency(order.total_price) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="4-用户-User"><a href="#4-用户-User" class="headerlink" title="4 用户 User"></a>4 用户 User</h2><h3 id="4-1-User-模型"><a href="#4-1-User-模型" class="headerlink" title="4.1 User 模型"></a>4.1 User 模型</h3><p>考虑用户具有用户名，密码，角色三个属性，模型如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate scaffold User name:string password:digest role:integer
rails db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于密码部分，可以借助插件完成“确认密码的功能”</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  has_secure_password
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>同时在 <code>gemfile</code> 中填入这个插件</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># Use Active Model has_secure_password [https://guides.rubyonrails.org/active_model_basics.html#securepassword]</span>
gem <span class="token string">"bcrypt"</span><span class="token punctuation">,</span> <span class="token string">"~&gt; 3.1.7"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后使用 </p>
<pre class="line-numbers language-none"><code class="language-none">bundle install<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同时还有关于 <code>role</code> 的设计，目前有两个角色，一个是 <code>Buyer</code>，一个是 <code>Admin</code>，其中 <code>Admin</code> 的权限更高。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  enum role<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"Buyer"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"Admin"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>

  validates <span class="token symbol">:name</span><span class="token punctuation">,</span> presence<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> uniqueness<span class="token punctuation">:</span> <span class="token boolean">true</span>
  validates <span class="token symbol">:role</span><span class="token punctuation">,</span> presence<span class="token punctuation">:</span> <span class="token boolean">true</span>
  validates <span class="token symbol">:role</span><span class="token punctuation">,</span> inclusion<span class="token punctuation">:</span> roles<span class="token punctuation">.</span>keys
  
  has_secure_password
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意如果希望 <code>role</code> 作为一个枚举变量，那么这里一定要定义 <code>enum</code> 的名字为 <code>role</code>，不能叫 <code>role_type</code> 或者其他任何的名字，都不会让其具有枚举的效果，这大概就是神秘的 rails 吧。</p>
<h3 id="4-2-控制器与页面"><a href="#4-2-控制器与页面" class="headerlink" title="4.2 控制器与页面"></a>4.2 控制器与页面</h3><p>身份验证就是登录相关的功能，这里需要新建两个控制器，<code>sessions</code> 用于为登录和登出提供支持，<code>admin</code> 用于为管理员提供欢迎界面。</p>
<p>其中 <code>sessions</code> 只有两个动作，<code>new, create</code> 对应登入，<code>destroy</code> 对应登出</p>
<pre class="line-numbers language-none"><code class="language-none">rails generate controller Sessions new create destroy <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>Admin</code> 只有一个动作 <code>index</code>，代表欢迎界面。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate controller Admin index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这也启发我，其实写一个页面就是写一个 controller 和一个 view 而已，这是因为 view 似乎没有办法单独成为一个路由资源。</p>
<h3 id="4-3-登录登出"><a href="#4-3-登录登出" class="headerlink" title="4.3 登录登出"></a>4.3 登录登出</h3><p>登入功能就是填一个表单，所以在 <code>new.html.erb</code> 中写入</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>project_form<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  &lt;% if flash[:alert] %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>notice<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>&lt;%= flash[:alert] %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;

  &lt;%= form_tag do %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>legend</span><span class="token punctuation">&gt;</span></span>Please Log In<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>legend</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        &lt;%= label_tag :name, 'Name:' %&gt;
        &lt;%=text_field_tag :name, params[:name] %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        &lt;%= label_tag :password, 'Password:' %&gt;
        &lt;%= password_field_tag :password, params[:password] %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        &lt;%= submit_tag 'Login' %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt; %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，因为 <code>Sessions</code> 并没有与模型关联，所以我们并没有用 <code>form_for</code> ，只是一个普通的 <code>form_tag</code>。收集的信息进入了 <code>params</code>。</p>
<p>然后我们在 <code>create</code> 中利用 <code>params</code> 中的信息保存到 <code>session</code> 中</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span>
  <span class="token comment"># 这里更加明显，create 会有一个 params，params 的来历就是 new 填的表单</span>
  user <span class="token operator">=</span> <span class="token constant">User</span><span class="token punctuation">.</span>find_by<span class="token punctuation">(</span>name<span class="token punctuation">:</span> params<span class="token punctuation">[</span><span class="token symbol">:name</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment"># try 对于为 nil 的 user，会直接进入 else</span>
  <span class="token keyword">if</span> user<span class="token punctuation">.</span>try<span class="token punctuation">(</span><span class="token symbol">:authenticate</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token symbol">:password</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    session<span class="token punctuation">[</span><span class="token symbol">:user_id</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>id
    session<span class="token punctuation">[</span><span class="token symbol">:user_role</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>role
    <span class="token comment"># 如果是 Buyer ，就定向到商店，否则定向到 admin 的欢迎界面</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>role <span class="token operator">==</span> <span class="token string">"Buyer"</span>
      redirect_to store_index_url
    <span class="token keyword">else</span>
      redirect_to admin_url
    <span class="token keyword">end</span>
  <span class="token keyword">else</span>
    redirect_to login_url<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">"Invalid user/password combination"</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时完成相应界面的跳转，我们在 <code>session</code> 中保存了用户的 <code>id</code> 和权限信息。</p>
<p>退出登录的状态就很简单，就是将 session 中的信息注销掉即可</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">destroy</span></span>
  session<span class="token punctuation">[</span><span class="token symbol">:user_id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>
  session<span class="token punctuation">[</span><span class="token symbol">:user_role</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nil</span>
  redirect_to store_index_url<span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">"Logged out"</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于管理界面，可以自己设计一个</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Welcome<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  It's &lt;%= Time.now %&gt;
  We hava &lt;%= pluralize(@total_orders, 'order') %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后需要修改路由</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">get <span class="token string">'admin'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'admin#index'</span>

controller <span class="token symbol">:sessions</span> <span class="token keyword">do</span>
  get <span class="token string">'login'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token symbol">:new</span>
  post <span class="token string">'login'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token symbol">:create</span>
  delete <span class="token string">'logout'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token symbol">:destroy</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-4-访问限制"><a href="#4-4-访问限制" class="headerlink" title="4.4 访问限制"></a>4.4 访问限制</h3><p>访问限制可以在 <code>application_controller.rb</code> 中利用 <code>before_action</code> 实现</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">ApplicationController</span> <span class="token operator">&lt;</span> <span class="token constant">ActionController</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Base</span>
  before_action <span class="token symbol">:authorize</span>

  <span class="token keyword">protected</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">authorize</span></span>
    <span class="token keyword">unless</span> <span class="token constant">User</span><span class="token punctuation">.</span>find_by<span class="token punctuation">(</span>id<span class="token punctuation">:</span> session<span class="token punctuation">[</span><span class="token symbol">:user_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      redirect_to login_url<span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">"Pleas log in."</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在各个控制器，选择是否跳过 <code>authorize</code> 即可</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">SessionsController</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  skip_before_action <span class="token symbol">:authorize</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这时会发现所有的 test 基本上都瘫痪了，这是因为 test 不会自动登录，所有在 <code>test/test_helper.rb</code> 中写入如下代码即可</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">"RAILS_ENV"</span><span class="token punctuation">]</span> <span class="token operator">||</span><span class="token operator">=</span> <span class="token string">"test"</span>
require_relative <span class="token string">"../config/environment"</span>
<span class="token keyword">require</span> <span class="token string">"rails/test_help"</span>
<span class="token keyword">class</span> <span class="token class-name">ActionDispatch</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">IntegrationTest</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">login_as</span></span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    post login_url<span class="token punctuation">,</span> params<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token string">'secret'</span><span class="token punctuation">}</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">logout</span></span>
    delete logout_url
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">setup</span></span>
    login_as<span class="token punctuation">(</span>users<span class="token punctuation">(</span><span class="token symbol">:one</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">ActiveSupport</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">TestCase</span>
  <span class="token comment"># Run tests in parallel with specified workers</span>
  parallelize<span class="token punctuation">(</span>workers<span class="token punctuation">:</span> <span class="token symbol">:number_of_processors</span><span class="token punctuation">)</span>

  <span class="token comment"># Setup all fixtures in test/fixtures/*.yml for all tests in alphabetical order.</span>
  fixtures <span class="token symbol">:all</span>

  <span class="token comment"># Add more helper methods to be used by all tests here...</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-5-权限显示"><a href="#4-5-权限显示" class="headerlink" title="4.5 权限显示"></a>4.5 权限显示</h3><p>我们希望对于管理者，可以看到更多的界面，而对于非管理者，则不需要看到这些界面</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 管理链接 --&gt;</span>
   &lt;% if current_user and current_user.role == 'Admin' %&gt;
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= link_to 'Orders', orders_path %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= link_to 'Products', products_path %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= link_to 'Users', users_path %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
   &lt;% end %&gt;
   <span class="token comment">&lt;!-- 登录登出 --&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>log<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
     &lt;% if current_user %&gt;
       &lt;%= current_user.name %&gt; Logged in.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
       &lt;%= link_to 'Logout', logout_path, method: :delete %&gt;
     &lt;% else %&gt;
       Please &lt;%= link_to 'Login', login_url %&gt;
     &lt;% end %&gt;
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些需要借助 <code>current_user</code> 这个方法，这个方法定义在 <code>application_controller.rb</code> 中</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">helper_method <span class="token symbol">:current_user</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">current_user</span></span>
  <span class="token variable">@current_user</span> <span class="token operator">||</span><span class="token operator">=</span> <span class="token constant">User</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token symbol">:user_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token symbol">:user_id</span><span class="token punctuation">]</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="5-收藏夹-Favourite"><a href="#5-收藏夹-Favourite" class="headerlink" title="5 收藏夹 Favourite"></a>5 收藏夹 Favourite</h2><h3 id="5-1-Favourite-模型"><a href="#5-1-Favourite-模型" class="headerlink" title="5.1 Favourite 模型"></a>5.1 Favourite 模型</h3><p>每个用户都有一个收藏夹，二者是一对一关系，所以没有必要单独做一个实体，可以直接使用 <code>User</code> 模型。但是在实际思考的时候，却应当有收藏夹这个模型，比较方便思考。</p>
<h3 id="5-2-FavorItem-收藏品模型"><a href="#5-2-FavorItem-收藏品模型" class="headerlink" title="5.2 FavorItem 收藏品模型"></a>5.2 FavorItem 收藏品模型</h3><p>收藏品模型描述的是 <code>Product</code> 和 <code>Favourite</code> 之间的“多对多关系”，所以需要这样建立模型</p>
<pre class="line-numbers language-none"><code class="language-none">rails generate scaffold FavorItem product:references user:belongs_to
rake db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于 <code>User</code> 模型，补充如下代码，也就是当 User 持有一个 <code>favor_items</code> 集合，同时当 <code>User</code> 销毁的时候，会销毁所有的 <code>favor_items</code> 。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">has_many <span class="token symbol">:favor_items</span><span class="token punctuation">,</span> dependent<span class="token punctuation">:</span> <span class="token symbol">:destroy</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对于 <code>Product</code> 模型，补充如下代码，同样 <code>Product</code> 持有一个 <code>favor_item</code> 集合，同时在销毁前要检验是否可以销毁。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">has_many <span class="token symbol">:favor_items</span>
before_destroy <span class="token symbol">:ensure_not_referenced_by_any_favor_item</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">ensure_not_referenced_by_any_favor_item</span></span>
  <span class="token keyword">unless</span> favor_items<span class="token punctuation">.</span>empty<span class="token operator">?</span>
    errors<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token symbol">:base</span><span class="token punctuation">,</span> <span class="token string">'Line Items present'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token symbol">:abort</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-3-加入收藏夹"><a href="#5-3-加入收藏夹" class="headerlink" title="5.3 加入收藏夹"></a>5.3 加入收藏夹</h3><p>在 <code>store</code> 界面上，除了有“加入购物车”之外，应当有“加入收藏夹”的功能，可以如此修改 <code>store</code> 界面</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 加入收藏夹 --&gt;</span>
&lt;%= button_to 'Add to Favourite', favor_items_path(product_id: product) %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以看到需要修改 <code>favor_item</code> 的 <code>create</code> 方法</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span>
  <span class="token comment"># 根据传入的 product_id 查找 product</span>
  product <span class="token operator">=</span> <span class="token constant">Product</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:product_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token variable">@favor_item</span> <span class="token operator">=</span> <span class="token variable">@user</span><span class="token punctuation">.</span>add_product<span class="token punctuation">(</span>product<span class="token punctuation">)</span>

  respond_to <span class="token keyword">do</span> <span class="token operator">|</span>format<span class="token operator">|</span>
    <span class="token keyword">if</span> <span class="token variable">@favor_item</span><span class="token punctuation">.</span>save
      format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> redirect_to store_index_url <span class="token punctuation">}</span>
      format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render <span class="token symbol">:show</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:created</span><span class="token punctuation">,</span> location<span class="token punctuation">:</span> <span class="token variable">@favor_item</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
      format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> render <span class="token symbol">:new</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
      format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render json<span class="token punctuation">:</span> <span class="token variable">@favor_item</span><span class="token punctuation">.</span>errors<span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到需要获得一个收藏夹的 <code>@user</code>，与 <code>@cart</code> 类似，所以需要一个 <code>set_user</code> 的过程</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">set_user</span></span>
  <span class="token variable">@user</span> <span class="token operator">=</span> <span class="token constant">User</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token symbol">:user_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">rescue</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">RecordNotFound</span>
  redirect_to store_index_url
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-4-收藏夹展示"><a href="#5-4-收藏夹展示" class="headerlink" title="5.4 收藏夹展示"></a>5.4 收藏夹展示</h3><p>类似于一个产品目录的子集，可以写 <code>index.html.erb</code> </p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> green</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>&lt;%= notice %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Favourite Collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>favor_items<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>
  &lt;% @favor_items.each do |favor_item| %&gt;
    &lt;%= render favor_item %&gt;
  &lt;% end %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到除了外面套了一个表之外，主体是对于每个 <code>favor_item</code> 的渲染，所以需要修改 <code>_favor_item.html.erb</code> </p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%= cycle(<span class="token punctuation">'</span>list_line_odd<span class="token punctuation">'</span>, <span class="token punctuation">'</span>list_line_even<span class="token punctuation">'</span>) %&gt;<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
    &lt;%= image_tag(favor_item.product.image_url, class: 'list_image') %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list_description<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>&lt;%= favor_item.product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span>&lt;%= strip_tags(favor_item.product.description) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">&gt;</span></span>
      &lt;%= number_to_currency(favor_item.product.price) %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">&gt;</span></span>
      &lt;%= button_to 'Add to Cart', line_items_path(product_id: favor_item.product), remote:true %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">&gt;</span></span>
      &lt;%= button_to 'Remove', favor_item, :method =&gt; :delete %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="6-促销活动-Activity"><a href="#6-促销活动-Activity" class="headerlink" title="6 促销活动 Activity"></a>6 促销活动 Activity</h2><h3 id="6-1-Activity-模型"><a href="#6-1-Activity-模型" class="headerlink" title="6.1 Activity 模型"></a>6.1 Activity 模型</h3><p>促销活动只有一个属性就是名字，具体的促销也在这里体现体现，所以应当在终端中输入如下示例</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate scaffold Activity name:string disconut:integer
rake db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="6-2-Prompt-促销项模型"><a href="#6-2-Prompt-促销项模型" class="headerlink" title="6.2 Prompt 促销项模型"></a>6.2 Prompt 促销项模型</h3><p>促销项都是外键，用于关联 <code>Product</code> 产品和 <code>Activity</code> 活动，形成“活动-产品” 的多对多关系。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rails generate scaffold Prompt  product:references activity:belongs_to
rake db:migrate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>同时完善 <code>Product</code> 模型</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">has_many <span class="token symbol">:prompts</span><span class="token punctuation">,</span> dependent<span class="token punctuation">:</span> <span class="token symbol">:destroy</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>和 <code>Activity</code> 模型</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">has_many <span class="token symbol">:prompts</span><span class="token punctuation">,</span> dependent<span class="token punctuation">:</span> <span class="token symbol">:destroy</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="6-3-新建活动"><a href="#6-3-新建活动" class="headerlink" title="6.3 新建活动"></a>6.3 新建活动</h3><p>一个活动由本身和它包括的商品组成，在创建的时候，可以先创建好活动，确定活动的名称和折扣力度，然后再向这个活动添加涉及的商品。创建活动这个操作只有管理员可以干，所以我们用一个管理链接指向 <code>activities</code> 的展示页面</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>&lt;%= link_to 'Prompt', activities_path %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后对于这个页面，我们只是展示其名称和折扣</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> green</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>&lt;%= notice %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Activities<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>activities<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  &lt;% @activities.each do |activity| %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
      Name:
      &lt;%= activity.name %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spac</span><span class="token punctuation">&gt;</span></span>
      Discount:
      &lt;%= number_to_percentage(activity.discount, precision: 0) %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spac</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
      &lt;%= link_to "Show this activity", activity %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

&lt;%= link_to "New activity", new_activity_path %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在活动中添加商品的操作，可以考虑在具体的活动界面进行添加，也就是 <code>_activity.html.erb</code> 中添加</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%= dom_id activity %&gt;<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 活动的基本信息 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>Name:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>
    &lt;%= activity.name %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>Discount:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>
    &lt;%= number_to_percentage(activity.discount, precision: 0) %&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- 这里展示了产品列表，可以将产品添加到活动中 --&gt;</span>
  &lt;% Product.all.each do |product| %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>entry<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>&lt;%= product.title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>price_line<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!-- 加入活动 --&gt;</span>
          &lt;%= button_to 'Add to Activity', prompts_path(product_id: product, activity_id: activity)%&gt;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;
  
  <span class="token comment">&lt;!-- 已经加入活动的产品 --&gt;</span>
  &lt;% activity.prompts.each do |prompt| %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      &lt;%= prompt.product.title %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于创建一个 <code>prompt</code>，与以往不同，需要传入两个参数，也就是 <code>prompt</code> 的两端 <code>product</code> 和 <code>activity</code>，也就是这样</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 加入活动 --&gt;</span>
&lt;%= button_to 'Add to Activity', prompts_path(product_id: product, activity_id: activity)%&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>所以需要修改 <code>prompt</code> 的 <code>create</code> 方法</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># POST /prompts or /prompts.json</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span>
  <span class="token comment"># 根据传入的 product_id 查找 product</span>
  product <span class="token operator">=</span> <span class="token constant">Product</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:product_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  activity <span class="token operator">=</span> <span class="token constant">Activity</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:activity_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token variable">@prompt</span> <span class="token operator">=</span> activity<span class="token punctuation">.</span>add_product<span class="token punctuation">(</span>product<span class="token punctuation">)</span>

  respond_to <span class="token keyword">do</span> <span class="token operator">|</span>format<span class="token operator">|</span>
    <span class="token keyword">if</span> <span class="token variable">@prompt</span><span class="token punctuation">.</span>save
      format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> redirect_to activity_url<span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">"Prompt was successfully created."</span> <span class="token punctuation">}</span>
      format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render <span class="token symbol">:show</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:created</span><span class="token punctuation">,</span> location<span class="token punctuation">:</span> <span class="token variable">@prompt</span> <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
      format<span class="token punctuation">.</span>html <span class="token punctuation">{</span> render <span class="token symbol">:new</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
      format<span class="token punctuation">.</span>json <span class="token punctuation">{</span> render json<span class="token punctuation">:</span> <span class="token variable">@prompt</span><span class="token punctuation">.</span>errors<span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token symbol">:unprocessable_entity</span> <span class="token punctuation">}</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到进行了两次查找，最终利用两次查找的信息建立了 <code>prompt</code>。和 <code>favor_item</code> 的 <code>add_product</code> 一致，对于加入活动的产品，只能加入一次</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">add_product</span></span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>
  <span class="token comment"># 根据 product_id 查找 current_item</span>
  current_item <span class="token operator">=</span> prompts<span class="token punctuation">.</span>find_by<span class="token punctuation">(</span>product<span class="token punctuation">:</span> product<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

  <span class="token keyword">if</span> current_item
    <span class="token comment"># 查找到了，就啥都不干</span>
  <span class="token keyword">else</span>
    <span class="token comment"># 没查找到，就创建 prompt</span>
    current_item <span class="token operator">=</span> prompts<span class="token punctuation">.</span>build<span class="token punctuation">(</span>product_id<span class="token punctuation">:</span> product<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token comment"># 返回 current_item</span>
  current_item
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-4-实现折扣"><a href="#6-4-实现折扣" class="headerlink" title="6.4 实现折扣"></a>6.4 实现折扣</h3><p>促销大概需要两个两个机制</p>
<ul>
<li>在 <code>store</code> 界面上展示折扣</li>
<li>在加入购物车或者订单的时候实际发生折扣</li>
</ul>
<p>展示折扣这个功能很好实现，只需要在 <code>store</code> 界面中利用 <code>product</code> 检索 <code>prompt</code> 进而检索 <code>activity.discount</code> 即可。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 显示折扣 --&gt;</span>
&lt;% product.prompts.each do |prompt| %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span> <span class="token entity named-entity" title="×">&amp;times;</span> &lt;%= number_to_percentage(prompt.activity.discount, precision: 0) %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
&lt;% end %&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里用到了 <code>number_to_percentage</code> 方法，可以将普通整数转换成百分制（除以 100 加百分号）。</p>
<p>发生实际折扣，需要更改 <code>price</code> 的计算方式，原来对于价格的计算，是 <code>Cart</code> 或者 <code>Order</code> 对于其所有的 <code>item</code> 的 <code>price</code> 进行求和，<code>line_item</code> 的价格计算，是 <code>Product.price</code> 和 <code>quantity</code> 的乘积，如下所示</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">total_price</span></span>
  product<span class="token punctuation">.</span>price <span class="token operator">*</span> quantity
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可见，只要修改 <code>price</code> 即可，所以在 <code>product</code> 中新写一个方法去获得折扣价格</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">getDiscountPrice</span></span>
  discount <span class="token operator">=</span> price
  prompts<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>prompt<span class="token operator">|</span>
    discount <span class="token operator">*</span><span class="token operator">=</span> <span class="token punctuation">(</span>prompt<span class="token punctuation">.</span>activity<span class="token punctuation">.</span>discount <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  discount
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后修改 <code>total_price</code> 为</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">total_price</span></span>
  product<span class="token punctuation">.</span>getDiscountPrice <span class="token operator">*</span> quantity
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>即可。</p>
<h3 id="6-5-展示折扣"><a href="#6-5-展示折扣" class="headerlink" title="6.5 展示折扣"></a>6.5 展示折扣</h3><p>对于普通用户来说，没有权限建立活动，但是有权限浏览活动，所以可以实现一个活动界面用于浏览，但是考虑到 <code>index.html.erb</code> 已经用于给管理者新建活动使用了，所以考虑新开设一个界面，在控制器中新定义一个方法</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">show_activity</span></span>
  <span class="token variable">@show_activities</span> <span class="token operator">=</span> <span class="token constant">Activity</span><span class="token punctuation">.</span>all
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后建立对应的 <code>show_activity.html.erb</code> 这个页面，其内容如下</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>show_activities<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>促销活动<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  &lt;% @show_activities.each do |activity| %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>entry<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        &lt;%= activity.name %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>discount<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        折扣力度：
        &lt;%= number_to_percentage(activity.discount, precision: 0) %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>items<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        促销产品：
        &lt;% activity.prompts.each do |prompt| %&gt;
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>product<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>&lt;%= prompt.product.title %&gt;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        &lt;% end %&gt;
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  &lt;% end %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其后完善链接即可。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%9B%B4%E8%A7%82%E7%90%86%E8%A7%A3/" rel="tag"><i class="fa fa-tag"></i> 直观理解</a>
              <a href="/tags/S5%E8%AF%BE%E4%B8%8A/" rel="tag"><i class="fa fa-tag"></i> S5课上</a>
              <a href="/tags/Ruby%E8%AE%BE%E8%AE%A1/" rel="tag"><i class="fa fa-tag"></i> Ruby设计</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/435a8f41/" rel="prev" title="Ruby设计-功能演示">
      <i class="fa fa-chevron-left"></i> Ruby设计-功能演示
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/fe0a8753/" rel="next" title="DBMS-设计报告">
      DBMS-设计报告 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
<script src="https://utteranc.es/client.js"
        repo="Thysrael/blog-comment"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Log"><span class="nav-text">Log</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BA%A7%E5%93%81-Product"><span class="nav-text">1 产品 Product</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%88%9B%E5%BB%BA-Product"><span class="nav-text">1.1 创建 Product</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">1.2 本地服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E8%A1%A8%E5%8D%95"><span class="nav-text">1.3 表单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-seeds"><span class="nav-text">1.4 seeds</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-SCSS"><span class="nav-text">1.5 SCSS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-%E9%AA%8C%E8%AF%81"><span class="nav-text">1.6 验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-%E8%B7%AF%E7%94%B1%E8%AE%BE%E7%BD%AE"><span class="nav-text">1.7 路由设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-8-%E7%BE%8E%E5%8C%96%E5%95%86%E5%93%81%E7%9B%AE%E5%BD%95"><span class="nav-text">1.8 美化商品目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-9-%E9%A1%B5%E9%9D%A2%E5%B8%83%E5%B1%80"><span class="nav-text">1.9 页面布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%B4%AD%E7%89%A9%E8%BD%A6-Cart"><span class="nav-text">2 购物车 Cart</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Cart-%E6%A8%A1%E5%9E%8B"><span class="nav-text">2.1 Cart 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-LineItem-%E5%95%86%E5%93%81%E6%A8%A1%E5%9E%8B"><span class="nav-text">2.2 LineItem 商品模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E4%BC%9A%E8%AF%9D"><span class="nav-text">2.3 会话</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E2%80%9C%E5%8A%A0%E5%85%A5%E8%B4%AD%E7%89%A9%E8%BD%A6%E2%80%9D"><span class="nav-text">2.4 “加入购物车”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E5%8A%A0%E5%85%A5%E6%95%B0%E9%87%8F"><span class="nav-text">2.5 加入数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-%E6%B8%85%E7%A9%BA%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="nav-text">2.6 清空购物车</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-%E5%B1%80%E9%83%A8%E6%B8%B2%E6%9F%93"><span class="nav-text">2.7 局部渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-8-Ajax-%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="nav-text">2.8 Ajax 购物车</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-%E7%AA%81%E5%87%BA%E6%98%BE%E7%A4%BA"><span class="nav-text">2.9 突出显示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-10-%E8%BE%85%E5%8A%A9%E6%96%B9%E6%B3%95"><span class="nav-text">2.10 辅助方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%AE%A2%E5%8D%95-Order"><span class="nav-text">3 订单 Order</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Order-%E6%A8%A1%E5%9E%8B"><span class="nav-text">3.1 Order 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E7%94%9F%E6%88%90%E8%AE%A2%E5%8D%95"><span class="nav-text">3.2 生成订单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E8%AE%A2%E5%8D%95%E5%B1%95%E7%A4%BA"><span class="nav-text">3.3 订单展示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%94%A8%E6%88%B7-User"><span class="nav-text">4 用户 User</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-User-%E6%A8%A1%E5%9E%8B"><span class="nav-text">4.1 User 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%8E%E9%A1%B5%E9%9D%A2"><span class="nav-text">4.2 控制器与页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E7%99%BB%E5%BD%95%E7%99%BB%E5%87%BA"><span class="nav-text">4.3 登录登出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6"><span class="nav-text">4.4 访问限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E6%9D%83%E9%99%90%E6%98%BE%E7%A4%BA"><span class="nav-text">4.5 权限显示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%94%B6%E8%97%8F%E5%A4%B9-Favourite"><span class="nav-text">5 收藏夹 Favourite</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Favourite-%E6%A8%A1%E5%9E%8B"><span class="nav-text">5.1 Favourite 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-FavorItem-%E6%94%B6%E8%97%8F%E5%93%81%E6%A8%A1%E5%9E%8B"><span class="nav-text">5.2 FavorItem 收藏品模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E5%8A%A0%E5%85%A5%E6%94%B6%E8%97%8F%E5%A4%B9"><span class="nav-text">5.3 加入收藏夹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E6%94%B6%E8%97%8F%E5%A4%B9%E5%B1%95%E7%A4%BA"><span class="nav-text">5.4 收藏夹展示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E4%BF%83%E9%94%80%E6%B4%BB%E5%8A%A8-Activity"><span class="nav-text">6 促销活动 Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-Activity-%E6%A8%A1%E5%9E%8B"><span class="nav-text">6.1 Activity 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-Prompt-%E4%BF%83%E9%94%80%E9%A1%B9%E6%A8%A1%E5%9E%8B"><span class="nav-text">6.2 Prompt 促销项模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E6%96%B0%E5%BB%BA%E6%B4%BB%E5%8A%A8"><span class="nav-text">6.3 新建活动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-%E5%AE%9E%E7%8E%B0%E6%8A%98%E6%89%A3"><span class="nav-text">6.4 实现折扣</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-%E5%B1%95%E7%A4%BA%E6%8A%98%E6%89%A3"><span class="nav-text">6.5 展示折扣</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Thysrael"
      src="/images/avatar2.png">
  <p class="site-author-name" itemprop="name">Thysrael</p>
  <div class="site-description" itemprop="description">Can you hear me ?</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">199</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="">
    <a target="_blank" class="social-link" href="/atom.xml" style="color: burlywood;">
      <span class="icon">
        <i class="fa fa-rss"></i>
      </span>
      <span class="label">RSS</span>
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/thysrael" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;thysrael" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:thysrael@163.com" title="E-Mail → mailto:thysrael@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021.12.18 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thysrael</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">20:20</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
