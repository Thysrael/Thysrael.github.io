<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-wall.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-wall.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-jsxllPgZAX">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic|JetBrains Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"thysrael.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="因为笔者鸽了，所以这里的代码就截止到 lab2 了，lab3 和 lab4 的代码在异常处理流那篇文章中有  MOS 源码解读[TOC] boot&#x2F;start.S">
<meta property="og:type" content="article">
<meta property="og:title" content="操作系统-MOS阅读">
<meta property="og:url" content="https://thysrael.github.io/posts/597dbeba/index.html">
<meta property="og:site_name" content="钟鼓楼">
<meta property="og:description" content="因为笔者鸽了，所以这里的代码就截止到 lab2 了，lab3 和 lab4 的代码在异常处理流那篇文章中有  MOS 源码解读[TOC] boot&#x2F;start.S">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/image-20220322172603002.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/VAddr.drawio.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/Index.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/pte.drawio.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/image-20220406211428285.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/list.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/queue.drawio.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/queue.drawio.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/queue.head.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/pmap.drawio.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/2.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/图例.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/allocate.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/kseg0_new.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/image-20220407162822077.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/boot_pgdir_walk.drawio.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/image-20220406211428285.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/tlb.drawio.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/tlb_entry.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/image-20220409154810627.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/image-20220409154846877.png">
<meta property="og:image" content="https://thysrael.github.io/posts/597dbeba/kseg0.drawio.png">
<meta property="article:published_time" content="2022-04-09T11:08:33.000Z">
<meta property="article:modified_time" content="2025-08-15T12:16:48.822Z">
<meta property="article:author" content="Thysrael">
<meta property="article:tag" content="S4课上">
<meta property="article:tag" content="知识总结">
<meta property="article:tag" content="直观理解">
<meta property="article:tag" content="操作系统">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://thysrael.github.io/posts/597dbeba/image-20220322172603002.png">

<link rel="canonical" href="https://thysrael.github.io/posts/597dbeba/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>操作系统-MOS阅读 | 钟鼓楼</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="钟鼓楼" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/thysrael" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">钟鼓楼</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">钟楼瘦，鼓楼胖</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">31</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">69</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">198</span></a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/resource/" rel="section"><i class="fa fa-book fa-fw"></i>Resource</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>Links</a>

  </li>
        <li class="menu-item menu-item-roam">

    <a href="/obsidian-quartz/" rel="section"><i class="fa fa-sitemap fa-fw"></i>Roam</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thysrael.github.io/posts/597dbeba/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.png">
      <meta itemprop="name" content="Thysrael">
      <meta itemprop="description" content="Can you hear me ?">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="钟鼓楼">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          操作系统-MOS阅读
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-09 19:08:33" itemprop="dateCreated datePublished" datetime="2022-04-09T19:08:33+08:00">2022-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-15 20:16:48" itemprop="dateModified" datetime="2025-08-15T20:16:48+08:00">2025-08-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>46k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>42 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>因为笔者鸽了，所以这里的代码就截止到 lab2 了，lab3 和 lab4 的代码在异常处理流那篇文章中有</p>
</blockquote>
<h1 id="MOS-源码解读"><a href="#MOS-源码解读" class="headerlink" title="MOS 源码解读"></a>MOS 源码解读</h1><p>[TOC]</p>
<h2 id="boot"><a href="#boot" class="headerlink" title="boot/"></a>boot/</h2><h3 id="start-S"><a href="#start-S" class="headerlink" title="start.S"></a>start.S</h3><h4 id="data"><a href="#data" class="headerlink" title=".data"></a>.data</h4><p>在这个里面声明了数据段的结构</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.data
            .globl mCONTEXT
mCONTEXT:
            .word 0

            .globl delay
delay:
            .word 0

            .globl tlbra
tlbra:
            .word 0

            .section .data.stk
KERNEL_STACK:
            .space 0x8000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，<code>mCONTEXT，delay,tlbra</code> 都是 <code>.data</code> 段的起始地址。里面的 <code>tlbra</code> 是 <code>tlb return address</code> 的意思，应该是 tlb 缺失异常处理结束后，就会返回这个地址。</p>
<h4 id="start"><a href="#start" class="headerlink" title="_start()"></a>_start()</h4><p>set，如注释所言</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">/*.set is used to instruct how the assembler works and control the order of instructions */
     .set	mips2
	.set	reorder<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>关于设置协处理器装填，有</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">/* Disable interrupts */
mtc0	zero, CP0_STATUS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>该条指令将CP0_STATUS寄存器的所有可写位置零。</p>
<p>所以将该寄存器置零的主要作用是：<strong>禁用所有中断</strong></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mtc0    zero, CP0_WATCHLO
mtc0    zero, CP0_WATCHHI<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在R30XX系列处理器中并没有实现这两个寄存器。查阅MIPS32文档，这两个寄存器实现的是调试功能，置零表示禁用调试功能。</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">/* disable kernel mode cache */
mfc0	t0, CP0_CONFIG
and		t0, ~0x7
ori		t0, 0x2
mtc0	t0, CP0_CONFIG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查阅MIPS32文档，该操作将config寄存器的低三位置为010.低三位叫做K0域，控制kseg0的可缓存性与一致性属性。置为010代表uncached，即不经过cache。</p>
<p>其实让我们干的只有这件事</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">/*
To do: 
set up stack 
you can reference the memory layout in the include/mmu.h
*/
lui		sp, 0x8040
jal		main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由内存图可以知道，只要把栈指针设置成 <code>0x8040_0000</code> 然后跳到 main 就可以了。设置栈指针是极其有必要的，因为我们后面会调用各种函数，而这些函数存储局部变量的位置就在栈上（下面这幅图画的有些不严谨，栈顶指针应该在栈顶）</p>
<p><img src="/posts/597dbeba/image-20220322172603002.png" alt="image-20220322172603002"></p>
<p>后面还有一个经典的刻意死循环</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">loop:
	j		loop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后对于这段代码，我没看懂</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">			.section .data.stk
KERNEL_STACK:
			.space 0x8000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我问叶哥哥，叶哥哥说没用，似乎重构的时候把他删了也不影响。</p>
<p>总的来说，这个文件里存了用汇编语言实现的 <code>_start</code> 这个函数。这个函数的功能是设置 CP0 和栈指针，然后跳到 <code>main</code> 中。。</p>
<hr>
<h2 id="init"><a href="#init" class="headerlink" title="init/"></a>init/</h2><h3 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h3><h4 id="main"><a href="#main" class="headerlink" title="main()"></a>main()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main.c:\tmain is start ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">mips_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"main is over is error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个函数主要的功能就是调用 <code>mips_init()</code> 函数。很容易理解</p>
<h3 id="init-c"><a href="#init-c" class="headerlink" title="init.c"></a>init.c</h3><h4 id="mips-init"><a href="#mips-init" class="headerlink" title="mips_init()"></a>mips_init()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">mips_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"init.c:\tmips_init() is called\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Lab 2 memory management initialization functions</span>
    <span class="token comment">// configure some constant for the memory</span>
	<span class="token function">mips_detect_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">mips_vm_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">page_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">physical_memory_manage_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">page_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"init.c:\tend of mips_init() reached!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次的内容与 lab 1时有所不同，因为增加了对存储系统的设置，主要通过三句话:</p>
<p>这句话设置了物理存储（即主存）的诸多参数，比如说物理存储的地址范围，空间，是否有拓展存储。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">mips_detect_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这句话设置了虚拟存储系统。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">mips_vm_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这句话设置了物理存储系统：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">page_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>后面两个函数只是为了检验 lab1 的正确性，不属于操作系统</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">physical_memory_manage_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">// 检查虚拟存储系统</span>
<span class="token function">page_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 检查物理存储系统</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>后面三句话应该只是一种捣乱，目的是为了终止这个函数的运行</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"init.c:\tend of mips_init() reached!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="bcopy"><a href="#bcopy" class="headerlink" title="bcopy()"></a>bcopy()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// byte copy</span>
<span class="token keyword">void</span> <span class="token function">bcopy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>max<span class="token punctuation">;</span>

	max <span class="token operator">=</span> dst <span class="token operator">+</span> len<span class="token punctuation">;</span>

	<span class="token comment">// copy machine words while possible</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>dst <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">&lt;</span> max<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>dst <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token punctuation">;</span>
		dst <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
		src <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// finish remaining 0-3 bytes</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>dst <span class="token operator">&lt;</span> max<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dst <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token punctuation">;</span>
		dst <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		src <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是一个按字节拷贝的函数，按字节拷贝的意思就是基本上啥内容都可以拷贝，因为啥内容都可以分割成字节。</p>
<p>函数声明中指明了拷贝源的起始地址 <code>src</code> ，拷贝目标的起始地址 <code>dst</code> ，拷贝的内容的字节数 <code>len</code> 。有趣的是，拷贝源的起始地址用修饰符 <code>const</code> 修饰，这说明其指向的内容是不可以修改的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// byte copy</span>
<span class="token keyword">void</span> <span class="token function">bcopy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>后面拷贝的方法也很有意思，先是 4 个字节 4 个字节的拷贝，然后才是 1 个字节 1 个字节的拷贝，可能这样比较高效吧，不过为什么不用 <code>long long</code> 就可以 8 个字节为单位拷贝了。经过陈同学指正，因为 32 位的系统一个字就是 4 个字节，用 long long 去存取，其实应该就是在汇编层面被拆成了两个指令。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>max<span class="token punctuation">;</span>
max <span class="token operator">=</span> dst <span class="token operator">+</span> len<span class="token punctuation">;</span>

<span class="token comment">// copy machine words while possible</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>dst <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">&lt;</span> max<span class="token punctuation">)</span> 
   <span class="token punctuation">{</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>dst <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token punctuation">;</span>
	dst <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
	src <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// finish remaining 0-3 bytes</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>dst <span class="token operator">&lt;</span> max<span class="token punctuation">)</span> 
   <span class="token punctuation">{</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dst <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token punctuation">;</span>
	dst <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	src <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="bzero"><a href="#bzero" class="headerlink" title="bzero()"></a>bzero()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// b is the head address of the memory need to be clear to 0</span>
<span class="token comment">// len is the length of the memory need to be clear</span>
<span class="token keyword">void</span> <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>max<span class="token punctuation">;</span>

	max <span class="token operator">=</span> b <span class="token operator">+</span> len<span class="token punctuation">;</span>

	<span class="token comment">// zero machine words while possible</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>b <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">&lt;</span> max<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		b <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// finish remaining 0-3 bytes</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;</span> max<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>b<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数和方法与 <code>bcopy()</code> 类似，就不说了。</p>
<hr>
<h2 id="include"><a href="#include" class="headerlink" title="include/"></a>include/</h2><h3 id="types-h"><a href="#types-h" class="headerlink" title="types.h"></a>types.h</h3><h4 id="typedef"><a href="#typedef" class="headerlink" title="typedef"></a>typedef</h4><p>主要是完成了数据类型别名的声明，这样可以提高兼容性，而且往往可以通过别名来推断数据的字节数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__mode__</span><span class="token punctuation">(</span>QI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">u_int8_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span>      <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__mode__</span><span class="token punctuation">(</span>HI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">int16_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__mode__</span><span class="token punctuation">(</span>HI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">u_int16_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span>      <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__mode__</span><span class="token punctuation">(</span>SI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">int32_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__mode__</span><span class="token punctuation">(</span>SI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">u_int32_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span>      <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__mode__</span><span class="token punctuation">(</span>DI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">int64_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__mode__</span><span class="token punctuation">(</span>DI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">u_int64_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token class-name">int32_t</span>         <span class="token class-name">register_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span>	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>	u_char<span class="token punctuation">;</span>
<span class="token keyword">typedef</span>	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>	u_short<span class="token punctuation">;</span>
<span class="token keyword">typedef</span>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	u_int<span class="token punctuation">;</span>
<span class="token keyword">typedef</span>	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>	u_long<span class="token punctuation">;</span>

<span class="token keyword">typedef</span>	<span class="token class-name">u_int64_t</span>		<span class="token class-name">u_quad_t</span><span class="token punctuation">;</span>	<span class="token comment">/* quads */</span>
<span class="token keyword">typedef</span>	<span class="token class-name">int64_t</span>			<span class="token class-name">quad_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span>	<span class="token class-name">quad_t</span> 			<span class="token operator">*</span><span class="token class-name">qaddr_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token class-name">u_int32_t</span>        <span class="token class-name">size_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后一个 <code>size_t</code> 可以理解为通用数据类型，大概意思就是要是没事就用他吧。</p>
<h4 id="MIN"><a href="#MIN" class="headerlink" title="MIN"></a>MIN</h4><p>MIN 这个宏，写的也很复杂，有一篇文章解释这个</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MIN</span><span class="token expression"><span class="token punctuation">(</span>_a<span class="token punctuation">,</span> _b<span class="token punctuation">)</span>	</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{</span>		</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">typeof</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> __a <span class="token operator">=</span> <span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>	</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">typeof</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> __b <span class="token operator">=</span> <span class="token punctuation">(</span>_b<span class="token punctuation">)</span><span class="token punctuation">;</span>	</span><span class="token punctuation">\</span>
		<span class="token expression">__a <span class="token operator">&lt;=</span> __b <span class="token operator">?</span> __a <span class="token operator">:</span> __b<span class="token punctuation">;</span>	</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/sunyubo/archive/2010/04/09/2282179.html">https://www.cnblogs.com/sunyubo/archive/2010/04/09/2282179.html</a></p>
<p>关于 <code>typeof</code>，它可以取得变量的类型，或者表达式的类型。</p>
<p>对于这句话</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typeof</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span> __a <span class="token operator">=</span> <span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>就是声明一个叫做 <code>__a</code> 的变量，他的数据类型与 <code>_a</code> 相同。</p>
<h4 id="ROUND-ROUNDDOWN"><a href="#ROUND-ROUNDDOWN" class="headerlink" title="ROUND, ROUNDDOWN"></a>ROUND, ROUNDDOWN</h4><p>下面这两个宏</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Rounding; only works for n = power of two */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ROUND</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ROUNDDOWN</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>会输出 a 在 n 的几倍数之间，比如下面</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">typedef</span>	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>	u_long<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ROUND</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ROUNDDOWN</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t%d\n"</span><span class="token punctuation">,</span> <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ROUNDDOWN</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会输出 <code>28    24</code> 因为 25 在 $4\times6 \sim 4\times 7 $ 之间。</p>
<p>具体的原理从这里看</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ROUNDDOWN</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>~((n)-1)</code> 是一串 1 以后有几个 0。比如 4 是 111……1100</li>
<li>再拿这个数去与 a 进行<strong>与</strong>操作，就会让低位都变成 0。</li>
</ul>
<h4 id="offsetof"><a href="#offsetof" class="headerlink" title="offsetof"></a>offsetof</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">offsetof</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span> member<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>type <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>一个基本的<strong>无符号整数</strong>的C / C + +类型，它是sizeof操作符返回的结果类型，该类型的大小可选择。因此，它可以存储在理论上是可能的任何类型的数组的最大大小。</p>
<p>他的意思是</p>
<ul>
<li><code>(type *)0</code> 将内存空间的 0 转换成需要的结构体指针</li>
<li><code>(type *)0)-&gt;member</code> 利用这个结构体指针指向某个成员</li>
<li><code>(&amp;((type *)0)-&gt;member)</code> 取这个成员的地址</li>
<li><code>((size_t)(&amp;((type *)0)-&gt;member))</code> 将这个成员的地址转化成 <code>size_t</code> 类型</li>
</ul>
<p>有如下示例</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">node</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">;</span>
    <span class="token keyword">double</span> b<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> c<span class="token punctuation">;</span>
    <span class="token keyword">double</span> d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>node<span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个会输出 16 （可能与我的电脑有关，理解即可）</p>
<h4 id="static-assert"><a href="#static-assert" class="headerlink" title="static_assert"></a>static_assert</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">static_assert</span><span class="token expression"><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token keyword">case</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token operator">:</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>没看懂，遇到再说</p>
<h3 id="mmu-h"><a href="#mmu-h" class="headerlink" title="mmu.h"></a>mmu.h</h3><p>正如这个文件一开始说的，这个文件分为三个部分，第一个部分是一些内存管理的常量，第二个部分是一个虚拟地址空间的分布，第三个部分是一些辅助性的函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * This file contains:
 *
 *	Part 1.  MIPS definitions.
 *	Part 2.  Our conventions.
 *	Part 3.  Our helper functions.
 /</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Memory-Constant"><a href="#Memory-Constant" class="headerlink" title="Memory Constant"></a>Memory Constant</h4><p>首先定义了页面的大小，我们知道无论是虚拟页面，还是物理页框，大小都是相同的，我们看到 MIPS 一页的大小是 4 KB。有意思的是，这个宏的名字的意思是 “Byte Per Page”。因为有两个首字母是 P，所以是 2P</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BY2PG</span>		<span class="token expression"><span class="token number">4096</span>		</span><span class="token comment">// bytes to a page</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在虚拟内存管理中，我们采用的是两级页表的方式，我们的第一级页表叫做“Page Dictionary”，一共有 1024 个条目（entry），每个条目都对应一个二级页表。第二级页表叫做“Page Table”，也有 1024 个条目，每个条目对应一个虚拟页。我们的虚拟地址一共是 32 位，呈现如下结构：</p>
<p><img src="/posts/597dbeba/VAddr.drawio.png" alt="VAddr.drawio"></p>
<p>由此我们知道，一个 page directory entry 对应 1 个 page table，一个 page table 又有 1024 个 Page，一个 Page 的大小是 $2^{12}$ 字节。 所以一个 page directory entry 对应的虚拟地址空间的大小就是 PDMAP。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PDMAP</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>	</span><span class="token comment">// bytes mapped by a page directory entry</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后我们定义了两个偏移量，这两个偏移量可以方便利用位运算求解各种东西。意义见注释</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PGSHIFT</span>		<span class="token expression"><span class="token number">12</span>       </span><span class="token comment">// log2(BY2PG)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PDSHIFT</span>		<span class="token expression"><span class="token number">22</span>		 </span><span class="token comment">// log2(PDMAP)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h4><p>分别是 Page Dictionary Index 和 Page Table Index。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PDX</span><span class="token expression"><span class="token punctuation">(</span>va<span class="token punctuation">)</span>		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">22</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x03FF</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PTX</span><span class="token expression"><span class="token punctuation">(</span>va<span class="token punctuation">)</span>		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x03FF</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以用下面的图来表示</p>
<p><img src="/posts/597dbeba/Index.png" alt="Index"></p>
<h4 id="PTE"><a href="#PTE" class="headerlink" title="PTE"></a>PTE</h4><p><strong>PTE_ADDR</strong></p>
<p>用于将 pte 前面的物理地址取出来，示意图如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PTE_ADDR</span><span class="token expression"><span class="token punctuation">(</span>pte<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xFFF</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/posts/597dbeba/pte.drawio.png" alt="pte.drawio"></p>
<p><strong>Page Dictionary/Table Flags</strong></p>
<p><img src="/posts/597dbeba/image-20220406211428285.png" alt="image-20220406211428285"></p>
<p>所谓的 flag 就是<strong>权限位</strong>，一共有 12 位，可以通过给不同的位置 1 来表示<strong>物理页</strong>的权限，具体解释如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_G</span>			<span class="token expression"><span class="token number">0x0100</span>	</span><span class="token comment">// 0001_0000_0000	Global bit</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_V</span>			<span class="token expression"><span class="token number">0x0200</span>	</span><span class="token comment">// 0010_0000_0000	Valid bit</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_R</span>			<span class="token expression"><span class="token number">0x0400</span>	</span><span class="token comment">// 0100_0000_0000	"Dirty", but really a write-enable bit. 1 to allow writes, 0 and any store using this translation will be trapped.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_D</span>			<span class="token expression"><span class="token number">0x0002</span>	</span><span class="token comment">// 0000_0000_0010	fileSystem Cached is dirty</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_COW</span>			<span class="token expression"><span class="token number">0x0001</span>	</span><span class="token comment">// 0000_0000_0001	Copy On Write</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_UC</span>			<span class="token expression"><span class="token number">0x0800</span>	</span><span class="token comment">// 1000_0000_0000	unCached</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_LIBRARY</span>		<span class="token expression"><span class="token number">0x0004</span>	</span><span class="token comment">// 0000_0000_0100	share memmory</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在我知道的</p>
<p>有效位，即存在位，当其被置 1 的时候，说明这个物理页框已经与虚拟页之间建立映射</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_V</span>			<span class="token expression"><span class="token number">0x0200</span>	</span><span class="token comment">// 0010_0000_0000	Valid bit</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可写位，只有这个位置 1，我们才可以往这个物理页面内写数据。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PTE_R</span>			<span class="token expression"><span class="token number">0x0400</span>	</span><span class="token comment">// 0100_0000_0000	"Dirty", but really a write-enable bit. 1 to allow writes, 0 and any store using this translation will be trapped.</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>pte typedef</strong></p>
<pre class="line-numbers language-none"><code class="language-none">typedef u_long Pde;
typedef u_long Pte;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>定义了页表项的本质就是 32 位整型数。</p>
<h4 id="Virtual-Space-Constant"><a href="#Virtual-Space-Constant" class="headerlink" title="Virtual Space Constant"></a>Virtual Space Constant</h4><p>这些宏主要是描述虚拟地址空间的各个坐标，或者是各个距离用的，最好结合内存图来理解</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 o     4G -----------&gt;  +----------------------------+------------0x100000000
 o                      |       ...                  |  kseg3
 o                      +----------------------------+------------0xe000 0000
 o                      |       ...                  |  kseg2
 o                      +----------------------------+------------0xc000 0000
 o                      |   Interrupts &amp; Exception   |  kseg1
 o                      +----------------------------+------------0xa000 0000
 o                      |      Invalid memory        |   /|\
 o                      +----------------------------+----|-------Physics Memory Max
 o                      |       ...                  |  kseg0
 o  VPT,KSTACKTOP-----&gt; +----------------------------+----|-------0x8040 0000-------end
 o                      |       Kernel Stack         |    | KSTKSIZE            /|\
 o                      +----------------------------+----|------                |
 o                      |       Kernel Text          |    |                    PDMAP
 o      KERNBASE -----&gt; +----------------------------+----|-------0x8001 0000    | 
 o                      |   Interrupts &amp; Exception   |   \|/                    \|/
 o      ULIM     -----&gt; +----------------------------+------------0x8000 0000-------    
 o                      |         User VPT           |     PDMAP                /|\ 
 o      UVPT     -----&gt; +----------------------------+------------0x7fc0 0000    |
 o                      |         PAGES              |     PDMAP                 |
 o      UPAGES   -----&gt; +----------------------------+------------0x7f80 0000    |
 o                      |         ENVS               |     PDMAP                 |
 o  UTOP,UENVS   -----&gt; +----------------------------+------------0x7f40 0000    |
 o  UXSTACKTOP -/       |     user exception stack   |     BY2PG                 |
 o                      +----------------------------+------------0x7f3f f000    |
 o                      |       Invalid memory       |     BY2PG                 |
 o      USTACKTOP ----&gt; +----------------------------+------------0x7f3f e000    |
 o                      |     normal user stack      |     BY2PG                 |
 o                      +----------------------------+------------0x7f3f d000    |
 a                      |                            |                           |
 a                      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                           |
 a                      .                            .                           |
 a                      .                            .                         kuseg
 a                      .                            .                           |
 a                      |~~~~~~~~~~~~~~~~~~~~~~~~~~~~|                           |
 a                      |                            |                           |
 o       UTEXT   -----&gt; +----------------------------+                           |
 o                      |                            |     2 * PDMAP            \|/
 a     0 ------------&gt;  +----------------------------+ -----------------------------
 o
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个是内核的起始地址，注意不是 <code>0x8000_0000</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KERNBASE</span> <span class="token expression"><span class="token number">0x80010000</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个是用户地址空间的上界，即 user limit。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ULIM</span> <span class="token expression"><span class="token number">0x80000000</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="Address-translate"><a href="#Address-translate" class="headerlink" title="Address translate"></a>Address translate</h4><p>下面两个宏可以完成从 kernel 虚拟地址到物理地址的转换和由物理地址到 kernel 虚拟地址的转换，其实转换的方法很简单，就是监区或者加上 <code>0x80000000</code> 说白了就是最高位置 0。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// translates from kernel virtual address to physical address.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PADDR</span><span class="token expression"><span class="token punctuation">(</span>kva<span class="token punctuation">)</span>						                    </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{</span>								                        </span><span class="token punctuation">\</span>
		<span class="token expression">u_long a <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span> <span class="token punctuation">(</span>kva<span class="token punctuation">)</span><span class="token punctuation">;</span>				            </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> ULIM<span class="token punctuation">)</span>					                    </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">panic</span><span class="token punctuation">(</span></span><span class="token string">"PADDR called with invalid kva %08lx"</span><span class="token expression"><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
		<span class="token expression">a <span class="token operator">-</span> ULIM<span class="token punctuation">;</span>						                    </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// translates from physical address to kernel virtual address.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">KADDR</span><span class="token expression"><span class="token punctuation">(</span>pa<span class="token punctuation">)</span>                                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{</span>                                                               </span><span class="token punctuation">\</span>
        <span class="token expression">u_long ppn <span class="token operator">=</span> <span class="token function">PPN</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ppn <span class="token operator">&gt;=</span> npage<span class="token punctuation">)</span>                                            </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token function">panic</span><span class="token punctuation">(</span></span><span class="token string">"KADDR called with invalid pa %08lx"</span><span class="token expression"><span class="token punctuation">,</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> ULIM<span class="token punctuation">;</span>                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="queue-h"><a href="#queue-h" class="headerlink" title="queue.h"></a>queue.h</h3><p>我们用内存管理中的链表举例：</p>
<p><img src="/posts/597dbeba/list.png" alt="list"></p>
<h4 id="List-Declare"><a href="#List-Declare" class="headerlink" title="List Declare"></a>List Declare</h4><p><strong>LIST HEAD</strong></p>
<p>这个宏很有意思，因为它不是会当一个<strong>函数</strong>来使，就是完成某个功能，然后给出一个返回值。它的作用是定义一个结构体，这个结构体是链表的表头。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// this macro define a struct</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_HEAD</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> type<span class="token punctuation">)</span>                                           	    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">name</span>                                                             </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">{</span>                                                                       </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">type</span> <span class="token operator">*</span>lh_first<span class="token punctuation">;</span>  </span><span class="token comment">/* first element */</span>                     	<span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>LIST_ENTRY</strong></p>
<p>与 <code>LIST_HEAD</code> 类似，这个宏也定义了一个结构体，这个结构体里面包含两个指针，就是实现双向链表的那两个指针。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_ENTRY</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span>                                                	    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">struct</span>                                                                  </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">{</span>                                                                       </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">type</span> <span class="token operator">*</span>le_next<span class="token punctuation">;</span>   </span><span class="token comment">/* next element */</span>                      	<span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">type</span> <span class="token operator">*</span><span class="token operator">*</span>le_prev<span class="token punctuation">;</span>  </span><span class="token comment">/* address of previous next element */</span>  	<span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="List-Find"><a href="#List-Find" class="headerlink" title="List Find"></a>List Find</h4><p><strong>LIST_FIRST</strong></p>
<p>这里要区分两个概念，一个是链表的头（head），一个是链表的首节点，在前面的图中就可以很好的搞懂</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Return the first element in the list named "head".
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_FIRST</span><span class="token expression"><span class="token punctuation">(</span>head<span class="token punctuation">)</span> 		<span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token operator">-&gt;</span>lh_first<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>LIST_NEXT</strong></p>
<p>这个其实跟单向链表那个挺像的，但是就是非得多了一个 <code>field</code> ，这是因为这种结构体把所有的链接指针都分装到了一起，所以不是结构体里面有指针，而是结构体里面有指针结构体，指针结构体里面有指针，所以我们需要用 <code>field</code> 来指定访问哪个指针结构体，比如</p>
<p><img src="/posts/597dbeba/queue.drawio.png" alt="queue.drawio"></p>
<p>我们就需要指定 <code>field = pp_link</code> </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_NEXT</span><span class="token expression"><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> field<span class="token punctuation">)</span> 	<span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_next<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="List-Operate"><a href="#List-Operate" class="headerlink" title="List Operate"></a>List Operate</h4><p>这些操作只要有了上面那张链表的示意图，就是很好理解的。</p>
<p>在后面的操作中经常出现 <code>do{...}while(0)</code> 结构，那么为什么要使用这种结构呢，是因为宏在展开的时候经常出错，所以我们要用这种结构，具体的原因见这个网址 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/357839758?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=1198576333020692481&amp;utm_campaign=shareo">https://zhuanlan.zhihu.com/p/357839758?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=1198576333020692481&amp;utm_campaign=shareo</a></p>
<p><strong>LIST_INIT</strong></p>
<p>初始化链表的方法就是把链表的首节点赋值为 NULL。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Reset the list named "head" to the empty list.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_INIT</span><span class="token expression"><span class="token punctuation">(</span>head<span class="token punctuation">)</span> 											</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">do</span> 															</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">{</span>                                            				</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                              </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>LIST_INSERT_HEAD</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Insert the element "elm" at the head of the list named "head".
 * The "field" name is the link element as above.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_INSERT_HEAD</span><span class="token expression"><span class="token punctuation">(</span>head<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> field<span class="token punctuation">)</span>                                </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                                                    </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                                                     </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>       </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>                                       </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>LIST_INSERT_TAIL</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Insert the element "elm" at the tail of the list named "head".
 * The "field" name is the link element as above. You can refer to LIST_INSERT_HEAD.
 * Note: this function has big differences with LIST_INSERT_HEAD !
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_INSERT_TAIL</span><span class="token expression"><span class="token punctuation">(</span>head<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> field<span class="token punctuation">)</span>                                           </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span>                                                                               </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                                                                </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>                                              </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">{</span>                                                                            </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">LIST_INSERT_HEAD</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">else</span>                                                                         </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">{</span>                                                                            </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>                </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token punctuation">{</span>                                                                        </span><span class="token punctuation">\</span>
				<span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token punctuation">}</span>                                                                        </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>                       </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>       </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                                          </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">}</span>                                                                            </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>LIST_INSERT_AFTER</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Insert the element "elm" *after* the element "listelm" which is
 * already in the list.  The "field" name is the link element
 * as above.
 */</span>
<span class="token comment">// Note: assign a to b &lt;==&gt; a = b</span>
<span class="token comment">// Step 1, assign elm.next to listelm.next.</span>
<span class="token comment">// Step 2: Judge whether listelm.next is NULL, if not, then assign listelm.next.pre to a proper value.</span>
<span class="token comment">// step 3: Assign listelm.next to a proper value.</span>
<span class="token comment">// step 4: Assign elm.pre to a proper value.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_INSERT_AFTER</span><span class="token expression"><span class="token punctuation">(</span>listelm<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> field<span class="token punctuation">)</span>												</span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">do</span>                                                                                  </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">{</span>                                                                                   </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>                         	</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>                                       	</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">{</span>                                                                              	</span><span class="token punctuation">\</span>
                <span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span> 		</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">}</span>                                                                              	</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>                                           	</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>                           	</span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>LIST_INSERT_BEFORE</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 * Insert the element "elm" *before* the element "listelm" which is
 * already in the list.  The "field" name is the link element
 * as above.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_INSERT_BEFORE</span><span class="token expression"><span class="token punctuation">(</span>listelm<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> field<span class="token punctuation">)</span> 							</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">do</span> 																	</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">{</span>		                											</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev<span class="token punctuation">;</span>                </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token punctuation">;</span>                            </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token operator">*</span><span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>                              </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">(</span>listelm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>            </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>LIST_REMOVE</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_REMOVE</span><span class="token expression"><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> field<span class="token punctuation">)</span>                                  				</span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">do</span>                                                       				</span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">{</span>                                                        				</span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>             					</span><span class="token punctuation">\</span>
                <span class="token expression"><span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev<span class="token punctuation">;</span>  </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token operator">*</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token operator">-&gt;</span>field<span class="token punctuation">.</span>le_prev <span class="token operator">=</span> <span class="token function">LIST_NEXT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span> 					</span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="pmap-h"><a href="#pmap-h" class="headerlink" title="pmap.h"></a>pmap.h</h3><h4 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h4><p>我们首先来看 <code>Page</code> 结构体的定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token function">LIST_ENTRY</span><span class="token punctuation">(</span>Page<span class="token punctuation">)</span> Page_LIST_entry_t<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Page</span> 
<span class="token punctuation">{</span>
	Page_LIST_entry_t pp_link<span class="token punctuation">;</span>	<span class="token comment">/* free list link */</span>

	<span class="token comment">// Ref is the count of pointers (usually in page table entries)</span>
	<span class="token comment">// to this page.  This only holds for pages allocated using</span>
	<span class="token comment">// page_alloc.  Pages allocated at boot time using pmap.c's "alloc"</span>
	<span class="token comment">// do not have valid reference count fields.</span>

	u_short pp_ref<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>涉及到的宏</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_ENTRY</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span>                                                	    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">struct</span>                                                                  </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">{</span>                                                                       </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">type</span> <span class="token operator">*</span>le_next<span class="token punctuation">;</span>   </span><span class="token comment">/* next element */</span>                      	<span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">type</span> <span class="token operator">*</span><span class="token operator">*</span>le_prev<span class="token punctuation">;</span>  </span><span class="token comment">/* address of previous next element */</span>  	<span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Page</code> 这个结构体可以看做是链表的一个节点，其结构如下</p>
<p><img src="/posts/597dbeba/queue.drawio.png" alt="queue.drawio"></p>
<p>那么 <code>Page</code> 到底是什么，我们说这个东西不是一个页面（显然这个东西没有 4KB 大小），他只是一个记录页面信息的东西，如果说得更确切些，它是一个<strong>记录物理页框信息</strong>的数据结构。他的官方属于叫做<strong>内存控制块</strong>，我们把空闲的内存控制块放进链表中，当我们需要分配物理内存的时候，就取出链表里的一些内存控制块，表示我们占用这些物理内存。</p>
<p>然后它又定义了一个链表，</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>Page_list<span class="token punctuation">,</span> Page<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>涉及的宏如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// this macro define a struct</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_HEAD</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> type<span class="token punctuation">)</span>                                           	    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">name</span>                                                             </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">{</span>                                                                       </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">type</span> <span class="token operator">*</span>lh_first<span class="token punctuation">;</span>  </span><span class="token comment">/* first element */</span>                     	<span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出这个链表的表头不是原来的 Page 结构体，而是一个新的结构体，结构如下</p>
<p><img src="/posts/597dbeba/queue.head.png" alt="queue.head"></p>
<h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4><p>这里会有一些各种数据结构的转化，这里用一张图总结一下各个数据结构之间的转化关系</p>
<p><img src="/posts/597dbeba/pmap.drawio.png" alt="pmap.drawio"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pages<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> u_long
<span class="token function">page2ppn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> pp <span class="token operator">-</span> pages<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
 * Get the physical address of Page 'pp'.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> u_long
<span class="token function">page2pa</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">page2ppn</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> PGSHIFT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
Get the Page struct whose physical address is 'pa'.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>
<span class="token function">pa2page</span><span class="token punctuation">(</span>u_long pa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PPN</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> npage<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"pa2page called with invalid pa: %x"</span><span class="token punctuation">,</span> pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// PPN(pa) we can get the phsical page number</span>
    <span class="token comment">// 'pages' is the array of physical pages</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">[</span><span class="token function">PPN</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Get the kernel virtual address of Page 'pp'.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> u_long
<span class="token function">page2kva</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">page2pa</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Transform the virtual address 'va' to physical address.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> u_long
<span class="token function">va2pa</span><span class="token punctuation">(</span>Pde <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> u_long va<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	Pte <span class="token operator">*</span>p<span class="token punctuation">;</span>

	pgdir <span class="token operator">=</span> <span class="token operator">&amp;</span>pgdir<span class="token punctuation">[</span><span class="token function">PDX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>pgdir <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">~</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	p <span class="token operator">=</span> <span class="token punctuation">(</span>Pte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&amp;</span>PTE_V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">~</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token function">PTE_ADDR</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="printf-h"><a href="#printf-h" class="headerlink" title="printf.h"></a>printf.h</h3><h4 id="panic"><a href="#panic" class="headerlink" title="panic"></a>panic</h4><p>其实就是一个宏包装了一个函数，使其更加适合标准输出，比如可以直接打印 bug 的文件名，出错的行数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">panic</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">_panic</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="asm-h"><a href="#asm-h" class="headerlink" title="asm.h"></a>asm.h</h3><h4 id="stack-frame"><a href="#stack-frame" class="headerlink" title="stack frame"></a>stack frame</h4><p>首先补充一下栈和栈帧的知识：</p>
<p>我们都知道，汇编一旦发生函数调用的时候，一般就会借助内存中的栈结构，我们在学计组的时候，学习到了栈的操作是通过 <code>$sp</code> 寄存器实现的。当栈指针减小的时候，就相当于分配出一块栈空间。反之，则是栈消减了。我们每调用一个函数（其实不严谨，应该是每一个调用别的函数的函数，即非叶子函数），都需要在栈上开辟出一个栈空间来辅助函数的使用（在调用子函数的时候寄存器需要保存）。其实到这里跟我们计组知识是吻合的。</p>
<p>但是这样不利于回溯，栈在我们眼里是同质性的，根本分不清子函数和母函数的界限在哪里。所以我们又规定了一个寄存器 <code>$fp</code>，这个寄存器会指向栈帧的第一个字，这样我们就可以回溯了，具体的示意图如下：</p>
<p><img src="/posts/597dbeba/2.png" alt="img"></p>
<h4 id="function-declare"><a href="#function-declare" class="headerlink" title="function declare"></a>function declare</h4><p>我们都知道，汇编的函数是用<strong>标签</strong>声明的，函数的结尾会有一个 <code>jr $ra</code> 。就像这样</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">sum:
#入栈过程
sw $t0, 0($sp)
addi $sp, $sp, -4
#传参过程
move $t0, $a0
move $t1, $a1
#函数过程
add $v0 $t0, $t1
#出栈过程
addi $sp, $sp, 4
lw $t0, 0($sp)
#return
jr $ra<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是这个依然是很朴素的，因为这个对于编译器很混乱，因为标签不止可以干表示函数的事情，编译器识别不出来这个函数。所以这要求我们写汇编函数的时候<strong>对于函数声明这件事情更加复杂一点</strong>。</p>
<p>这个函数声明的格式，是在这个文件中定义的，他希望我们写一个函数的时候，呈现这种格式（以上面那个函数为例）</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">LEAF(sum)
    #入栈过程
    sw $t0, 0($sp)
    addi $sp, $sp, -4
    #传参过程
    move $t0, $a0
    move $t1, $a1
    #函数过程
    add $v0 $t0, $t1
    #出栈过程
    addi $sp, $sp, 4
    lw $t0, 0($sp)
    #return
    jr $ra
END(sum)  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们先看 <code>LEAF</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">/*
 * LEAF - declare leaf routine
 */
#define LEAF(symbol)                                    \
                .globl  symbol;                         \
                .align  2;                              \
                .type   symbol,@function;               \
                .ent    symbol,0;                       \
symbol:         .frame  sp,0,ra<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这句话的意思就是定义了一个全局（是对链接器而言的）的符号 <code>symbol</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.globl  symbol;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这句话的意思是按照 2 字节的方式填充边界，<code>.align</code> 相当于一个对齐操作符，底下这句话的意思就是按照 $2^2$ 个字节进行对齐，注意只对其后面那一个变量</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.align  2; <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这句话定义了一个函数，<code>.type</code> 的格式：<code>.type &lt;name&gt; @&lt;type&gt;</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.type   symbol,@function; <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这条语句说明了函数的开始，但是后面的参数 0 我不知道啥意思</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.ent    symbol,0; <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下面这条语句才是我们最熟悉的<strong>函数标签</strong></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">symbol:         .frame  sp,0,ra<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>但是后面还是跟了个 <code>.frame</code> ，他的三个参数分别为栈指针，栈帧大小（因为叶子函数没有回溯的必要，所以不需要分配栈帧？），返回寄存器，存储返回地址。</p>
<p>然后再看 <code>NESTED</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">/*
 * NESTED - declare nested routine entry point
 */
#define NESTED(symbol, framesize, rpc)                  \
                .globl  symbol;                         \
                .align  2;                              \
                .type   symbol,@function;               \
                .ent    symbol,0;                       \
symbol:         .frame  sp, framesize, rpc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会发现与 <code>LEAF</code> 基本上一样，唯一的区别是最后一句</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">symbol:         .frame  sp, framesize, rpc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>显然母函数是需要栈帧的。但是返回寄存器变得可调了，我也不知道为啥，可能用的多了？</p>
<p>最后看 <code>end</code></p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">#define END(function)                                   \
                .end    function;                       \
                .size   function,.-function<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这句是函数的结尾</p>
<pre class="line-numbers language-none"><code class="language-none">.end    function;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这句不会，摆了</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.size   function,.-function<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="export"><a href="#export" class="headerlink" title="export"></a>export</h4><p><code>asm.h</code> 还涉及一个引入问题 <code>EXPORT</code>。</p>
<p>这是引入一个变量</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">#define	EXPORT(symbol)                                  \
							.globl	symbol; 				\
				symbol:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这是引入一个函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FEXPORT</span><span class="token expression"><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span>					</span><span class="token punctuation">\</span>
						<span class="token expression"><span class="token punctuation">.</span>globl	symbol<span class="token punctuation">;</span> 			</span><span class="token punctuation">\</span>
						<span class="token expression"><span class="token punctuation">.</span>type	symbol<span class="token punctuation">,</span>@function<span class="token punctuation">;</span>		</span><span class="token punctuation">\</span>
				<span class="token expression">symbol<span class="token operator">:</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="cp0regdef-h"><a href="#cp0regdef-h" class="headerlink" title="cp0regdef.h"></a>cp0regdef.h</h3><h4 id="CP0reg-Declare"><a href="#CP0reg-Declare" class="headerlink" title="CP0reg Declare"></a>CP0reg Declare</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_INDEX</span> <span class="token expression">$<span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_RANDOM</span> <span class="token expression">$<span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_ENTRYLO0</span> <span class="token expression">$<span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_ENTRYLO1</span> <span class="token expression">$<span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_CONTEXT</span> <span class="token expression">$<span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_PAGEMASK</span> <span class="token expression">$<span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_WIRED</span> <span class="token expression">$<span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_BADVADDR</span> <span class="token expression">$<span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_COUNT</span> <span class="token expression">$<span class="token number">9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_ENTRYHI</span> <span class="token expression">$<span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_COMPARE</span> <span class="token expression">$<span class="token number">11</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_STATUS</span> <span class="token expression">$<span class="token number">12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_CAUSE</span> <span class="token expression">$<span class="token number">13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_EPC</span> <span class="token expression">$<span class="token number">14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_PRID</span> <span class="token expression">$<span class="token number">15</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_CONFIG</span> <span class="token expression">$<span class="token number">16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_LLADDR</span> <span class="token expression">$<span class="token number">17</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_WATCHLO</span> <span class="token expression">$<span class="token number">18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_WATCHHI</span> <span class="token expression">$<span class="token number">19</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_XCONTEXT</span> <span class="token expression">$<span class="token number">20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_FRAMEMASK</span> <span class="token expression">$<span class="token number">21</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_DIAGNOSTIC</span> <span class="token expression">$<span class="token number">22</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_PERFORMANCE</span> <span class="token expression">$<span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_ECC</span> <span class="token expression">$<span class="token number">26</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_CACHEERR</span> <span class="token expression">$<span class="token number">27</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_TAGLO</span> <span class="token expression">$<span class="token number">28</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_TAGHI</span> <span class="token expression">$<span class="token number">29</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CP0_ERROREPC</span> <span class="token expression">$<span class="token number">30</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="SR-flags"><a href="#SR-flags" class="headerlink" title="SR flags"></a>SR flags</h4><p>还定义一些 SR 寄存器的标志位信息</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STATUSF_IP4</span> <span class="token expression"><span class="token number">0x1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STATUS_CU0</span> <span class="token expression"><span class="token number">0x10000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">STATUS_KUC</span> <span class="token expression"><span class="token number">0x2</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="regdef-h"><a href="#regdef-h" class="headerlink" title="regdef.h"></a>regdef.h</h3><h4 id="regdef"><a href="#regdef" class="headerlink" title="regdef"></a>regdef</h4><p>声明了通用寄存器的别名</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__ASM_MIPS_REGDEF_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__ASM_MIPS_REGDEF_H</span></span>

<span class="token comment">/*
 * Symbolic register names for 32 bit ABI
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">zero</span>    <span class="token expression">$<span class="token number">0</span>      </span><span class="token comment">/* wired zero */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AT</span>      <span class="token expression">$<span class="token number">1</span>      </span><span class="token comment">/* assembler temp  - uppercase because of ".set at" */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">v0</span>      <span class="token expression">$<span class="token number">2</span>      </span><span class="token comment">/* return value */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">v1</span>      <span class="token expression">$<span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">a0</span>      <span class="token expression">$<span class="token number">4</span>      </span><span class="token comment">/* argument registers */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">a1</span>      <span class="token expression">$<span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">a2</span>      <span class="token expression">$<span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">a3</span>      <span class="token expression">$<span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t0</span>      <span class="token expression">$<span class="token number">8</span>      </span><span class="token comment">/* caller saved */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t1</span>      <span class="token expression">$<span class="token number">9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t2</span>      <span class="token expression">$<span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t3</span>      <span class="token expression">$<span class="token number">11</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t4</span>      <span class="token expression">$<span class="token number">12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t5</span>      <span class="token expression">$<span class="token number">13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t6</span>      <span class="token expression">$<span class="token number">14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t7</span>      <span class="token expression">$<span class="token number">15</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s0</span>      <span class="token expression">$<span class="token number">16</span>     </span><span class="token comment">/* callee saved */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s1</span>      <span class="token expression">$<span class="token number">17</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s2</span>      <span class="token expression">$<span class="token number">18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s3</span>      <span class="token expression">$<span class="token number">19</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s4</span>      <span class="token expression">$<span class="token number">20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s5</span>      <span class="token expression">$<span class="token number">21</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s6</span>      <span class="token expression">$<span class="token number">22</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s7</span>      <span class="token expression">$<span class="token number">23</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t8</span>      <span class="token expression">$<span class="token number">24</span>     </span><span class="token comment">/* caller saved */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">t9</span>      <span class="token expression">$<span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">jp</span>      <span class="token expression">$<span class="token number">25</span>     </span><span class="token comment">/* PIC jump register */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">k0</span>      <span class="token expression">$<span class="token number">26</span>     </span><span class="token comment">/* kernel scratch */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">k1</span>      <span class="token expression">$<span class="token number">27</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">gp</span>      <span class="token expression">$<span class="token number">28</span>     </span><span class="token comment">/* global pointer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">sp</span>      <span class="token expression">$<span class="token number">29</span>     </span><span class="token comment">/* stack pointer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">fp</span>      <span class="token expression">$<span class="token number">30</span>     </span><span class="token comment">/* frame pointer */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">s8</span>		<span class="token expression">$<span class="token number">30</span>		</span><span class="token comment">/* same like fp! */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ra</span>      <span class="token expression">$<span class="token number">31</span>     </span><span class="token comment">/* return address */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="stackframe-h"><a href="#stackframe-h" class="headerlink" title="stackframe.h"></a>stackframe.h</h3><h4 id="Set-Interupt"><a href="#Set-Interupt" class="headerlink" title="Set Interupt"></a>Set Interupt</h4><p>中断可以通过设置 CP0 协处理器中的 SR 寄存器设置，最低一位被称为 IE，当其被置 1 时，启用中断功能，而当其被置 0 的时候，禁用中断，我们可以看下面两个宏</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.macro STI
	mfc0	t0,	CP0_STATUS
	li		t1, (STATUS_CU0 | 0x1)
	or		t0, t1
	mtc0	t0, CP0_STATUS
.endm


.macro CLI
	mfc0	t0, CP0_STATUS
	li		t1, (STATUS_CU0 | 0x1)
	or		t0, t1
	xor		t0, 0x1
	mtc0	t0, CP0_STATUS
.endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>STI</code> 把 IE 置为 1，所以是开启中断（set interrupt），而 <code>CLI</code> 把 IE 置为0，所以是清除中断（clear interrupt）。</p>
<h4 id="Save-and-Restore"><a href="#Save-and-Restore" class="headerlink" title="Save and Restore"></a>Save and Restore</h4><p>当进入中断的时候，或者是进入函数之前，有的时候是有必要保留寄存器中的数据到栈中，当函数调用结束或者异常处理过后，需要恢复寄存器中的数据，因此才有了这些宏</p>
<p><code>SAVE_ALL</code> 就是保存所有寄存器的值</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.macro SAVE_ALL                                   
		mfc0	k0, CP0_STATUS                   
		sll		k0, 3      /* extract cu0 bit */  
		bltz	k0, 1f                            
		nop       
		/*                                       
		 * Called from user mode, new stack      
		 */                                      
1:				
		move	k0, sp 
		get_sp      
		move	k1, sp                     
		subu	sp, k1,TF_SIZE                    
		sw		k0, TF_REG29(sp)                  
		sw		$2, TF_REG2(sp)                   
		mfc0	v0, CP0_STATUS                    
		sw		v0, TF_STATUS(sp)                 
		mfc0	v0, CP0_CAUSE                     
		sw		v0, TF_CAUSE(sp)                  
		mfc0	v0, CP0_EPC                       
		sw		v0, TF_EPC(sp)
		mfc0	v0, CP0_BADVADDR        
		sw		v0, TF_BADVADDR(sp)            
		mfhi	v0                               
		sw		v0,TF_HI(sp)                     
		mflo	v0                               
		sw	v0,TF_LO(sp)                     
		sw	$0,TF_REG0(sp)
		sw	$1,TF_REG1(sp)                    
		//sw	$2,TF_REG2(sp)                   
		sw	$3,TF_REG3(sp)                   
		sw	$4,TF_REG4(sp)                   
		sw	$5,TF_REG5(sp)                   
		sw	$6,TF_REG6(sp)                   
		sw	$7,TF_REG7(sp)                   
		sw	$8,TF_REG8(sp)                   
		sw	$9,TF_REG9(sp)                   
		sw	$10,TF_REG10(sp)                 
		sw	$11,TF_REG11(sp)                 
		sw	$12,TF_REG12(sp)                 
		sw	$13,TF_REG13(sp)                 
		sw	$14,TF_REG14(sp)                 
		sw	$15,TF_REG15(sp)                 
		sw	$16,TF_REG16(sp)                 
		sw	$17,TF_REG17(sp)                 
		sw	$18,TF_REG18(sp)                 
		sw	$19,TF_REG19(sp)                 
		sw	$20,TF_REG20(sp)                 
		sw	$21,TF_REG21(sp)                 
		sw	$22,TF_REG22(sp)                 
		sw	$23,TF_REG23(sp)                 
		sw	$24,TF_REG24(sp)                 
		sw	$25,TF_REG25(sp)                 
		sw	$26,TF_REG26(sp) 				 
		sw	$27,TF_REG27(sp) 				 
		sw	$28,TF_REG28(sp)                 
		sw	$30,TF_REG30(sp)                 
		sw	$31,TF_REG31(sp)
.endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>里面还嵌套了一个宏，但是我困了，不想分析了，有意思的是，这个宏没有大写</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.macro get_sp
	mfc0	k1, CP0_CAUSE
	andi	k1, 0x107C
	xori	k1, 0x1000
	bnez	k1, 1f
	nop
	li		sp, 0x82000000
	j		2f
	nop
1:
	bltz	sp, 2f
	nop
	lw		sp, KERNEL_SP
	nop

2:	nop
.endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>RESTORE_SOME</code> 应该是恢复了某些寄存器的值，没有恢复栈指针寄存器，我不知道为啥。 </p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">/*
 * Note that we restore the IE flags from stack. This means
 * that a modified IE mask will be nullified.
 */
.macro RESTORE_SOME                                      
		.set	mips1                            
		mfc0	t0, CP0_STATUS                    
		ori		t0, 0x3                          
		xori	t0, 0x3                          
		mtc0	t0, CP0_STATUS                    
		lw		v0, TF_STATUS(sp)             
		li		v1, 0xff00 				 
		and		t0, v1 					 
		nor		v1, $0, v1 				 
		and		v0, v1 					 
		or		v0, t0 					 
		mtc0	v0, CP0_STATUS 		 
		lw		v1, TF_LO(sp)                                       
		mtlo	v1                               
		lw		v0, TF_HI(sp)                     
		lw		v1, TF_EPC(sp)                    
		mthi	v0                               
		mtc0	v1, CP0_EPC                       
		lw	$31,TF_REG31(sp)                 
		lw	$30,TF_REG30(sp)                 
		lw	$28,TF_REG28(sp)                 
		lw	$25,TF_REG25(sp)                 
		lw	$24,TF_REG24(sp)                 
		lw	$23,TF_REG23(sp)                 
		lw	$22,TF_REG22(sp)                 
		lw	$21,TF_REG21(sp)                 
		lw	$20,TF_REG20(sp)                 
		lw	$19,TF_REG19(sp)                 
		lw	$18,TF_REG18(sp)                 
		lw	$17,TF_REG17(sp)                 
		lw	$16,TF_REG16(sp)                 
		lw	$15,TF_REG15(sp)                 
		lw	$14,TF_REG14(sp)                 
		lw	$13,TF_REG13(sp)                 
		lw	$12,TF_REG12(sp)                 
		lw	$11,TF_REG11(sp)                 
		lw	$10,TF_REG10(sp)                 
		lw	$9,TF_REG9(sp)                   
		lw	$8,TF_REG8(sp)                   
		lw	$7,TF_REG7(sp)                   
		lw	$6,TF_REG6(sp)                   
		lw	$5,TF_REG5(sp)                   
		lw	$4,TF_REG4(sp)                   
		lw	$3,TF_REG3(sp)                   
		lw	$2,TF_REG2(sp)                   
		lw	$1,TF_REG1(sp)                   
.endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还有两个 <code>RESTORE</code> </p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.macro RESTORE_ALL							 
		RESTORE_SOME								 
		lw	sp,TF_REG29(sp)  /* Deallocate stack */  
.endm

.set	noreorder
.macro RESTORE_ALL_AND_RET					 
		RESTORE_SOME							 
		lw	k0, TF_EPC(sp) 				 
		lw	sp, TF_REG29(sp)  /* Deallocate stack */  
		jr	k0 								 
		rfe 								 
.endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="mm"><a href="#mm" class="headerlink" title="mm/"></a>mm/</h2><h3 id="pmap-c"><a href="#pmap-c" class="headerlink" title="pmap.c"></a>pmap.c</h3><h4 id="mips-detect-memory"><a href="#mips-detect-memory" class="headerlink" title="mips_detect_memory()"></a>mips_detect_memory()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* These variables are set by mips_detect_memory() */</span>
u_long maxpa<span class="token punctuation">;</span>            <span class="token comment">/* Maximum physical address */</span>
u_long npage<span class="token punctuation">;</span>            <span class="token comment">/* Amount of memory(in pages) */</span>
u_long basemem<span class="token punctuation">;</span>          <span class="token comment">/* Amount of base memory(in bytes) */</span>
u_long extmem<span class="token punctuation">;</span>           <span class="token comment">/* Amount of extended memory(in bytes) */</span>

<span class="token comment">/* Overview:
   Initialize basemem and npage.
   Set basemem to be 64MB, and calculate corresponding npage value.
*/</span>
<span class="token keyword">void</span> <span class="token function">mips_detect_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">// Initialize basemem.</span>
    <span class="token comment">// the max limit of user physical memory</span>
    maxpa <span class="token operator">=</span> <span class="token number">0x4000000</span><span class="token punctuation">;</span>
    <span class="token comment">// the count of bytes in physical memory, is the size of physcial memory.</span>
    basemem <span class="token operator">=</span> <span class="token number">0x4000000</span><span class="token punctuation">;</span>
    <span class="token comment">// extern memory size</span>
    extmem <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
    <span class="token comment">// Calculate corresponding npage value.</span>
    npage <span class="token operator">=</span> basemem <span class="token operator">&gt;&gt;</span> PGSHIFT<span class="token punctuation">;</span>
    <span class="token comment">// print the memory information.</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Physical memory: %dK available, "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>maxpa <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"base = %dK, extended = %dK\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>basemem <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>extmem <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>maxpa</code> 就是物理地址的上界，可以看到，我们的物理地址的最大值是 <code>0x3FFFFFF</code> 。<code>basemem</code> 是物理内存的大小，所以是 64 MB。<code>extmem</code> 是该是扩展内存，盲猜是加装内存条之类的操作，所以我们是 0。</p>
<p><code>npage</code> 就是物理页框的数目，其实就是物理内存大小除以页框大小，但是此时计算用到的是位运算，借助了在 <code>mmu.h</code> 中的常量 <code>PGSHIFT</code>。我们有</p>
<script type="math/tex; mode=display">
npage = 2^{14} = 4 K</script><p>最后是一个打印信息，打印的信息是内存大小，因为单位是 KB，所以除了 1024。</p>
<h4 id="alloc"><a href="#alloc" class="headerlink" title="alloc()"></a>alloc()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u_long freemem<span class="token punctuation">;</span>
<span class="token comment">/* 
Overview:
   Allocate `n` bytes physical memory with alignment `align`, if `clear` is set, clear the
   allocated memory.
   This allocator is used only while setting up virtual memory system.

Post-Condition:
   If we're out of memory, should panic, else return this address of memory we have allocated.
*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">alloc</span><span class="token punctuation">(</span>u_int n<span class="token punctuation">,</span> u_int align<span class="token punctuation">,</span> <span class="token keyword">int</span> clear<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">extern</span> <span class="token keyword">char</span> end<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	u_long alloced_mem<span class="token punctuation">;</span>

	<span class="token comment">/* Initialize `freemem` if this is the first time. The first virtual address that the
	 * linker did *not* assign to any kernel code or global variables. */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>freemem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		freemem <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span>end<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Step 1: Round up `freemem` up to be aligned properly </span>
	freemem <span class="token operator">=</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>freemem<span class="token punctuation">,</span> align<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Step 2: Save current value of `freemem` as allocated chunk. </span>
	alloced_mem <span class="token operator">=</span> freemem<span class="token punctuation">;</span>

	<span class="token comment">// Step 3: Increase `freemem` to record allocation. </span>
	freemem <span class="token operator">=</span> freemem <span class="token operator">+</span> n<span class="token punctuation">;</span>

	<span class="token comment">// Check if we're out of memory. If we are, PANIC !! </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>freemem<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> maxpa<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"out of memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Step 4: Clear allocated chunk if parameter `clear` is set. </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
		<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>alloced_mem<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Step 5: return allocated chunk. </span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>alloced_mem<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>freemem</code> 是一个地址，这个地址之下都是已经被分配过的虚拟地址，而上面则是没有被分配过的虚拟地址空间，在这个函数里，我们通过对 <code>freemem</code> 进行累加操作，来表示分配一些地址区域。</p>
<p>看一下第一步的判断</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">char</span> end<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">/* Initialize `freemem` if this is the first time. The first virtual address that the
 * linker did *not* assign to any kernel code or global variables. */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>freemem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
   <span class="token punctuation">{</span>
	freemem <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span>end<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个要结合 <code>tools/scse0_3.lds</code> 理解，<code>scse0_3.lds</code> 的最后一句话声明了一个地址指针 <code>end</code> 它的值就是 <code>0x8040_0000</code>，他代表初始化结束后内核栈的栈顶，我们让 <code>freemem</code> 等于这个值，就说明我们分配的起点就是 <code>0x8040_0000</code>，其实分配虚拟内存空间，就是堆（可能是叫这个名字吧）增长的一个过程。</p>
<p>然后我们来看一下分配是如何操作的：</p>
<p><img src="/posts/597dbeba/图例.png" alt="图例"></p>
<p><img src="/posts/597dbeba/allocate.png" alt="allocate"></p>
<p>还是很好理解的。</p>
<p>这个函数只在内存控制块相关数据结构没有建立好之前使用（也就是 pages_init() 之前），当空闲链表的结构建立好了，那么就用 page_alloc() 分配页面。</p>
<h4 id="mips-vm-init"><a href="#mips-vm-init" class="headerlink" title="mips_vm_init()"></a>mips_vm_init()</h4><p>这个函数还是比较复杂的，我们先来看一下与两级页表相关的部分</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// pages is an array. The elememts of it are the physical page frames.</span>
<span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pages<span class="token punctuation">;</span>
	<span class="token comment">// Step 1: Allocate a page for page directory(first level page table). </span>
	pgdir <span class="token operator">=</span> <span class="token function">alloc</span><span class="token punctuation">(</span>BY2PG<span class="token punctuation">,</span> BY2PG<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"to memory %x for struct page directory.\n"</span><span class="token punctuation">,</span> freemem<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">alloc</span><span class="token punctuation">(</span>npage <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BY2PG<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"to memory %x for struct Pages.\n"</span><span class="token punctuation">,</span> freemem<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分配空间用的是 <code>alloc</code> 函数，而这个函数就是一个在虚拟地址空间上工作的函数，而不是在物理地址空间上工作的函数。这两个语句首先分配出一个虚拟页面来存放第一级页表，然后分配了 <code>npage</code> 个（也就是物理页框的数目）个内存控制块大小的空间来放置 <code>Pages</code> 数组。这些语句完成后的虚拟地址空间如图</p>
<p><img src="/posts/597dbeba/kseg0_new.png" alt="kseg0_new"></p>
<p>这有这样，我们才能在最后的输出上看到如下语句</p>
<p><img src="/posts/597dbeba/image-20220407162822077.png" alt="image-20220407162822077"></p>
<p>这里涉及一个需要仔细思考的问题，就是对于一个进程来说，他的数据可以存储在哪里？数据其实可以存在三个地方：</p>
<ul>
<li>数据段里，这个相当于是静态的，在进程还没有运行的时候就已经存在了，相当于上图的 <code>Kernel Text</code> 中的一部分。在 lab2-extra 中，它让做伙伴系统，但是我当时以为数据只能存储在堆或者栈里，所以一直不敢动笔，实在是哭笑不得。在这个段里存储的数据最大的缺点就是在写程序的时候这部分数据就已经被固定了。这里说的 ”固定“ 不是说就是不能修改的，而是对于数据的规模不能修改，其实就是类似于 C 语言的数组，即使可以修改内容，但是不能修改数组的大小。 </li>
<li>栈上，这个是函数里的局部变量所在的位置，这个段是易失的，只要一个函数运行完了，所以在上面的局部变量都会被销毁，所以基本上是没法用作管理的（因为管理是对进程的管理，一堆随着函数消失就消失的数据，显然是没用的）</li>
<li>堆上，这些数据虽然也是在函数内部创建的，但是却不会随着函数的结束而结束，他们的生命周期跟进程一样长（如果不手动释放的话），但是似乎在这里我们使用的时候是有一定限制的，<code>alloc()</code> 是唯一可以使用的函数，但是 <code>page_alloc</code> 并不是。 堆上的数据是可以随着进程的执行情况而灵活调整的。我们将 <code>pages</code> 数组放到堆上就很有道理了，因为物理内存的大小是通过 <code>mips_detect_memory</code> 实现的（不太严谨），所以我们没办法确定 <code>pages</code> 数组的大小，放在数据段里太过死板了。</li>
</ul>
<h4 id="page-init"><a href="#page-init" class="headerlink" title="page_init()"></a>page_init()</h4><p>说白了，page_init() 初始化的 page 就是刚才我们 mips_vm_init() 时用到的物理页。当然还完成了空闲链表的初始化</p>
<p>这个函数又涉及到了一个知识，就是我们是怎么把在虚拟地址空间中的操作系统内核映射（Kseg0）到物理内存中，我们都知道是直接把最高位抹掉。为啥呢，因为也没办法用MMU进行映射啊，操作系统还没建立起来的时候，MMU是没法使用的。那么我们需要分配多少的空间呢？或者说物理页框呢？其实就是我们用了多少的虚拟地址空间，也就是下面的语句：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token comment">/* Step 2: Align `freemem` up to multiple of BY2PG. */</span>
  freemem <span class="token operator">=</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>freemem<span class="token punctuation">,</span> BY2PG<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Step 3: Mark all memory blow `freemem` as used(set `pp_ref`
* filed to 1) */</span>
  <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>freemem<span class="token punctuation">)</span> <span class="token operator">/</span> BY2PG<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>size</code> 表示我们用过的物理页框的数目，但是我们不能直接使用 <code>freemem</code> 去除 <code>BY2PG</code> ，因为 <code>freemem</code> 不是从 0 开始增长的。这个时候我们可以利用这个宏来先将其转换成物理地址，然后在去做比，就可以得出我们想要的结果了：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// translates from kernel virtual address to physical address.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PADDR</span><span class="token expression"><span class="token punctuation">(</span>kva<span class="token punctuation">)</span>						                    </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{</span>								                        </span><span class="token punctuation">\</span>
		<span class="token expression">u_long a <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span> <span class="token punctuation">(</span>kva<span class="token punctuation">)</span><span class="token punctuation">;</span>				            </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> ULIM<span class="token punctuation">)</span>					                    </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">panic</span><span class="token punctuation">(</span></span><span class="token string">"PADDR called with invalid kva %08lx"</span><span class="token expression"><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
		<span class="token expression">a <span class="token operator">-</span> ULIM<span class="token punctuation">;</span>						                    </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于剩下的内存控制块，我们将他们插入到链表中，当然首先需要初始化链表</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Step 1: Initialize page_free_list. */</span>
<span class="token comment">/* Hint: Use macro `LIST_INIT` defined in include/queue.h. */</span>
   <span class="token function">LIST_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page_free_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Step 4: Mark the other memory as free. */</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> size<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npage<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
       pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token function">LIST_INSERT_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page_free_list<span class="token punctuation">,</span> pages <span class="token operator">+</span> i<span class="token punctuation">,</span> pp_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token function">LIST_REMOVE</span><span class="token punctuation">(</span><span class="token function">pa2page</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>TIMESTACK <span class="token operator">-</span> BY2PG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pp_link<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="page-alloc"><a href="#page-alloc" class="headerlink" title="page_alloc()"></a>page_alloc()</h4><p>这个函数实现的分配出一个空闲的物理页面，实现的方法就是从空闲内存控制块中挑取头结点并移除，并且把这个物理页框对应的虚拟地址空间清空。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*Overview:
	Allocates a physical page from free memory, and clear this page.

  Post-Condition:
	If failed to allocate a new page(out of memory(there's no free page)),
 	return -E_NO_MEM.
	Else, set the address of allocated page to *pp, and returned 0.

  Note:
 	Does NOT increment the reference count of the page - the caller must do
 	these if necessary (either explicitly or via page_insert).

  Hint:
	Use LIST_FIRST and LIST_REMOVE defined in include/queue.h .*/</span>
<span class="token keyword">int</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span><span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>ppage_temp<span class="token punctuation">;</span>

    <span class="token comment">/* Step 1: Get a page from free memory. If fails, return the error code.*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIST_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page_free_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ppage_temp <span class="token operator">=</span> <span class="token function">LIST_FIRST</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page_free_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LIST_REMOVE</span><span class="token punctuation">(</span>ppage_temp<span class="token punctuation">,</span> pp_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Step 2: Initialize this page.
     * Hint: use `bzero`. */</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token function">page2kva</span><span class="token punctuation">(</span>ppage_temp<span class="token punctuation">)</span><span class="token punctuation">,</span> BY2PG<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bzero requests virtual address!!!!</span>
    <span class="token operator">*</span>pp <span class="token operator">=</span> ppage_temp<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实我们之前也分配出过一些地址空间（在 page_init() 中），但是我们并没有用从链表中取元素的方法，因为当时这个链表还没有建立，所以我们采用的是把已经用到的物理页框就不插入链表的方法。</p>
<p>在这个函数开始的时候有一个判断链表为空的判断，其实这个就表示物理内存空间已经被完全分配完了，那么其实这个时候应该考虑页面置换的问题，比如 LRU 或者 FIFO 策略。但是我们的 MOS 比较简单。一旦物理页框全部被分配，进行新的映射时并不会进行任何的页面置换，而是直接返回错误，这对应 <code>page_alloc</code> 函数中返回的 <code>-E_NO_MEM</code>。</p>
<h4 id="page-free"><a href="#page-free" class="headerlink" title="page_free()"></a>page_free()</h4><p>首先其实是查看物理页面的引用次数，如果引用次数大于0，那么就啥也不做。只有引用次数等于 0 的时候。才把这个物理页面对应的内存控制块插入到空闲链表的头部。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*Overview:
	Release a page, mark it as free if it's `pp_ref` reaches 0.
  Hint:
	When to free a page, just insert it to the page_free_list.*/</span>
<span class="token keyword">void</span> <span class="token function">page_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* Step 1: If there's still virtual address refers to this page, do nothing. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pp<span class="token operator">-&gt;</span>pp_ref <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Step 2: If the `pp_ref` reaches to 0, mark this page as free and return. */</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pp<span class="token operator">-&gt;</span>pp_ref <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">LIST_INSERT_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page_free_list<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> pp_link<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* If the value of `pp_ref` less than 0, some error must occurred before,
     * so PANIC !!! */</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"cgh:pp-&gt;pp_ref is less than zero\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以这个函数叫做“页面释放”，我觉得很好，因为它并不能完全代替删除功能（没有减少引用次数的功能）。</p>
<h4 id="boot-map-segment"><a href="#boot-map-segment" class="headerlink" title="boot_map_segment()"></a>boot_map_segment()</h4><p>这个函数相当的有趣，他的作用是把一段虚拟地址空间中的一段内容映射到规定的一段物理地址空间上，也就是说，这是一个整块建立映射关系的函数。我们知道，所谓的建立映射关系，就是修改页表项，所以我们的函数这样写</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">boot_map_segment</span><span class="token punctuation">(</span>Pde <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> u_long va<span class="token punctuation">,</span> u_long size<span class="token punctuation">,</span> u_long pa<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span> va_temp<span class="token punctuation">;</span>
	Pte <span class="token operator">*</span>pgtable_entry<span class="token punctuation">;</span>

	<span class="token comment">// Step 1: Check if `size` is a multiple of BY2PG. </span>
    size <span class="token operator">=</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> BY2PG<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Step 2: Map virtual address space to physical address. </span>
	<span class="token comment">// Hint: Use `boot_pgdir_walk` to get the page table entry of virtual address `va`.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i <span class="token operator">+=</span> BY2PG<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pgtable_entry <span class="token operator">=</span> <span class="token function">boot_pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>pgtable_entry <span class="token operator">=</span> <span class="token function">PTE_ADDR</span><span class="token punctuation">(</span>pa <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>perm <span class="token operator">|</span> PTE_V<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体的思路就是将这段虚拟地址划分成多个虚拟页，然后依次将这些虚拟页对应的页表项检索出来，然后修改这些页表项，完成映射。</p>
<p>这里突然想到一件事情，就是对于给定的虚拟地址，只是物理地址不不能确定，但是页表项却是固定的。特定的虚拟地址只能对应特定的页表项（对于同一个页目录），我们的 <code>pgdir_walk</code> 正是基于这个原理实现的。正是因为如此，我们才能完成这个函数，我们修改的只是页表项的内容。</p>
<p>另外还有一个有趣的东西，是这个函数的使用</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">alloc</span><span class="token punctuation">(</span>npage <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BY2PG<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"to memory %x for struct Pages.\n"</span><span class="token punctuation">,</span> freemem<span class="token punctuation">)</span><span class="token punctuation">;</span>
n <span class="token operator">=</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>npage <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BY2PG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// map the 'pages' in virtual address space to the physical address space </span>
<span class="token function">boot_map_segment</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> UPAGES<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_R<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Step 3, Allocate proper size of physical memory for global array `envs`,
* for process management. Then map the physical address to `UENVS`. */</span>
envs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Env</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">alloc</span><span class="token punctuation">(</span>NENV <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Env</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BY2PG<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
n <span class="token operator">=</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>NENV <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Env</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BY2PG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">boot_map_segment</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> UENVS<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>envs<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_R<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个函数在 <code>mips_vm_init</code> 中被调用，在高 2G 的空间，<code>alloc</code> 以后其实对应的物理页面已经存储上相应的结构了，这是因为直接抹掉高 3 位就可以完成映射，所以映射已经完成了。那么还要两句 <code>boot_map_segment</code> 干嘛，他其实是在 <code>UPAGES</code> 和 <code>UENVS</code> 上拷贝了一份。也就是说，现在物理地址已经有两个控制块数组了，我们只是把一部分用户空间映射到了这写物理空间上面，先有的物理地址空间，后又的映射关系。这其实是内核对用户的一次分享。</p>
<h4 id="boot-pgdir-walk"><a href="#boot-pgdir-walk" class="headerlink" title="boot_pgdir_walk()"></a>boot_pgdir_walk()</h4><p>这个函数实现的功能是给定一个虚拟地址，查找他的二级页表项，如果二级页表项不存在，那么就给这个虚拟地址分配一个物理页面（这个由参数控制，如果置 0，那么就是单纯的查找，如果置 1，那么就是查不到就分配页面），这样二级页表项就不是空了，最后返回这个二级页表项。需要注意的是，这里查找出的二级页表项指的是二级页表项在虚拟地址空间中的地址，而不是页表项本身，而是指向这个页表项的一个指针。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Overview:
 	Get the page table entry for virtual address `va` in the given
 	page directory `pgdir`.
	If the page table is not exist and the parameter `create` is set to 1,
	then create it.*/</span>
<span class="token keyword">static</span> Pte <span class="token operator">*</span><span class="token function">boot_pgdir_walk</span><span class="token punctuation">(</span>Pde <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> u_long va<span class="token punctuation">,</span> <span class="token keyword">int</span> create<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    Pde <span class="token operator">*</span>pgdir_entryp<span class="token punctuation">;</span>
    Pte <span class="token operator">*</span>pgtable<span class="token punctuation">,</span> <span class="token operator">*</span>pgtable_entry<span class="token punctuation">;</span>

    <span class="token comment">/* Step 1: Get the corresponding page directory entry and page table. */</span>
    pgdir_entryp <span class="token operator">=</span> pgdir <span class="token operator">+</span> <span class="token function">PDX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// higher 10 bits</span>
   <span class="token comment">/* Step 2: If the corresponding page table is not exist and parameter `create`
     * is set, create one. And set the correct permission bits for this new page
     * table. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>pgdir_entryp <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>create<span class="token punctuation">)</span> <span class="token comment">// not valid =&gt; not exists.</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// page_init is not called yet, we should use alloc instead of page_alloc</span>
            <span class="token operator">*</span>pgdir_entryp <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span><span class="token function">alloc</span><span class="token punctuation">(</span>BY2PG<span class="token punctuation">,</span> BY2PG<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>pgdir_entryp <span class="token operator">=</span> <span class="token operator">*</span>pgdir_entryp <span class="token operator">|</span> PTE_V <span class="token operator">|</span> PTE_R<span class="token punctuation">;</span>
            <span class="token comment">// PTE_V : valid</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Step 3: Get the page table entry for `va`, and return it. */</span>
    <span class="token comment">/* Hint: Use KADDR and PTE_ADDR to get the page table from page directory
     * entry value. */</span>
    pgtable <span class="token operator">=</span> <span class="token punctuation">(</span>Pte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pgdir_entryp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pgtable_entry <span class="token operator">=</span> pgtable <span class="token operator">+</span> <span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pgtable_entry<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个函数可以用如下流程图演示</p>
<p><img src="/posts/597dbeba/boot_pgdir_walk.drawio.png" alt="boot_pgdir_walk.drawio"></p>
<p>此外，关于二级页表的查找过程，在此补充</p>
<p><img src="/posts/597dbeba/image-20220406211428285.png" alt="image-20220406211428285"></p>
<h4 id="pgdir-walk"><a href="#pgdir-walk" class="headerlink" title="pgdir_walk()"></a>pgdir_walk()</h4><p>流程基本上与 boot_pgdir_walk() 类似，只有以下区别：</p>
<ul>
<li>返回值不再是虚拟地址对应的二级页表项了，而是状态码，0 表示运行成功，其他表示有故障，二级页表项变成指针修改</li>
<li>分配方式不再使用 alloc，而是使用 page_alloc。这是因为这个函数不在启动的时候使用，而是在启动完成后使用，此时已经建立了物理内存管理的机制（空闲链表）</li>
<li>需要增加引用次数，之前 boot 中不需要，是因为在 pages_init() 里统一加了</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*Overview:
 	Given `pgdir`, a pointer to a page directory, pgdir_walk returns a pointer
 	to the page table entry (with permission PTE_R|PTE_V) for virtual address 'va'.

  Pre-Condition:
	The `pgdir` should be two-level page table structure.

  Post-Condition:
 	If we're out of memory, return -E_NO_MEM.
	Else, we get the page table entry successfully, store the value of page table
	entry to *ppte, and return 0, indicating success.

  Hint:
	We use a two-level pointer to store page table entry and return a state code to indicate
	whether this function execute successfully or not.
    This function have something in common with function `boot_pgdir_walk`.*/</span>
<span class="token keyword">int</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>Pde <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> u_long va<span class="token punctuation">,</span> <span class="token keyword">int</span> create<span class="token punctuation">,</span> Pte <span class="token operator">*</span><span class="token operator">*</span>ppte<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Pde <span class="token operator">*</span>pgdir_entryp<span class="token punctuation">;</span>
    Pte <span class="token operator">*</span>pgtable<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>ppage<span class="token punctuation">;</span>

    <span class="token comment">/* Step 1: Get the corresponding page directory entry and page table. */</span>
    pgdir_entryp <span class="token operator">=</span> pgdir <span class="token operator">+</span> <span class="token function">PDX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Step 2: If the corresponding page table is not exist(valid) and parameter `create`
     * is set, create one. And set the correct permission bits for this new page
     * table.
     * When creating new page table, maybe out of memory. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pgdir_entryp<span class="token punctuation">)</span> <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>create<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ppage<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token operator">*</span>pgdir_entryp <span class="token operator">=</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>ppage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>pgdir_entryp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pgdir_entryp<span class="token punctuation">)</span> <span class="token operator">|</span> PTE_V <span class="token operator">|</span> PTE_R<span class="token punctuation">;</span>
                ppage<span class="token operator">-&gt;</span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token operator">*</span>ppte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Step 3: Set the page table entry to `*ppte` as return value. */</span>
    pgtable <span class="token operator">=</span> <span class="token punctuation">(</span>Pte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pgdir_entryp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>ppte <span class="token operator">=</span> pgtable <span class="token operator">+</span> <span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="page-lookup"><a href="#page-lookup" class="headerlink" title="page_lookup"></a>page_lookup</h3><p>讲这个之前，我想对很多东西做一个总结，<code>mm</code> 文件夹下有很多函数，有一个特点是只要是 <code>page</code> 开头的，一般都是与物理内存空间相关的，精确一些，他们在操作 <code>Pages</code> 结构体中的元素，比如</p>
<ul>
<li>page_init(): 初始化pages结构体数组和链表结构</li>
<li>page_alloc(Page**): 从链表结构中分出一个</li>
<li>page_free(Page**): 插入链表</li>
<li>page_insert(Pde*, Page*, long, long): 建立一个虚拟页面与物理页面的映射关系，一般与 <code>page_alloc</code> 成对出现</li>
<li>page_lookup(Pde<em>, u_long, Pte*</em>): 查询某个虚拟地址对应的物理页面控制块</li>
<li>page_decref(Page **): 将该页面的引用次数下降</li>
<li>page_remove(Pde *, u_long): 将页面映射关系删除掉</li>
<li>pageout：调用 page_insert 和 page_alloc 来建立一个映射关系</li>
</ul>
<p>从上面可以看出，page_alloc 和 page_free 是比较基础的函数，他们涉及对空闲页面的操作。page_insert 的功能不完善，他必须在给定具体是哪一个物理页面之后，才可以建立映射关系，换句话说，他干的不是修改 page 的工作，而是修改页表的工作，page_remove 也呈现这个特征。pageout就比较完善了。</p>
<p>里面还有一些其他函数，大部分与查询页表有关。正是这些函数组成了内存管理。</p>
<p>还是需要强调，这些函数其实内核大部分都不会使用，因为高 2G 的映射关系就是高 3 位抹零，所以似乎在页表结构里登记都不用，因为就算登记了，也不能查，如果高 2 G 也查页表，那么就成了 bootloader 问题了，高 2G 需要借助页表完成转换，页表的登记需要高 2G 有完成转换的能力。</p>
<p>这个函数就是根据 va 将对应的物理页面的控制块查出来。同时还会获得对应的二级页表项，相比与 <code>pgdir_walk</code> 只能查找页表项，他可以完成对于该页表项的相关权限位的检验并且获取到控制块，可以看作是 <code>page_walk</code> 的加强版。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span><span class="token function">page_lookup</span><span class="token punctuation">(</span>Pde <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> u_long va<span class="token punctuation">,</span> Pte <span class="token operator">*</span><span class="token operator">*</span>ppte<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>ppage<span class="token punctuation">;</span>
	Pte <span class="token operator">*</span>pte<span class="token punctuation">;</span>

	<span class="token comment">/* Step 1: Get the page table entry. */</span>
	<span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Hint: Check if the page table entry doesn't exist or is not valid. */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//the page is not in memory.</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* Step 2: Get the corresponding Page struct. */</span>

	<span class="token comment">/* Hint: Use function `pa2page`, defined in include/pmap.h . */</span>
	ppage <span class="token operator">=</span> <span class="token function">pa2page</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ppte<span class="token punctuation">)</span> 
	<span class="token punctuation">{</span>
		<span class="token operator">*</span>ppte <span class="token operator">=</span> pte<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ppage<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="tlb-invalidate"><a href="#tlb-invalidate" class="headerlink" title="tlb_invalidate()"></a>tlb_invalidate()</h3><p>给定特定进程的 context 这个函数可以让这个进程对应页表中的这个虚拟地址对应的 tlb 项失效。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Overview:</span>
<span class="token comment">// 	Update TLB.</span>
<span class="token keyword">void</span> <span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>Pde <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> u_long va<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curenv<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">tlb_out</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">GET_ENV_ASID</span><span class="token punctuation">(</span>curenv<span class="token operator">-&gt;</span>env_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">tlb_out</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="page-remove"><a href="#page-remove" class="headerlink" title="page_remove()"></a>page_remove()</h4><p>这个函数的意思是解除虚拟页面到物理页框的映射，也就是说，原来这个虚拟地址所在的虚拟页面在物理内存中是存在的，现在我们要解除这种映射关系。也就说，这个物理页面不在属于这个虚拟页面了。</p>
<p>首先，我们需要根据这个虚拟读地址来找到对应的物理页框的内存控制块和这个二级页表项</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Pte <span class="token operator">*</span>pagetable_entry<span class="token punctuation">;</span>
   <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>ppage<span class="token punctuation">;</span>

   <span class="token comment">/* Step 1: Get the page table entry, and check if the page table entry is valid. */</span>
   ppage <span class="token operator">=</span> <span class="token function">page_lookup</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pagetable_entry<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后我们需要对内存块进行操作，具体就是减少引用次数，如果需要释放，那么就释放</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Step 2: Decrease `pp_ref` and decide if it's necessary to free this page. */</span>
   <span class="token comment">/* Hint: When there's no virtual address mapped to this page, release it. */</span>
   ppage<span class="token operator">-&gt;</span>pp_ref<span class="token operator">--</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>ppage<span class="token operator">-&gt;</span>pp_ref <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
       <span class="token function">page_free</span><span class="token punctuation">(</span>ppage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后让二级页表项变为 0，这样说明没有办法通过二级页表项查到对应的物理页面了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">*</span>pagetable_entry <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后让 tlb 对应的项也清零</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="page-decref"><a href="#page-decref" class="headerlink" title="page_decref()"></a>page_decref()</h4><p>减少物理页面的引用次数，如果引用次数减为0，才把这个物理页面对应的内存控制块插入到空闲链表的头部。似乎上面的 page_remove 里可以用这个函数改的更优雅些。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">page_decref</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>pp<span class="token operator">-&gt;</span>pp_ref <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">page_free</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="page-insert"><a href="#page-insert" class="headerlink" title="page_insert()"></a>page_insert()</h4><p>说是插入页面，其实更应该叫挤占页面。这个函数实现的功能是提供虚拟地址和给定的物理页框（所对应的内存控制块），把虚拟地址所在的虚拟页面映射到这个物理页框中去，并且给这个物理页框设置一些权限。</p>
<p>首先先获得该虚拟地址对应的二级页表项（方便之后处理和修改）</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Pte <span class="token operator">*</span>pgtable_entry<span class="token punctuation">;</span>
<span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pgtable_entry<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后判断这个二级页表项有没有已经对应到物理页面上了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>pgtable_entry <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>pgtable_entry <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果对应上了，那么接着判断已经对应的物理页框是不是我们需要它对应的物理页框</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pa2page</span><span class="token punctuation">(</span><span class="token operator">*</span>pgtable_entry<span class="token punctuation">)</span> <span class="token operator">!=</span> pp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果不是，那么就把这原有的映射关系取消掉</p>
<pre class="line-numbers language-none"><code class="language-none">page_remove(pgdir, va);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果是，那么工作就很简单，基本上马上就能返回了。因为映射关系没有变，所以我们只需要把 TLB 无效掉，这是因为原有的权限可能和这次的权限不同。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span>pgtable_entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">page2pa</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token operator">|</span> PERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后我们插入一页</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pgtable_entry<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意这里不是冗余，上面的 walk 是查询，所以只查询，如果没查到不会创建新的页面，而这次如果没有查到，则会创建新的页面并且修改一级页表。</p>
<p>既然创建的新的，那么就需要设置一下二级页表项的权限</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">*</span>pgtable_entry <span class="token operator">=</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token operator">|</span> PERM<span class="token punctuation">;</span>
   pp<span class="token operator">-&gt;</span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="page-out"><a href="#page-out" class="headerlink" title="page_out()"></a>page_out()</h4><p>这里似乎可以先记录一下自己对于 context 的粗浅理解。context 是进程上下文的意思，当操作系统切换进程的时候，原有进程的虚拟地址映射需要保留，其实就是保留页表系统，context 是一级页表的起始地址。</p>
<p>这个函数主要实现的功能就是给定虚拟地址和特定的进程一级目录地址，为这个进程的该虚拟地址对应的虚拟页面分配一个物理页框。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">pageout</span><span class="token punctuation">(</span><span class="token keyword">int</span> va<span class="token punctuation">,</span> <span class="token keyword">int</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    u_long r<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">&lt;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"tlb refill and alloc error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">&gt;</span> <span class="token number">0x7f400000</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>va <span class="token operator">&lt;</span> <span class="token number">0x7f800000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;it's env's zone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">&lt;</span> <span class="token number">0x10000</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"^^^^^^TOO LOW^^^^^^^^^"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"page alloc error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    p<span class="token operator">-&gt;</span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token function">page_insert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Pde <span class="token operator">*</span><span class="token punctuation">)</span>context<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token function">VA2PFN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_R<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="tlb-asm-S"><a href="#tlb-asm-S" class="headerlink" title="tlb_asm.S"></a>tlb_asm.S</h3><h4 id="tlb-out"><a href="#tlb-out" class="headerlink" title="tlb_out()"></a>tlb_out()</h4><p>这个函数主要实现的是给定一个 tlb 需要的键值（即表项的高 32 位），把这个键值对应的表项置 0 （就是 64 位全是 0）。</p>
<p>首先我们需要弄懂 tlb 的结构，计组认为的 TLB，是长这样的：</p>
<p><img src="/posts/597dbeba/tlb.drawio.png" alt="tlb.drawio"></p>
<p>也就是说，TLB 是一个全相连的 cache，既然是全相连，就不由 index 段了。我们用虚拟地址的前 22 位作为 TAG，并行的比较 64 个TLB 的 line，如果 TAG 相等，就说明找到了，反之，这说明没有找到。</p>
<p>不过这个模型还是有些粗糙的，很多细节并没有说明白。</p>
<p>在操作系统指导书里提到，tlb 构建了一个映射关系，我简化一下，就是 $VPN\space \rightarrow\space PPN$ 。当然这是对的了，但是这种说法我就弄成了每个 VPN 都会对应一个 PPN，但是其实这种映射关系只有 64 对。而且叫映射似乎就是一下就射过去了，而不是一个并行的比较过程。</p>
<p>其次就是，我们没有了解具体硬件发生了啥，比如 VPN 是怎样被检索的，被检索到的 PPN 放到了哪里，tlb 缺失以后具体怎么填补。都是没有的。这其实跟协处理器有很大关系。</p>
<p>在了解协处理器之前，我们先来看一下 tlb 的表项，他比计组版本要复杂一些，我们以 MOS 中 64MB （也就是共有 $2^{14}$ 页 ）的物理内存为例</p>
<p><img src="/posts/597dbeba/tlb_entry.png" alt="tlb_entry"></p>
<p>我们来说明一下这些差别：</p>
<ul>
<li>朴素版的 PPN 只有 14 位，是因为物理页框号可以最少用 14 位表示，但是真实版的 PPN 也与 VPN 相同，是 22 位。可能是考虑到不同电脑上内存不同吧，这估计也是 mips_detect_memory() 这个函数的设置。</li>
<li>朴素版一个 entry 是 36 位，而真实版一个 entry 是 64 位。这是因为真实版的标志位更多，所以需要的位数就更多</li>
<li>朴素版没有 ASID 段，而真实版有。ASID（address space identifier）应该是用于区分不同进程的一个标识符，因为操作系统可以同时运行多个进程，要是不用 ASID 的话，只要进程一切换，那么 TLB 里的所有内容都需要失效（因为进程切换就以为着虚拟地址和物理地址的映射关系切换），而这样是低效的，因为每次 TLB 中的内容清空，就意味着会发生 64 次的冷缺失。</li>
<li>朴素版没有物理地址权限标志位（N，D，V，G），而真实版有。这四个标志位的解释见下表</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>标志位</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>N（Non-cachable）</td>
<td>当该位置高时，后续的物理地址访存将不通过 cache</td>
</tr>
<tr>
<td>D（Dirty）</td>
<td>事实上是可写位。当该位置高时，该地址可写；否则任何写操作都将引发 TLB 异常。</td>
</tr>
<tr>
<td>V（Valid）</td>
<td>如果该位为低，则任何访问该地址的操作都将引发 TLB 异常。</td>
</tr>
<tr>
<td>G（Global）</td>
<td>如果该位置高，那么允许不同的虚拟地址映射到相同的物理地址，可能类似于进程级别的共享</td>
</tr>
</tbody>
</table>
</div>
<p>总结起来就是真实版的 tlb 建立了一个这样的映射 $<vpn,asid>\space\rightarrow\space<ppn,n,d,v,g>$ 。</ppn,n,d,v,g></vpn,asid></p>
<p>然后我们来解决下一个问题，就是 tlb 怎么用的问题。这是一个我之前忽略的点，因为其实我对于 tlb 的定位并不清楚，我本以为它就好像是一个 cache，是对于程序员是透明的，我就在编程的时候写虚拟地址，然后就有硬件（MMU）拿着这个地址去问 tlb，tb再做出相关反应，这一切都是我不需要了解的，但是实际上 tlb 的各种操作，都是需要软件协作的。之所以有这个错误认知，是因为似乎在 X86 架构下确实是由硬件干的，但是由于我们的 MIPS 架构，也就是 RISC 架构，所以似乎交由软件负责效率更高一些。</p>
<p>如果 tlb 是程序员可见的，那么我们必然要管理它，那么我们就需要思考怎样管理它？我们管理它的方式就是设置了专门的寄存器和专门的指令。指令用于读或者写 tlb 中的内容，而寄存器则用于作为 CPU 和 tlb 之间沟通的媒介，就好像我们需要用 hi 和 lo 寄存器与乘除单元沟通一样。这些寄存器，都位于 CP0 中</p>
<p>在协处理器里面与 tlb 有关的寄存器如下表：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>寄存器</th>
<th>编号</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>EntryHi</td>
<td>10</td>
<td>保存某个 tlb 表项的高 32 位，任何对 tlb 的读写，都需要通过 EntryHi 和 EntryLo</td>
</tr>
<tr>
<td>EntryLo</td>
<td>2</td>
<td>保存某个 tlb 表项的低 32 位</td>
</tr>
<tr>
<td>Index</td>
<td>0</td>
<td>决定索引号为某个值的 tlb 表项被读或者写</td>
</tr>
<tr>
<td>Random</td>
<td>1</td>
<td>提供一个随机的索引号用于 tlb 的读写</td>
</tr>
</tbody>
</table>
</div>
<p>这里再说一下各个寄存器的域</p>
<ul>
<li>EntryHi，EntryLo 的域与 tlb 表项完全相同</li>
<li>Index 的域：<img src="/posts/597dbeba/image-20220409154810627.png" alt="image-20220409154810627"></li>
<li>Random 的域：<img src="/posts/597dbeba/image-20220409154846877.png" alt="image-20220409154846877"></li>
</ul>
<p>与 tlb 相关的指令</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tlbr</td>
<td>以 Index 寄存器中的值为索引,读出 TLB 中对应的表项到 EntryHi 与 EntryLo。</td>
</tr>
<tr>
<td>tlbwi</td>
<td>以 Index 寄存器中的值为索引,将此时 EntryHi 与 EntryLo 的值写到索引指定的 TLB 表项中。</td>
</tr>
<tr>
<td>tlbwr</td>
<td>将 EntryHi 与 EntryLo 的数据随机写到一个 TLB 表项中（此处使用 Random 寄存器来“随机”指定表项，Random 寄存器本质上是一个不停运行的循环计数器）</td>
</tr>
<tr>
<td>tlbp</td>
<td>tlb probe。用于查看 tlb 是否可以转换虚拟地址（即命中与否）根据 EntryHi 中的 Key（包含 VPN 与 ASID），查找 TLB 中与之对应的表项。如果命中，并将表项的索引存入 Index 寄存器。若未找到匹配项，则 Index 最高位被置 1。</td>
</tr>
</tbody>
</table>
</div>
<p>然后我们来看这个函数的实现</p>
<p>它首先把原来 EntryHi 寄存器里的数据保存了下来（因为一会儿要把我们的键值放进去，怕数据被覆盖了）</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mfc0	k1, CP0_ENTRYHI<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后进行查询，并且判断有没有查询到</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mtc0	a0, CP0_ENTRYHI # 把键值移入 EntryHi
nop
tlbp					# 查询，将查询的结果存入 Index 寄存器
nop
nop
nop
nop
mfc0	k0, CP0_INDEX	# 把 Index 的内容移出来（Index 中保持着查询结果）
bltz	k0, NOFOUND		# 通过与 0 比较，判断有没有查到
nop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果没有查到，就只进行如下操作：把原来的 EntryHi 给恢复了，返回</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">NOFOUND:
	mtc0	k1, CP0_ENTRYHI		# 将原来的 EntryHi 给恢复了
	j		ra					# 返回
	nop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果查到了，在进行上面的操作之前，还需要进行把这个条目全部清零的操作</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mtc0	zero, CP0_ENTRYHI	# 将 EntryHi 清零
mtc0	zero, CP0_ENTRYLO0	# 将 EntryLo 清零
nop
tlbwi						# 将 EntryHi 和 EntryLo 的内容写入 index 对应的 tlb条目<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="lib"><a href="#lib" class="headerlink" title="lib/"></a>lib/</h2><h3 id="genex-S"><a href="#genex-S" class="headerlink" title="genex.S"></a>genex.S</h3><p>个人感觉是 generate exception 的缩写。在这里突然想到到底需求的代码是没有办法用 C 语言书写的，而必须哟弄汇编语言书写。个人感觉一旦涉及到特定的寄存器了，那么 C 语言就会失效。比如说协处理器里面的寄存器。我们知道异常处理都与这些寄存器相关，所以必须得用汇编语言书写。可以这样表述：</p>
<blockquote>
<p>C 语言相较于汇编语言丧失了寄存器级别的控制力。</p>
<p>C 语言实现了变量的抽象。</p>
</blockquote>
<h4 id="BUILD-HANDLER"><a href="#BUILD-HANDLER" class="headerlink" title="BUILD_HANDLER"></a>BUILD_HANDLER</h4><p>这个代码里涉及了很多汇编的知识，先看代码</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.macro	BUILD_HANDLER exception handler clear
	.align	5
	NESTED(handle_\exception, TF_SIZE, sp)  
	//.set	noat

	nop

	SAVE_ALL				
	__build_clear_\clear
	.set	at
	move	a0, sp
	jal		\handler
	nop
	j		ret_from_exception
	nop
	END(handle_\exception)
.endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先是引用形参，gcc 不是依靠 <code>%</code> 而是依靠 <code>/</code> 这个符号（与这个现象类似的是注释也不再是 <code>#</code> ，而是 <code>//</code> ），比如说这句话</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">NESTED(handle_\exception, TF_SIZE, sp)  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果有一个宏的引用长这样</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">BUILD_HANDLER tlb	do_refill	cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其实上面那句话就是</p>
<pre class="line-numbers language-none"><code class="language-none">NESTED(handle_tlb, TF_SIZE, sp)  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后我们会看到很多 <code>.set</code> 伪指令，这些伪指令都是为了控制编译器的工作状态的。这里统一总结一下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>指令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>noreorder/reorder</td>
<td>reoder 就是乱序的意思，允许乱序就不让插入 nop，我不知道为啥</td>
</tr>
<tr>
<td>volatile/novolatile</td>
<td>当设置成 volatile 的时候，访存指令之间就不可以调换顺序了，反之，则可以调换顺序</td>
</tr>
<tr>
<td>noat/at</td>
<td>$at 寄存器一般（即 at 状态）是归编辑器管理的，是编译器用来辅助宏的实现的，如果用户尝试使用，会报错或者警告。当设置为 noat 状态后，$at 归用户管理，编辑器如果使用，则会报错或者警告</td>
</tr>
<tr>
<td>nomacro/macro</td>
<td>不是禁用宏，而是禁用像 <code>li</code> 这样由其他多条指令组成的指令</td>
</tr>
</tbody>
</table>
</div>
<p>这个宏声明了一个异常处理函数（Exception Handler），它提炼了一些异常处理函数的共性。</p>
<p>它先声明了一个函数，这个函数是一个嵌套函数，他的名字是 handle_exception</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">NESTED(handle_\exception, TF_SIZE, sp)  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后保存了寄存器</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">SAVE_ALL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下面这句话设置了中断，但是叶哥哥说没用，因为 R3000 会在陷入中断时在硬件层面设置，不需要软件设置</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">__build_clear_\clear<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后跳转到了真正的异常处理程序处</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">move	a0, sp
jal		\handler
nop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后处理完后，跳转到返回函数处</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">j		ret_from_exception
nop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个返回函数应该是在其他文件定义的，因为有如下语句</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">FEXPORT(ret_from_exception)
	.set noat
	.set noreorder
	RESTORE_SOME
	.set at
	lw	k0, TF_EPC(sp)				 
	lw	sp, TF_REG29(sp) /* Deallocate stack */  
//1:	
	j	1b
	nop
	jr	k0								 
	rfe		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后我们在这个文件里找到了它应用这个宏声明了三个 handler，如下</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">BUILD_HANDLER reserved do_reserved cli
BUILD_HANDLER tlb	do_refill	cli
BUILD_HANDLER mod	page_fault_handler cli<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="do-refill"><a href="#do-refill" class="headerlink" title="do_refill()"></a>do_refill()</h4><p>这个函数在 tlb 发生缺失异常的时候，将缺失的物理页面调入 tlb 中，修复异常。</p>
<p>当 tlb 发生缺失的时候，其实对应了两种情况</p>
<ul>
<li>虚拟页没有映射到物理页框上</li>
<li>虚拟页面映射到物理页框上，但是物理页框没有放在 tlb 里</li>
</ul>
<p>对于第二种情况，我们就其实就是可以直接挑一个 tlb 的项，然后覆盖掉就好了，具体的操作就是如下</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mtc0	k1,CP0_ENTRYLO0
nop
tlbwr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>但是如果是第一种情况，那么我们还需要为这个虚拟页分配好物理页框，也就是调用 page_out 函数。</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">	.extern tlbra
.set	noreorder
NESTED(do_refill, 0, sp)
			//li	k1, '?'
			//sb	k1, 0x90000000
			.extern	mCONTEXT
//this "1" is important
1:			//j 1b
			nop
			lw		k1,mCONTEXT
			and		k1,0xfffff000   # k1 now store the phsical address of page dictionary
			mfc0	k0,CP0_BADVADDR
			srl		k0,20			# get the virtual address top 10 bit
			and		k0,0xfffffffc	# c = 1100 align 4 bit, k0 now is the offset(becacause pte size is 4 bit) 
			addu	k0,k1			# get the page_dictionary_entry address
			
			lw		k1,0(k0)		# get the page_dictionary_entry
			nop
			move	t0,k1			# t0 is the page_dictionary_entry
			and		t0,0x0200       # check the validility of the page_dictionary_entry
			beqz	t0,NOPAGE		# if not exist, call page_out()
			nop
			and		k1,0xfffff000
			mfc0	k0,CP0_BADVADDR
			srl		k0,10
			and		k0,0xfffffffc
			and		k0,0x00000fff
			addu	k0,k1			# get the page_table_entry

			or		k0,0x80000000
			lw		k1,0(k0)
			nop
			move	t0,k1
			and		t0,0x0200  		# check the validility of the page_table_entry
			beqz	t0,NOPAGE		# if not exist, call page_out()
			nop
			move	k0,k1
			and		k0,0x1
			beqz	k0,NoCOW
			nop
			and		k1,0xfffffbff
NoCOW:
			mtc0	k1,CP0_ENTRYLO0
			nop
			tlbwr

			j		2f
			nop
NOPAGE:
//3: j 3b
nop
			mfc0	a0,CP0_BADVADDR
			lw		a1,mCONTEXT
			nop
				
			sw	 	ra,tlbra
			jal		pageout
			nop
//3: j 3b
nop
			lw		ra,tlbra
			nop

			j		1b
2:			nop

			jr		ra
			nop
END(do_refill)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="printf-c"><a href="#printf-c" class="headerlink" title="printf.c"></a>printf.c</h3><h4 id="myoutput"><a href="#myoutput" class="headerlink" title="myoutput()"></a>myoutput()</h4><p><code>myoutput</code>会打印出给定长度的给定字符串。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">myoutput</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token comment">// special termination call</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>l <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printcharc</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token function">printcharc</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为有 <code>static</code> 关键字，所以只在本文件可见，所以在调用的时候，用了函数指针的操作。奇怪的是，第一个参数 <code>arg</code> 并没有用到，这个在真正调用的时候，传入的是 0。我不太能理解为啥。后面的参数 <code>s</code> 就是需要打印的字符串，<code>l</code> 是字符串的长度，可以看到，就是用一个 for 循环去调用 <code>printcharc</code> 很好理解。</p>
<h4 id="printf"><a href="#printf" class="headerlink" title="printf()"></a>printf()</h4><p>就是我们用的最熟的那个形式和功能。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    va_list ap<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lp_Print</span><span class="token punctuation">(</span>myoutput<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为指导书里介绍过了可变参数列表的内容，这里不再介绍，所以这个函数很显然，而且参数就是我们知道的参数。</p>
<h4 id="panic-1"><a href="#panic-1" class="headerlink" title="_panic()"></a>_panic()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">_panic</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    va_list ap<span class="token punctuation">;</span>

    <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"panic at %s:%d: "</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lp_Print</span><span class="token punctuation">(</span>myoutput<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>fmt<span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这次作业中没有涉及，但是可以查到他的用处</p>
<blockquote>
<p>用于显示内核错误信息并使系统进入死循环</p>
</blockquote>
<p>结合这个作用来看，还挺自然的。</p>
<h3 id="print-c"><a href="#print-c" class="headerlink" title="print.c"></a>print.c</h3><h4 id="OUTPUT"><a href="#OUTPUT" class="headerlink" title="OUTPUT"></a>OUTPUT</h4><p>首先需要了解一下什么是函数指针</p>
<p>函数指针为什么可以存在，我觉得吴哥哥说的在理</p>
<blockquote>
<p>C 是高级的汇编语言。</p>
</blockquote>
<p>函数是一段代码，代码存在内存中，我们可以用指针访问内存，所以函数指针是可行的。对于函数指针，是可以讲很多的，但是因为我不会，所以就不讲了。</p>
<p>对于函数指针的声明，虽然有<strong>经典的一层一层分析</strong>，但是我不会写，所以就记一下好了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//函数返回值类型 (* 指针变量名) (函数参数列表);</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">// fp 是函数指针，第一个参数的类型是 int，第二个参数的类型是 double</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fpArray<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// fpArray 是函数指针数组</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>对于函数指针的赋值，我也打算记一下就好了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">fp <span class="token operator">=</span> <span class="token operator">&amp;</span>f<span class="token punctuation">;</span>
fp <span class="token operator">=</span> f<span class="token punctuation">;</span> 	<span class="token comment">// 两种写法都可以</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对于函数指针的使用</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fp</span><span class="token punctuation">(</span>ab<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 同样两种都可以</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后来看这个宏</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* private variable */</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> theFatalMsg<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"fatal error in lp_Print!"</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">OUTPUT</span><span class="token expression"><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> s<span class="token punctuation">,</span> l<span class="token punctuation">)</span>                                                     	</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">{</span>                                                                         	</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">&gt;</span> LP_MAX_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>                                  	\                       </span></span>
		<span class="token punctuation">{</span>                                                                 		\
			<span class="token punctuation">(</span><span class="token operator">*</span>output<span class="token punctuation">)</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>theFatalMsg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>theFatalMsg<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		\
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                           \
		<span class="token punctuation">}</span>                                                                 		\
		<span class="token keyword">else</span> 																	\ 
		<span class="token punctuation">{</span>                                                                     	\
			<span class="token punctuation">(</span><span class="token operator">*</span>output<span class="token punctuation">)</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> s<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>                                             	\
		<span class="token punctuation">}</span>                                                                     	\
	<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个宏其实就是用来输出的，这个宏的三个参数就是 <code>myoutput</code> 的三个参数。我们看到在 <code>if</code> 中首先看到的是错误输出语句，就是输出那句 <code>fatal error in lp_Print!</code> 。在 <code>else</code> 中才是正确语句。</p>
<h4 id="PrintChar"><a href="#PrintChar" class="headerlink" title="PrintChar()"></a>PrintChar()</h4><p>首先是 <code>PrintChar</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">PrintChar</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> ladjust<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
		length <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ladjust<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token operator">*</span>buf <span class="token operator">=</span> c<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
		buf<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> length<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出，他大概会往 buf 中写入 <code>_______C</code> 或者 <code>c_______</code> （下划线是空格的意思）这样的东西 ，这个写入字符串中的字符由参数 <code>c</code> 控制，字符串的长度由参数 <code>length</code> 控制，决定是空格在前还是在后，由 <code>ladjust</code> 控制。</p>
<h4 id="PrintString"><a href="#PrintString" class="headerlink" title="PrintString()"></a>PrintString()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">PrintString</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> ladjust<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> s<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>s1<span class="token operator">++</span><span class="token punctuation">)</span>
		len<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> len<span class="token punctuation">)</span>
		length <span class="token operator">=</span> len<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ladjust<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> len<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> length <span class="token operator">-</span> len<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>i <span class="token operator">-</span> length <span class="token operator">+</span> len<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> length<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个函数实现的功能就是把字符串 <code>s</code> 中内容拷贝到 <code>buf</code> 中。同样涉及到一个左对齐还是右对齐的问题，如果 <code>ladjust</code>（left-adjust）大于零，那就进行左对齐，否则右对齐，里面引入了一个 <code>len</code> 就是为了实现这个功能（对齐补空格）。</p>
<h4 id="PrintNum"><a href="#PrintNum" class="headerlink" title="PrintNum()"></a>PrintNum()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">PrintNum</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> u<span class="token punctuation">,</span> <span class="token keyword">int</span> base<span class="token punctuation">,</span> <span class="token keyword">int</span> negFlag<span class="token punctuation">,</span>
			 <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> ladjust<span class="token punctuation">,</span> <span class="token keyword">char</span> padc<span class="token punctuation">,</span> <span class="token keyword">int</span> upcase<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">/* algorithm :
     *  1. prints the number from left to right in reverse form.
     *  2. fill the remaining spaces with padc if length is longer than
     *     the actual length
     *     TRICKY : if left adjusted, no "0" padding.
     *		    if negtive, insert  "0" padding between "0" and number.
     *  3. if (!ladjust) we reverse the whole string including paddings
     *  4. otherwise we only reverse the actual string representing the num.
     */</span>

	<span class="token keyword">int</span> actualLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> buf<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token keyword">do</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">int</span> tmp <span class="token operator">=</span> u <span class="token operator">%</span> base<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">+</span> tmp<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>upcase<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'A'</span> <span class="token operator">+</span> tmp <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			<span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">+</span> tmp <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		u <span class="token operator">/=</span> base<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>negFlag<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* figure out actual length and adjust the maximum length */</span>
	actualLength <span class="token operator">=</span> p <span class="token operator">-</span> buf<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> actualLength<span class="token punctuation">)</span>
		length <span class="token operator">=</span> actualLength<span class="token punctuation">;</span>

	<span class="token comment">/* add padding */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ladjust<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		padc <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>negFlag <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ladjust <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>padc <span class="token operator">==</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> actualLength <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> padc<span class="token punctuation">;</span>
		buf<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> actualLength<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> padc<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* prepare to reverse the string */</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">int</span> begin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> end<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ladjust<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			end <span class="token operator">=</span> actualLength <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			end <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span>end <span class="token operator">&gt;</span> begin<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">char</span> tmp <span class="token operator">=</span> buf<span class="token punctuation">[</span>begin<span class="token punctuation">]</span><span class="token punctuation">;</span>
			buf<span class="token punctuation">[</span>begin<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">[</span>end<span class="token punctuation">]</span><span class="token punctuation">;</span>
			buf<span class="token punctuation">[</span>end<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
			begin<span class="token operator">++</span><span class="token punctuation">;</span>
			end<span class="token operator">--</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* adjust the string pointer */</span>
	<span class="token keyword">return</span> length<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是把一个数拷贝到 <code>buf</code> 中，相当于<strong>将数字转换成字符串</strong>。我们可以指定基数，还可以指定对齐方式和前导零问题。但是就跟我们在程设中遇到的一样，是需要调转字符串的。</p>
<h4 id="lp-Print"><a href="#lp-Print" class="headerlink" title="lp_Print()"></a>lp_Print()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">lp_Print</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>output<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			  <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
			  <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span>
			  va_list ap<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span>LP_MAX_BUF<span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> c<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span>

	<span class="token keyword">int</span> longFlag<span class="token punctuation">;</span>
	<span class="token keyword">int</span> negFlag<span class="token punctuation">;</span>
	<span class="token keyword">int</span> width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> prec<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ladjust<span class="token punctuation">;</span>
	<span class="token keyword">char</span> padc<span class="token punctuation">;</span>

	<span class="token keyword">int</span> length<span class="token punctuation">;</span>

	<span class="token comment">/* special termination call */</span>
	<span class="token function">OUTPUT</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"\0"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实我们实现的最重要功能不是<strong>打印字符串</strong>，这个功能是很好实现的。我们实现的最重要功能是<strong>格式化输出</strong>，这个功能才是实现的需求，也是难点，所以格式符形式</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">%</span><span class="token punctuation">[</span>flags<span class="token punctuation">]</span><span class="token punctuation">[</span>width<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span>precision<span class="token punctuation">]</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span>specifier<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>只要了解就可以了。</p>
<hr>
<h2 id="tools"><a href="#tools" class="headerlink" title="tools/"></a>tools/</h2><h3 id="scse0-3-lds"><a href="#scse0-3-lds" class="headerlink" title="scse0_3.lds"></a>scse0_3.lds</h3><p>这个链接脚本还是十分重要的。</p>
<p>首先它规定了内核程序的入口函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">ENTRY</span><span class="token punctuation">(</span>_start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其次，它规定了内核程序在虚拟地址空间中的分布</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SECTIONS
<span class="token punctuation">{</span>
  <span class="token builtin class-name">.</span> <span class="token operator">=</span> 0x80010000<span class="token punctuation">;</span>
  .text <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    *<span class="token punctuation">(</span>.int<span class="token punctuation">)</span>
	*<span class="token punctuation">(</span>.text<span class="token punctuation">)</span>
	*<span class="token punctuation">(</span>.fini<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
  .data <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
	*<span class="token punctuation">(</span>.data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  .bss  <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
	*<span class="token punctuation">(</span>.bss<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  .sdata <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    *<span class="token punctuation">(</span>.sdata<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token builtin class-name">.</span> <span class="token operator">=</span> 0x80400000<span class="token punctuation">;</span>
  end <span class="token operator">=</span> <span class="token builtin class-name">.</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以根据这个画出一幅图来</p>
<p><img src="/posts/597dbeba/kseg0.drawio.png" alt="kseg0.drawio"></p>
<p>这个 end 指针会在分配虚拟内存空间的时候用到，这并不奇怪，因为 end 指针刚好是初始化结束后内核栈的栈顶，而内核栈是向下增长的。</p>
<hr>
<h2 id="drivers"><a href="#drivers" class="headerlink" title="drivers/"></a>drivers/</h2><h3 id="dev-cons-h"><a href="#dev-cons-h" class="headerlink" title="dev_cons.h"></a>dev_cons.h</h3><p><code>dev_cons.h</code> 中定义了一些外设虚拟地址常量，这些常量会在 <code>console.c</code> 中被用到（从注释角度来看，应该是不止这个文件会用到），下面是源代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span>	<span class="token expression">TESTMACHINE_CONS_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">TESTMACHINE_CONS_H</span></span>

<span class="token comment">/*
 *  Definitions used by the "cons" device in GXemul.
 *
 *  $Id: dev_cons.h,v 1.2 2006/07/05 05:38:36 debug Exp $
 *  This file is in the public domain.
 */</span>


<span class="token comment">//#define	DEV_CONS_ADDRESS		0x180003f8</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	    <span class="token macro-name">DEV_CONS_ADDRESS</span>		<span class="token expression"><span class="token number">0x10000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	    <span class="token macro-name">DEV_CONS_LENGTH</span>			<span class="token expression"><span class="token number">0x0000000000000020</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	    <span class="token macro-name">DEV_CONS_PUTGETCHAR</span>		<span class="token expression"><span class="token number">0x0000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	    <span class="token macro-name">DEV_CONS_HALT</span>		    <span class="token expression"><span class="token number">0x0010</span></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>	<span class="token comment">/*  TESTMACHINE_CONS_H  */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="console-c"><a href="#console-c" class="headerlink" title="console.c"></a>console.c</h3><h4 id="address-macro"><a href="#address-macro" class="headerlink" title="address macro"></a>address macro</h4><p>从这三个宏（以及上面那个头文件中的宏），我们可以得出 <code>PUTCHAR_ADDRESS</code> 的值是 <code>0xB000_000</code>，<code>HALT_ADDRESS</code> 的值是 <code>0xB000_0010</code>。他们都是虚拟地址。这个地址是很符合常理的，因为这俩地址都属于 kseg1，是留给外设的。唯一需要吐槽的就是 <code>PHYSADDR_OFFSET</code> 这个名字是错的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">PHYSADDR_OFFSET</span>		<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0xA0000000</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">PUTCHAR_ADDRESS</span>		<span class="token expression"><span class="token punctuation">(</span>PHYSADDR_OFFSET <span class="token operator">+</span> DEV_CONS_ADDRESS <span class="token operator">+</span> DEV_CONS_PUTGETCHAR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">HALT_ADDRESS</span>		<span class="token expression"><span class="token punctuation">(</span>PHYSADDR_OFFSET <span class="token operator">+</span> DEV_CONS_ADDRESS <span class="token operator">+</span> DEV_CONS_HALT<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="putcharc"><a href="#putcharc" class="headerlink" title="putcharc()"></a>putcharc()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">printcharc</span><span class="token punctuation">(</span><span class="token keyword">char</span> ch<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> PUTCHAR_ADDRESS<span class="token punctuation">)</span> <span class="token operator">=</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>前面的 <code>volatile</code> 是一个关键字，它提醒编译器它后面所定义的变量随时都有可能改变，因此编译后的程序每次需要存储或读取这个变量的时候，都会直接从变量地址中读取数据。如果没有volatile关键字，则编译器可能优化读取和存储，可能暂时使用寄存器中的值，如果这个变量由别的程序更新了的话，将出现不一致的现象。</p>
<p>然后我们看出就是它往内存中某个特定地址中写了一个字符，这个内存刚好对应外设，所以可以在屏幕上输出（或者其他的，我不清楚具体哪个外设）。</p>
<h4 id="halt"><a href="#halt" class="headerlink" title="halt()"></a>halt()</h4><p><code>halt</code> 函数也类似，都是往一个特殊的地址中写了个数据，作用是使程序终止。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">halt</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> HALT_ADDRESS<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="printstr"><a href="#printstr" class="headerlink" title="printstr()"></a>printstr()</h4><p><code>printstr</code> 就是连续调用 <code>printcharc</code> </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">printstr</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
		<span class="token function">printcharc</span><span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/S4%E8%AF%BE%E4%B8%8A/" rel="tag"><i class="fa fa-tag"></i> S4课上</a>
              <a href="/tags/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" rel="tag"><i class="fa fa-tag"></i> 知识总结</a>
              <a href="/tags/%E7%9B%B4%E8%A7%82%E7%90%86%E8%A7%A3/" rel="tag"><i class="fa fa-tag"></i> 直观理解</a>
              <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="fa fa-tag"></i> 操作系统</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/92de1690/" rel="prev" title="操作系统-内存管理">
      <i class="fa fa-chevron-left"></i> 操作系统-内存管理
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/b1ba6344/" rel="next" title="吃喝玩乐-爱德华八世">
      吃喝玩乐-爱德华八世 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
<script src="https://utteranc.es/client.js"
        repo="Thysrael/blog-comment"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MOS-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="nav-text">MOS 源码解读</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#boot"><span class="nav-text">boot&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#start-S"><span class="nav-text">start.S</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#data"><span class="nav-text">.data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#start"><span class="nav-text">_start()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#init"><span class="nav-text">init&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-c"><span class="nav-text">main.c</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main"><span class="nav-text">main()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init-c"><span class="nav-text">init.c</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mips-init"><span class="nav-text">mips_init()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bcopy"><span class="nav-text">bcopy()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bzero"><span class="nav-text">bzero()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#include"><span class="nav-text">include&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#types-h"><span class="nav-text">types.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#typedef"><span class="nav-text">typedef</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MIN"><span class="nav-text">MIN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ROUND-ROUNDDOWN"><span class="nav-text">ROUND, ROUNDDOWN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#offsetof"><span class="nav-text">offsetof</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#static-assert"><span class="nav-text">static_assert</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mmu-h"><span class="nav-text">mmu.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Memory-Constant"><span class="nav-text">Memory Constant</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Index"><span class="nav-text">Index</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PTE"><span class="nav-text">PTE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Virtual-Space-Constant"><span class="nav-text">Virtual Space Constant</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Address-translate"><span class="nav-text">Address translate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#queue-h"><span class="nav-text">queue.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#List-Declare"><span class="nav-text">List Declare</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#List-Find"><span class="nav-text">List Find</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#List-Operate"><span class="nav-text">List Operate</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pmap-h"><span class="nav-text">pmap.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Page"><span class="nav-text">Page</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Map"><span class="nav-text">Map</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#printf-h"><span class="nav-text">printf.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#panic"><span class="nav-text">panic</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#asm-h"><span class="nav-text">asm.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#stack-frame"><span class="nav-text">stack frame</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#function-declare"><span class="nav-text">function declare</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#export"><span class="nav-text">export</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cp0regdef-h"><span class="nav-text">cp0regdef.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CP0reg-Declare"><span class="nav-text">CP0reg Declare</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SR-flags"><span class="nav-text">SR flags</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#regdef-h"><span class="nav-text">regdef.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#regdef"><span class="nav-text">regdef</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stackframe-h"><span class="nav-text">stackframe.h</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Set-Interupt"><span class="nav-text">Set Interupt</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Save-and-Restore"><span class="nav-text">Save and Restore</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mm"><span class="nav-text">mm&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pmap-c"><span class="nav-text">pmap.c</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mips-detect-memory"><span class="nav-text">mips_detect_memory()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#alloc"><span class="nav-text">alloc()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mips-vm-init"><span class="nav-text">mips_vm_init()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#page-init"><span class="nav-text">page_init()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#page-alloc"><span class="nav-text">page_alloc()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#page-free"><span class="nav-text">page_free()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boot-map-segment"><span class="nav-text">boot_map_segment()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boot-pgdir-walk"><span class="nav-text">boot_pgdir_walk()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pgdir-walk"><span class="nav-text">pgdir_walk()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#page-lookup"><span class="nav-text">page_lookup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tlb-invalidate"><span class="nav-text">tlb_invalidate()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#page-remove"><span class="nav-text">page_remove()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#page-decref"><span class="nav-text">page_decref()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#page-insert"><span class="nav-text">page_insert()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#page-out"><span class="nav-text">page_out()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tlb-asm-S"><span class="nav-text">tlb_asm.S</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tlb-out"><span class="nav-text">tlb_out()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lib"><span class="nav-text">lib&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#genex-S"><span class="nav-text">genex.S</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BUILD-HANDLER"><span class="nav-text">BUILD_HANDLER</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#do-refill"><span class="nav-text">do_refill()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#printf-c"><span class="nav-text">printf.c</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#myoutput"><span class="nav-text">myoutput()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#printf"><span class="nav-text">printf()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#panic-1"><span class="nav-text">_panic()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#print-c"><span class="nav-text">print.c</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OUTPUT"><span class="nav-text">OUTPUT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PrintChar"><span class="nav-text">PrintChar()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PrintString"><span class="nav-text">PrintString()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PrintNum"><span class="nav-text">PrintNum()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lp-Print"><span class="nav-text">lp_Print()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tools"><span class="nav-text">tools&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#scse0-3-lds"><span class="nav-text">scse0_3.lds</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#drivers"><span class="nav-text">drivers&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dev-cons-h"><span class="nav-text">dev_cons.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#console-c"><span class="nav-text">console.c</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#address-macro"><span class="nav-text">address macro</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#putcharc"><span class="nav-text">putcharc()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#halt"><span class="nav-text">halt()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#printstr"><span class="nav-text">printstr()</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Thysrael"
      src="/images/avatar2.png">
  <p class="site-author-name" itemprop="name">Thysrael</p>
  <div class="site-description" itemprop="description">Can you hear me ?</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">198</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">69</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="">
    <a target="_blank" class="social-link" href="/atom.xml" style="color: burlywood;">
      <span class="icon">
        <i class="fa fa-rss"></i>
      </span>
      <span class="label">RSS</span>
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/thysrael" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;thysrael" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:thysrael@163.com" title="E-Mail → mailto:thysrael@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021.12.18 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thysrael</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">20:04</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
