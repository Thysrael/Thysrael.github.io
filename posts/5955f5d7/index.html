<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-wall.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-wall.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-jsxllPgZAX">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic|JetBrains Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"thysrael.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一、个人感受1.1 权衡在我写这份报告的时候，已经是 6 月 30 号了，经历了一个学期的“折磨”，我面对终点，已经没啥感觉了，就想着赶快呼噜完了就完事了。其实做这个项目最大的体会就是“人力有穷，一切皆权衡”。我当时选择这个项目，其实就两个原因：  做出来贼装逼 据说可以从中体会很多知识  现在看来，确实这两点都达到了，对于装逼层面而言，确实只要跟人提起“我是做移植操作系统”的，基本上就没人可以在">
<meta property="og:type" content="article">
<meta property="og:title" content="操作系统-AOSOA">
<meta property="og:url" content="https://thysrael.github.io/posts/5955f5d7/index.html">
<meta property="og:site_name" content="钟鼓楼">
<meta property="og:description" content="一、个人感受1.1 权衡在我写这份报告的时候，已经是 6 月 30 号了，经历了一个学期的“折磨”，我面对终点，已经没啥感觉了，就想着赶快呼噜完了就完事了。其实做这个项目最大的体会就是“人力有穷，一切皆权衡”。我当时选择这个项目，其实就两个原因：  做出来贼装逼 据说可以从中体会很多知识  现在看来，确实这两点都达到了，对于装逼层面而言，确实只要跟人提起“我是做移植操作系统”的，基本上就没人可以在">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://thysrael.github.io/posts/5955f5d7/image-20220722173841563.png">
<meta property="og:image" content="https://thysrael.github.io/posts/5955f5d7/image-20220704012304596.png">
<meta property="og:image" content="https://thysrael.github.io/posts/5955f5d7/image-20220704012312475.png">
<meta property="og:image" content="https://thysrael.github.io/posts/5955f5d7/image-20220704012243222.png">
<meta property="article:published_time" content="2022-07-03T17:12:11.000Z">
<meta property="article:modified_time" content="2025-08-15T12:16:48.805Z">
<meta property="article:author" content="Thysrael">
<meta property="article:tag" content="S4课上">
<meta property="article:tag" content="知识总结">
<meta property="article:tag" content="操作系统">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://thysrael.github.io/posts/5955f5d7/image-20220722173841563.png">

<link rel="canonical" href="https://thysrael.github.io/posts/5955f5d7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>操作系统-AOSOA | 钟鼓楼</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="钟鼓楼" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/thysrael" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">钟鼓楼</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">钟楼瘦，鼓楼胖</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">31</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">70</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">199</span></a>

  </li>
        <li class="menu-item menu-item-resource">

    <a href="/resource/" rel="section"><i class="fa fa-book fa-fw"></i>Resource</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>Links</a>

  </li>
        <li class="menu-item menu-item-roam">

    <a href="/obsidian-quartz/" rel="section"><i class="fa fa-sitemap fa-fw"></i>Roam</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thysrael.github.io/posts/5955f5d7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.png">
      <meta itemprop="name" content="Thysrael">
      <meta itemprop="description" content="Can you hear me ?">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="钟鼓楼">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          操作系统-AOSOA
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-04 01:12:11" itemprop="dateCreated datePublished" datetime="2022-07-04T01:12:11+08:00">2022-07-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-15 20:16:48" itemprop="dateModified" datetime="2025-08-15T20:16:48+08:00">2025-08-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>22 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="一、个人感受"><a href="#一、个人感受" class="headerlink" title="一、个人感受"></a>一、个人感受</h2><h3 id="1-1-权衡"><a href="#1-1-权衡" class="headerlink" title="1.1 权衡"></a>1.1 权衡</h3><p>在我写这份报告的时候，已经是 6 月 30 号了，经历了一个学期的“折磨”，我面对终点，已经没啥感觉了，就想着赶快呼噜完了就完事了。其实做这个项目最大的体会就是“人力有穷，一切皆权衡”。我当时选择这个项目，其实就两个原因：</p>
<ul>
<li>做出来贼装逼</li>
<li>据说可以从中体会很多知识</li>
</ul>
<p>现在看来，确实这两点都达到了，对于装逼层面而言，确实只要跟人提起“我是做移植操作系统”的，基本上就没人可以在装逼方面压过你了。从中学到的知识也是很多很丰富的，可以说指导书许诺的东西，我已经拿到了，但是我从来没有想过，我会付出以下代价：</p>
<ul>
<li>用在其他课业上面的时间会很少，分数可能会下降</li>
<li>每个月都有那么几天被程序折磨的情绪失常</li>
<li>编译比赛没办法从头到尾投入</li>
<li>每天活在完成不了挑战性任务的恐惧里</li>
<li>经常睡不着或者睡不了</li>
<li>陪不了女朋友</li>
</ul>
<p>当然很多情况都是因为我个人原因导致的，可能我再聪明一点，再勤奋一点，再坚强一点，可能这些问题都不会发生。或者再大气一点，发生了这些问题之后并不彷徨。不过我觉得哈，其实这个时候统计规律最说明一切了，从身边统计学来看，在移植操作系统任务下达后，我身边几乎每个人都摩拳擦掌，跃跃欲试，然后大概过了一个月，真正想做的人我认识的还剩下 10 个，当然跟我认识的人不多有关。到现在，从助教哥哥处获得的消息，整个 6 系和 21 系，进行 armv8 移植的人可能只有我和哲哥了（当然也有可能有大佬全程没问助教）。从这些数据可以看出，放弃才是常态，而且是一种很理智的选择。</p>
<p>在我打算介绍具体的知识和实验经过之前，我选择先写下这些话，虽然有一部分是矫情，但是更多的是，我意识到，最难解决的 bug 不在电脑上，而是在心态上。有的时候再坚持一下，再多做一个测试，再多想一种可能，再多问一个人，或许就 de 出来了。但是真的完全就不想再动了，因为自己内心知道自己就算做出来了，也是得不偿失的，就很难下笔了。</p>
<h3 id="1-2-无问西东"><a href="#1-2-无问西东" class="headerlink" title="1.2 无问西东"></a>1.2 无问西东</h3><p>这是哲哥教给我的，就是即使像上面说的一样，是一件很得不偿失的事情。但是是我觉得很多事情不能太计较利益得失，斤斤计较就让生活变得没意思的。就好像我跑步一样，没人逼我跑，我也不求跑得比谁快，我就是享受跑步那种感觉。移植操作系统我就不是很这样，我很担心，很害怕，没写的时候害怕，写了也害怕，写完 lab1 害怕，写完 lab2 也害怕。但是哲哥就很淡然，就感觉他是真的享受整个过程，他从不担心结果如何，他就很享受。</p>
<h3 id="1-3-移植概述"><a href="#1-3-移植概述" class="headerlink" title="1.3 移植概述"></a>1.3 移植概述</h3><p>移植其实就是解决一系列 ABI 的问题。我们之前的的操作系统是建立在 mips 处理器上的，现在我们要把它移植到armv8 上，所以很多与硬件接壤的地方都需要有改动。这里粗浅的罗列一下，详细内容会在后面介绍</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>lab</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>lab0</td>
<td>新的交叉编译器的使用</td>
</tr>
<tr>
<td>lab1</td>
<td>汇编的学习，arm 的异常处理等级</td>
</tr>
<tr>
<td>lab2</td>
<td>arm 的mmu和硬件三级页表查询方式（万恶之源）</td>
</tr>
<tr>
<td>lab3</td>
<td>arm 的异常处理</td>
</tr>
<tr>
<td>lab4</td>
<td>用软件实现 COW 和 Library 机制</td>
</tr>
<tr>
<td>lab5</td>
<td>SD 的读写</td>
</tr>
<tr>
<td>lab6</td>
<td>armv8 的压栈方式</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h2 id="二、Aarch64-汇编"><a href="#二、Aarch64-汇编" class="headerlink" title="二、Aarch64 汇编"></a>二、Aarch64 汇编</h2><h3 id="2-1-学习资料"><a href="#2-1-学习资料" class="headerlink" title="2.1 学习资料"></a>2.1 学习资料</h3><p>这里简要介绍一下。我们使用的是 armv8 的 A64 指令集（Aarch64 叫执行模式，总是就是一种 64 位的东西），是一种 64 位的指令集（armv8 还支持其他的模式，比如 32 位的 A32）。</p>
<p>汇编学习官方提供的就是文档，但是众所周知，文档太难了。所以这里安利这本书，可以对于汇编还有异常处理体系有一个初步的了解。如下</p>
<p><img src="/posts/5955f5d7/image-20220722173841563.png" alt="image-20220722173841563"></p>
<h3 id="2-2-寄存器"><a href="#2-2-寄存器" class="headerlink" title="2.2 寄存器"></a>2.2 寄存器</h3><h4 id="2-2-1-通用寄存器"><a href="#2-2-1-通用寄存器" class="headerlink" title="2.2.1 通用寄存器"></a>2.2.1 通用寄存器</h4><h5 id="2-2-1-1-函数-ABI"><a href="#2-2-1-1-函数-ABI" class="headerlink" title="2.2.1.1 函数 ABI"></a>2.2.1.1 函数 ABI</h5><p>通用寄存器 x0 ~ x7 是传参寄存器，只要函数的参数少于等于 8 个，那么都会通过这些这些寄存器来传递，第一个参数会被写入 x0，第二个参数写入 x1，以此类推。</p>
<p>同时，对于返回值，我们也是存储在 x0 中的，也就是说，x0 在函数中有两个作用，一个是传递第一个参数，一个是传递返回值。</p>
<p>对于函数的返回地址会存在 x30 中，类似与 mips 中的 ra。</p>
<h5 id="2-2-1-2-异常处理寄存器"><a href="#2-2-1-2-异常处理寄存器" class="headerlink" title="2.2.1.2 异常处理寄存器"></a>2.2.1.2 异常处理寄存器</h5><p>arm 中的 x16 和 x17 类似于 mips 中的 k0 和 k1。都可以被利用为异常处理寄存器（就是在异常处理中可劲造，不用担心）。</p>
<h5 id="2-2-1-3-调用者保存和被调用者保存"><a href="#2-2-1-3-调用者保存和被调用者保存" class="headerlink" title="2.2.1.3 调用者保存和被调用者保存"></a>2.2.1.3 调用者保存和被调用者保存</h5><p><code>X9 ~ X15</code> 是调用者保存寄存器，所以需要调用者进行保存和恢复，类似于 <code>MIPS</code> 中的 <code>t</code> 寄存器。</p>
<p><code>X19 ~ X29</code> 是被调用者保存寄存器，所以需要被调用者进行保存和恢复，类似于 <code>MIPS</code> 中的 <code>s</code> 寄存器。</p>
<h4 id="2-2-2-特殊寄存器"><a href="#2-2-2-特殊寄存器" class="headerlink" title="2.2.2 特殊寄存器"></a>2.2.2 特殊寄存器</h4><h5 id="2-2-2-1-零寄存器"><a href="#2-2-2-1-零寄存器" class="headerlink" title="2.2.2.1 零寄存器"></a>2.2.2.1 零寄存器</h5><p>xzr 是 64 位的零寄存器。</p>
<h5 id="2-2-2-2-pc"><a href="#2-2-2-2-pc" class="headerlink" title="2.2.2.2 pc"></a>2.2.2.2 pc</h5><p>就是 pc，但是对于我们的实验没啥用，因为我们没有指令可以读写这个寄存器。</p>
<h5 id="2-2-2-3-sp"><a href="#2-2-2-3-sp" class="headerlink" title="2.2.2.3 sp"></a>2.2.2.3 sp</h5><p>栈指针寄存器，与 mips 不同的是，这个有很多个这样的栈指针，比如 <code>sp_el0, sp_el1....</code> 。也就是说在 EL0 （用户态）的时候的栈指针使用的是 <code>sp_el0</code> ，EL1 （内核态）使用的栈指针是  <code>sp_el1</code>。这其实对应了用户态和内核态的使用的栈是不同的。</p>
<h5 id="2-2-2-4-elr"><a href="#2-2-2-4-elr" class="headerlink" title="2.2.2.4 elr"></a>2.2.2.4 elr</h5><p>存放返回地址，类似于 mips 中的 epc</p>
<h5 id="2-2-2-5-CurrentEL"><a href="#2-2-2-5-CurrentEL" class="headerlink" title="2.2.2.5 CurrentEL"></a>2.2.2.5 CurrentEL</h5><p>可以查看当前的异常等级。</p>
<h4 id="2-2-3-系统寄存器"><a href="#2-2-3-系统寄存器" class="headerlink" title="2.2.3 系统寄存器"></a>2.2.3 系统寄存器</h4><h5 id="2-2-3-1-SCR"><a href="#2-2-3-1-SCR" class="headerlink" title="2.2.3.1 SCR"></a>2.2.3.1 SCR</h5><p>异常等级为 3 的时候的配置寄存器，具体的参数如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 这位与安全内存有关，但是我不知道啥意思</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCR_NS</span>              <span class="token expression"><span class="token number">1</span></span></span>
<span class="token comment">// 这位置 1 说明是 Arch64 而置 0 说明是 Arch32</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCR_RW</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>更加详细的可以参照白书的 P144 页。</p>
<h5 id="2-2-3-2-HCR"><a href="#2-2-3-2-HCR" class="headerlink" title="2.2.3.2 HCR"></a>2.2.3.2 HCR</h5><p>异常等级为 2 的时候的配置寄存器，具体参数如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HCR_RW</span>              <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// SWIO hardwired on Pi3, 我不知达到哦啥意思</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HCR_SWIO</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>更加详细的可以参照白书的 P144 页。</p>
<h5 id="2-2-3-3-SPSR"><a href="#2-2-3-3-SPSR" class="headerlink" title="2.2.3.3 SPSR"></a>2.2.3.3 SPSR</h5><p><strong>Saved Process Status Register</strong>。armv8 应该会维护一个状态寄存器 PSTATE ，当发生异常的时候，会把状态寄存器的值存储到 SPSR 当中。当异常返回的时候，会把 SPSR 的值拷贝到 PSTATE 中。我个人感觉已经可以把二者划等号了。</p>
<p>具体参数如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 对应 [9:6] DAIF 意思是关闭中断</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPSR_MASK_ALL</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// 对应 [3:0] 设置异常返回哪一个等级，我不知道具体的对应规则</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPSR_EL2H</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPSR_EL1H</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另外可以分开访问，比如说 <code>daifset</code> 指的就是 SPSR 的 <code>[9:6]</code> 位。</p>
<h5 id="2-2-3-4-SCTLR"><a href="#2-2-3-4-SCTLR" class="headerlink" title="2.2.3.4 SCTLR"></a>2.2.3.4 SCTLR</h5><p>系统控制寄存器，指导书给出了完整配置。</p>
<h5 id="2-2-3-5-TCR"><a href="#2-2-3-5-TCR" class="headerlink" title="2.2.3.5 TCR"></a>2.2.3.5 TCR</h5><p><strong>Translation Control Register</strong> 翻译控制寄存器，用于控制 TLB 的行为。具体的配置如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_IGNORE1</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">38</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_IGNORE0</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">37</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// 内部共享 TTBR1_EL1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_ISH1</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// 内部共享 TTBR0_EL1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_ISH0</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// TTBR1_EL1 外写通达可缓存</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_OWT</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// TTBR1_EL1 内写通达可缓存</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_IWT</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// 25 位掩码</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_T0SZ</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_T1SZ</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">25</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// TG2 的页面是 4K</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_TG0_4K</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// TG1 的页面是 4K</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCR_TG1_4K</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="2-2-3-6-TTBR"><a href="#2-2-3-6-TTBR" class="headerlink" title="2.2.3.6 TTBR"></a>2.2.3.6 TTBR</h5><p>一级页表的起始地址存储在这里。需要注意是物理地址。</p>
<h5 id="2-2-3-7-FAR"><a href="#2-2-3-7-FAR" class="headerlink" title="2.2.3.7 FAR"></a>2.2.3.7 FAR</h5><p>far 寄存器里存的就是 BADDR。</p>
<h5 id="2-2-3-8-ESR"><a href="#2-2-3-8-ESR" class="headerlink" title="2.2.3.8 ESR"></a>2.2.3.8 ESR</h5><p>esr 寄存器就是同步异常的错误原因，类似与 MOS 中的 Cause。可以在 P150 查到。</p>
<h3 id="2-3-汇编指令"><a href="#2-3-汇编指令" class="headerlink" title="2.3 汇编指令"></a>2.3 汇编指令</h3><p>这个部分非常的冗杂，但是我觉得只需要记住两点，就可以轻松解决</p>
<ul>
<li>看白书，书上介绍的很详细</li>
<li>用的时候查，不需要啥都会</li>
</ul>
<p>这里总结一下用到的指令 <code>ldr, str, msr, mrs, orr, and, cmp, bne, adr, eret, bl, b, br, lsr</code> 等，基本上跟机组的 P7 的量差不多。</p>
<h3 id="2-4-内联汇编"><a href="#2-4-内联汇编" class="headerlink" title="2.4 内联汇编"></a>2.4 内联汇编</h3><p>其实这个项目不用内联汇编也可以实现（我就没用），但是还是顺手学了一下，记录如下</p>
<p>这个函数将 <code>value</code> 的值加上 p 指向的值，并且将结果存储在 result 中</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">my_add</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> val<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> tmp<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>
    <span class="token keyword">asm</span> <span class="token keyword">volatile</span>
    <span class="token punctuation">{</span>
        <span class="token string">"1: ldxr %0, [%2]\n"</span>
        <span class="token string">"add %0, %0, %3\n"</span>
        <span class="token string">"stxr %w1, %0, [%2]\n"</span>
        <span class="token string">"cbnz %w1, 1b\n"</span> 
        <span class="token operator">:</span> <span class="token string">"+r"</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"+r"</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token string">"r"</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token string">"cc"</span><span class="token punctuation">,</span> <span class="token string">"memory"</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先这个部分叫做指令部分，其实就是一条一条的汇编</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token string">"1: ldxr %0, [%2]\n"</span>
    <span class="token string">"add %0, %0, %3\n"</span>
    <span class="token string">"stxr %w1, %0, [%2]\n"</span>
    <span class="token string">"cbnz %w1, 1b\n"</span> 	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>会发现这些汇编里面有 <code>%0, %w1, %2</code> 这类的东西，这被称为样版操作数，其实就是 C 语言中变量的“化身”。</p>
<p>我们在下面这两个语句中声明这种样版关系</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">:</span> <span class="token string">"+r"</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"+r"</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> 	<span class="token comment">// output</span>
<span class="token operator">:</span> <span class="token string">"r"</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>			<span class="token comment">// input</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以看到这里出现了 C 语言的变量，<code>output</code> 代表要对变量进行写操作，而 <code>input</code> 表示只对变量进行读操作，其中就有 <code>tmp -&gt; %0, result -&gt; %1, p -&gt; %2, val -&gt; %3</code> 的对应关系。</p>
<p>至于 <code>"+r"</code> 就表示要关联一个可读可写的寄存器，而 <code>"=r"</code> 则表示一个只写的寄存器。之后类似</p>
<p>因为在这个函数中，我们修改了状态寄存器（通过 <code>cbnz</code> 指令），所以要在最后一个部分声明 <code>cc</code>，因为改变了内存，所以要声明 <code>memory</code> 这最后的部分叫做“损坏部分”，大致是为了维护寄存器不破坏原意形成的。</p>
<hr>
<h2 id="三、开发工具"><a href="#三、开发工具" class="headerlink" title="三、开发工具"></a>三、开发工具</h2><h3 id="3-1-manjaro"><a href="#3-1-manjaro" class="headerlink" title="3.1 manjaro"></a>3.1 manjaro</h3><p>这个必须要强调，真的是重中之重，因为没有有一个 Linux 的开发环境，就意味着你要使用虚拟机完成挑战性任务。咱不说这个意味着一般情况只能使用命令行，咱就说开发的时候能忍，但是读代码的时候呢？移植操作系统的很强调对于 MOS 源码的理解，我觉得只有像 vscode 这种工具才可以方便代码的阅读，vim 的局限性还是太大了一些（不排除大佬）。</p>
<p>本地开发也可以利用 manjaro + docker 实现，然后挑战性任务也可以在 manjaro 上做，而且之后学习也会用得到，我觉得是个很好的东西。</p>
<p>我第一次装 manjaro 是叶哥哥帮我装的，这个人号称 30 分钟结束战斗，然后花了 3 个小时，不过是真的强悍，100G 的 manjaro 陪伴了我这个学期。明天我就要卸掉它了，十分感慨。明天我要自己装一个，可能会写一个攻略。</p>
<h3 id="3-2-交叉编译器"><a href="#3-2-交叉编译器" class="headerlink" title="3.2 交叉编译器"></a>3.2 交叉编译器</h3><p>直接在应用商店就有装的，所以我也没上官网去看</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>条目</th>
<th>环境</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>交叉编译器</td>
<td>aarch64-none-elf-gcc</td>
<td>在应用市场下载安装</td>
</tr>
<tr>
<td>硬件模拟器</td>
<td>QEMU emulator version 5.0.0</td>
<td>命令行安装</td>
</tr>
<tr>
<td>编辑器</td>
<td>vscode</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h2 id="Lab-0"><a href="#Lab-0" class="headerlink" title="Lab 0"></a>Lab 0</h2><h3 id="manjaro"><a href="#manjaro" class="headerlink" title="manjaro"></a>manjaro</h3><p>虽然指导书说可以使用 WSL 或者其他的命令行界面进行项目开发，但是从我这个菜鸡的角度来看，如果没有 <code>vscode</code> ，我是不可能完成整个的移植操作系统开发的。而且为了装这个 manjaro，花费的时间要远远比装交叉编译器之类的东西要花的时间久（要是没有叶哥哥和哲哥的帮助，这步就卡死了）。不过自从装上之后，开发真的势如破竹。而且 OS 实验也可以本地开发了，堪称我这个学期做过作为明智的决定。</p>
<h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><div class="table-container">
<table>
<thead>
<tr>
<th>条目</th>
<th>环境</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>本机操作环境</td>
<td>manjaro</td>
<td></td>
</tr>
<tr>
<td>交叉编译器</td>
<td>aarch64-none-elf-gcc</td>
<td>在应用市场下载安装</td>
</tr>
<tr>
<td>硬件模拟器</td>
<td>QEMU emulator version 5.0.0</td>
<td>命令行安装</td>
</tr>
<tr>
<td>编辑器</td>
<td>vscode</td>
</tr>
</tbody>
</table>
</div>
<h3 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h3><p><strong>Linux Targeted 和 Bare-Metal 分别有怎样的含义呢?</strong></p>
<p>这说的是交叉编译器的两种模式，Bare-Metal 是裸机模式（这里不会）</p>
<p><strong>大小端的差异是由什么决定的？</strong></p>
<p>大小端是 CPU 实现的访存接口限制，同时需要，编译器将高级的 C 语言编译成机器语言，在这过程中调整了大小端。</p>
<hr>
<h2 id="Lab-1"><a href="#Lab-1" class="headerlink" title="Lab 1"></a>Lab 1</h2><h3 id="内核编译运行"><a href="#内核编译运行" class="headerlink" title="内核编译运行"></a>内核编译运行</h3><p>内核的编译运行需要采用新的交叉编译器，可以采用 MOS 提供的方法，写一个 <code>include</code> 文件优化代码接口</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">// <span class="token keyword">include</span>.mk
CROSS_COMPILE   <span class="token operator">:=</span> aarch64-none-elf-
CC              <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>CROSS_COMPILE<span class="token punctuation">)</span>gcc
CFLAGS          <span class="token operator">:=</span> -Wall -ffreestanding -g
LD              <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>CROSS_COMPILE<span class="token punctuation">)</span>ld
<span class="token comment"># OC is used to transfer the file from one format to another format</span>
<span class="token comment"># We use it to transfer the kernel from the elf to img</span>
OC				<span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>CROSS_COMPILE<span class="token punctuation">)</span>objcopy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要注意的是，<code>qemu</code> 模拟器需要烧录 <code>img</code> 文件，所以相比于 <code>gxemu</code> 的直接烧录 <code>.elf</code> 文件，需要利用 <code>objcopy</code> 工具将 <code>elf</code> 格式转换为 <code>img</code> 格式后完成烧录，语句如下</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">// MAKEFILE
<span class="token symbol">vmlinux</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>LD<span class="token punctuation">)</span> -o <span class="token variable">$</span><span class="token punctuation">(</span>vmlinux_elf<span class="token punctuation">)</span> -T <span class="token variable">$</span><span class="token punctuation">(</span>link_script<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span>
	<span class="token variable">$</span><span class="token punctuation">(</span>OC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>vmlinux_elf<span class="token punctuation">)</span> -O binary <span class="token variable">$</span><span class="token punctuation">(</span>vmlinux_img<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外，在之后的实践中，我发现将目标文件的符号表打印出来，可以方便定位 bug，故有了新的命令</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">// MAKEFILE
<span class="token symbol">all</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> vmlinux
	<span class="token variable">$</span><span class="token punctuation">(</span>CROSS_COMPILE<span class="token punctuation">)</span>objdump -alD <span class="token variable">$</span><span class="token punctuation">(</span>vmlinux_elf<span class="token punctuation">)</span> &gt; ./kernel.symbol<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="UART"><a href="#UART" class="headerlink" title="UART"></a>UART</h3><p>这里参考了指导书提供的方案，我把和GPIO相关的宏放到了<code>gpio.h</code> 中, UART 的宏定义和 uart 的函数放在 <code>uart.c</code> 中。最后也需要在模拟器中声明</p>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">// MAKEFILE
<span class="token symbol">run</span><span class="token punctuation">:</span>
	qemu-system-aarch64 -M raspi3 -serial null -serial stdio -kernel <span class="token variable">$</span><span class="token punctuation">(</span>vmlinux_img<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这里需要强调的是，因为没有开启 mmu 此时我的 <code>MMIOBASE</code> 是一个物理地址，在之后开启以后，需要修改到高地址区</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// old</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMIO_BASE</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x3F000000</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// new</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMIO_BASE</span>       <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x3F000000</span> <span class="token operator">+</span> <span class="token number">0xffffff8000000000</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="内核启动"><a href="#内核启动" class="headerlink" title="内核启动"></a>内核启动</h3><p>因为处理器有四个核，我们只需要一个核，所以首先先选出一个核进行运行（0 号核）</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.section ".text.boot"
_start:
	// X1 will store the ID of processor, different processor has different ID
    mrs     X1,			MPIDR_EL1
	and		X1,			X1,			#3
	// Only the processor who has the ID equals 0 can jump to the _start_master, others will wait
	cbz		X1,			_start_master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后进行异常等级的配置</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">_start_master:    
    // 从这里看异常等级，CurrentEL 的 [3:2] 是异常等级
    mrs     X0, 		CurrentEL
	and     X0, 		X0, 		#12 
    // 如果是 EL2 那么就会发生跳转
    cmp     X0, 		#12
    bne     judge_EL2
    // 下面是处理 EL3，但是这种情况一般不会发生
    // 异常处理路由指的是异常发生时应当在哪个异常等级处理，SCR_EL3 和 HCR_EL2 都相当于配置寄存器
    ldr     X2, 		=(SCR_VALUE)
    msr     scr_el3,	X2
    ldr     X2, 		=(SPSR_EL3_VALUE)
    msr     spsr_el3, 	X2
    adr     x2, 		judge_EL2
    msr     elr_el3, 	X2
    eret


judge_EL2:  
	// 如果是 EL1 就会发生跳转
    cmp     X0, 		#4
    beq     clear_bss
	// TODO 这里顺序
	adr     X1, 		_start
	msr     sp_el1, 	X1
    
    // 底下的寄存器在普通手册里没有，但在专有手册中有，也是设置，似乎不用看
	// disable coprocessor traps
    mov     X0,         #0x33FF
    msr     cptr_el2,   X0          //essential! give access to SIMD, see reference 1891
    msr     hstr_el2,   xzr         //seems not so useful. reference P1931
    mov     X0,         #0xf&lt;&lt;20    //essential! give access to SIMD,see reference 3808
    msr     cpacr_el1,  X0

    // 设置 HCR
    ldr 	X0,			=(HCR_VALUE)
    msr     hcr_el2, 	X0
    // 设置 SCTLR，但是此时没有开启 MMU
    ldr		X0,			=(SCTLR_VALUE)
    msr     sctlr_el1, 	X0
    
    ldr     X0, 		=(SPSR_EL2_VALUE)
    msr     spsr_el2, 	X0
    adr     X0, 		clear_bss
    msr     elr_el2, 	X0
    eret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在配置寄存器中，我们规定了 EL2 异常返回后会返回 EL1。然后配置完成后进行 <code>eret</code> 异常返回，返回 EL1 进行后续操作</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">clear_bss:
    adr     X1, 		__bss_start
    ldr     W2, 		=__bss_size
clear_loop:
	cbz     W2, 		en_mmu
    str     xzr, 		[X1], 			#8
    sub     W2, 		W2, 			#1
    cbnz    W2, 		clear_loop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后跳到主函数中即可。首先进行 <code>uart</code> 的初始化</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="链接脚本"><a href="#链接脚本" class="headerlink" title="链接脚本"></a>链接脚本</h3><p>经过文档查询，发现入口是 <code>.0x80000</code> 所以修改之后就可以运行</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// kernel.lds</span>
<span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token number">0x80000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="思考题-1"><a href="#思考题-1" class="headerlink" title="思考题"></a>思考题</h3><p><strong>我们的内核为什么从 EL3/EL2 异常级启动而不是 EL1 异常级启动?</strong></p>
<p>我觉得是因为安全性和配置性更高，在 EL2 可以对 EL1 的行为和权限进行配置，比如</p>
<blockquote>
<p>在EL1（EL0）状态的时候访问physical counter和timer有两种配置，一种是允许其访问，另外一种就是trap to EL2。</p>
</blockquote>
<hr>
<h2 id="Lab-2"><a href="#Lab-2" class="headerlink" title="Lab 2"></a>Lab 2</h2><h3 id="内存地址布局"><a href="#内存地址布局" class="headerlink" title="内存地址布局"></a>内存地址布局</h3><p>内核的地址布局：</p>
<p><img src="/posts/5955f5d7/image-20220704012304596.png" alt="image-20220704012304596"></p>
<p>用户进程的地址布局</p>
<p><img src="/posts/5955f5d7/image-20220704012312475.png" alt="image-20220704012312475"></p>
<h3 id="Arm-的地址映射与重定向"><a href="#Arm-的地址映射与重定向" class="headerlink" title="Arm 的地址映射与重定向"></a>Arm 的地址映射与重定向</h3><p>与 MOS 在高地址区提供直接映射不同，Arm 并不提供直接的虚拟地址到物理地址的映射，所有的映射都需要依靠页表进行，同时地址映射是一个硬件过程，相比于 MOS 在 TLB 中找不到就触发异常，然后软件查表，Arm 只需要页目录的物理地址即可自动完成查找，报异常的原因是页表项权限位错误，异常处理只需要修改页表项即可。</p>
<p>但是因为没有原生的直接映射，所以在开启 MMU 之前，只能使用物理地址，这里我们做出创新，利用汇编指令的相对寻址，避免了在开启 MMU 之前访问高地址区，在开启 MMU 之后，重新将 <code>PC</code> 重定位到高地址，解决了 <code>bootloader</code> 的难题</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">en_mmu:
    msr 	spsel,		#1
    adr     X0, 		init_page_table
    blr     X0
    adr     X0, 		enable_mmu
    blr     X0
	// 这就是重定向
    ldr     X0, 		=jump_main
    br      X0

jump_main:  
	// TODO 重新设置栈指针
    ldr 	X0, 		=(init_sp)
    mov 	sp, 		X0
    bl 		main
    b 		pro_hang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="开启-MMU"><a href="#开启-MMU" class="headerlink" title="开启 MMU"></a>开启 MMU</h3><p>开启 MMU 的设置如下</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">#define TCR_VALUE   (TCR_T0SZ | TCR_T1SZ | TCR_TG0_4K | TCR_TG1_4K | TCR_IGNORE1 | TCR_IGNORE0 | TCR_ISH1 | TCR_ISH0 | TCR_OWT0 | TCR_IWT0 | TCR_OWT1 | TCR_IWT1)
#define MAIR_VALUE  (0x440488)
#define SCTLR_VALUE (0x30d01825)

.global enable_mmu
enable_mmu:
    ldr	    x0,             kernel_pud
    ldr	    x1,             user_pud				
	msr	    ttbr0_el1,      x1			
	msr	    ttbr1_el1,      x1

    ldr     x0,             =(MAIR_VALUE)
    msr     mair_el1,       x0


    ldr	    x0,             =(TCR_VALUE)		
	msr	    tcr_el1,        x0

    mrs     x0,             sctlr_el1
    orr     x0,             x0,             #0x1
    msr     sctlr_el1,      x0
    
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了要移入两个页表以外，还需要设置间接属性寄存器 <code>mair</code>，tlb 控制寄存器 <code>tcr</code>，最后在系统控制寄存器 <code>sctlr</code> 中将 MMU 打开。</p>
<h3 id="三级页表"><a href="#三级页表" class="headerlink" title="三级页表"></a>三级页表</h3><p>我们采用 arm 三级页表 4KB 页面设置，需要有一个人工建立高地址区到物理地址线性映射的过程，具体如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_page_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint_64 <span class="token operator">*</span>pud<span class="token punctuation">,</span> <span class="token operator">*</span>pmd<span class="token punctuation">,</span> <span class="token operator">*</span>pmd_entry<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">,</span> <span class="token operator">*</span>pte_entry<span class="token punctuation">;</span>
    uint_64 i<span class="token punctuation">,</span> r<span class="token punctuation">,</span> t<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>freemem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        freemem <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64<span class="token punctuation">)</span>_end<span class="token punctuation">;</span>
        freemem <span class="token operator">=</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>freemem<span class="token punctuation">,</span> BY2PG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 分配第一级页表</span>
    pud <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span>freemem<span class="token punctuation">;</span>
    freemem <span class="token operator">+=</span> BY2PG<span class="token punctuation">;</span>
    <span class="token comment">// 在第一级页表上登记上 _end 对应的这一项，需要 user 的原因是可能暴露内核的时候需要</span>
    pud<span class="token punctuation">[</span><span class="token function">PUDX</span><span class="token punctuation">(</span>pud<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>freemem <span class="token operator">|</span> PTE_VALID <span class="token operator">|</span> PTE_TABLE <span class="token operator">|</span> PTE_AF <span class="token operator">|</span> PTE_USER <span class="token operator">|</span> PTE_ISH <span class="token operator">|</span> PTE_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 分配第二级页表</span>
    pmd <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span>freemem<span class="token punctuation">;</span>
    freemem <span class="token operator">+=</span> BY2PG<span class="token punctuation">;</span>

    <span class="token comment">// 我们在外循环填写第二级页表项</span>
    <span class="token keyword">int</span> n_pmd_entry <span class="token operator">=</span> PHY_TOP <span class="token operator">&gt;&gt;</span> PMD_SHIFT<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> n_pmd_entry<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 填写二级页表项</span>
        pmd_entry <span class="token operator">=</span> pmd <span class="token operator">+</span> r<span class="token punctuation">;</span>
        <span class="token comment">// 暴露内核的时候可能需要设置为 PTE_USER</span>
        <span class="token operator">*</span>pmd_entry <span class="token operator">=</span> <span class="token punctuation">(</span>freemem <span class="token operator">|</span> PTE_VALID <span class="token operator">|</span> PTE_TABLE <span class="token operator">|</span> PTE_AF <span class="token operator">|</span> PTE_USER <span class="token operator">|</span> PTE_ISH <span class="token operator">|</span> PTE_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 分配第三级页表</span>
        pte <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span>freemem<span class="token punctuation">;</span>
        freemem <span class="token operator">+=</span> BY2PG<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> t<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            pte_entry <span class="token operator">=</span> pte <span class="token operator">+</span> t<span class="token punctuation">;</span>
            <span class="token comment">// 填写三级页表项</span>
            i <span class="token operator">=</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这里确实只有当设置成 ReadOnly 的时候能跑起来，我不知道为啥</span>
            <span class="token comment">// 这个 if 里的是内核的程序段，这么看似乎用户进程可能也有这个问题</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0x80000</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>uint_64<span class="token punctuation">)</span><span class="token punctuation">(</span>_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>pte_entry<span class="token punctuation">)</span> <span class="token operator">=</span> i <span class="token operator">|</span> PTE_VALID <span class="token operator">|</span> PTE_TABLE <span class="token operator">|</span> PTE_AF <span class="token operator">|</span> PTE_NORMAL <span class="token operator">|</span> PTE_USER <span class="token operator">|</span> PTE_RO<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token operator">*</span>pte_entry<span class="token punctuation">)</span> <span class="token operator">=</span> i <span class="token operator">|</span> PTE_VALID <span class="token operator">|</span> PTE_TABLE <span class="token operator">|</span> PTE_AF <span class="token operator">|</span> PTE_NORMAL <span class="token operator">|</span> PTE_USER<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将这个二级页表填完</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> n_pmd_entry<span class="token punctuation">;</span> r <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        pmd<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">|</span> PTE_VALID <span class="token operator">|</span> PTE_AF <span class="token operator">|</span> PTE_USER <span class="token operator">|</span> PTE_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里是 MMIO 的一种表现形式</span>
    pud<span class="token punctuation">[</span><span class="token function">PUDX</span><span class="token punctuation">(</span><span class="token number">0x40000000</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>freemem <span class="token operator">|</span> PTE_VALID <span class="token operator">|</span> PTE_TABLE <span class="token operator">|</span> PTE_AF <span class="token operator">|</span> PTE_USER <span class="token operator">|</span> PTE_ISH <span class="token operator">|</span> PTE_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 又分配了一个二级页表</span>
    pmd <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span>freemem<span class="token punctuation">;</span>
    freemem <span class="token operator">+=</span> BY2PG<span class="token punctuation">;</span>
    pmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x40000000</span> <span class="token operator">|</span> PTE_VALID <span class="token operator">|</span> PTE_AF <span class="token operator">|</span> PTE_USER <span class="token operator">|</span> PTE_DEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    kernel_pud <span class="token operator">=</span> pud<span class="token punctuation">;</span>
    user_pud <span class="token operator">=</span> pud<span class="token punctuation">;</span>
    
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="页表权限位"><a href="#页表权限位" class="headerlink" title="页表权限位"></a>页表权限位</h3><p>只记录一些易错点</p>
<ul>
<li><code>PTE_TABLE</code> ：每个页表项都需要有这位</li>
<li><code>PTE_AF</code>：每个页表项都需要有</li>
<li><code>PTE_RW</code> ：和 <code>PTE_RO</code> 是同一位，常规方法只能检测 <code>PTE_RO</code> </li>
</ul>
<p>这个页表权限位是真的狗，因为移植操作系统最大的难度就是处理硬件接口，而这里基本上就是最复杂的硬件接口，稍有一个不慎，系统就有可能出现很多莫名其妙的 bug 。所以一定要慎之又慎。</p>
<h3 id="TLB-刷新"><a href="#TLB-刷新" class="headerlink" title="TLB 刷新"></a>TLB 刷新</h3><p>虽然似乎可以按照虚拟地址“定点清除”，但是为了稳妥起见，最终选择全部清除 tlb 代码如下</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.globl tlb_invalidate
tlb_invalidate:
    dsb     ishst               // ensure write has completed
    // tlbi    vmalls12e1is       // invalidate tlb, all asid, el1.
    tlbi    vmalle1is
    dsb     ish                 // ensure completion of tlb invalidation
    isb                         // synchronize context and ensure that no instructions
                                // are fetched using the old translation
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 <code>dsb</code> 是数据同步屏障，<code>isb</code> 是指令同步屏障，<code>tlbi</code> 用于使指令失效。</p>
<p>有趣的是，不知道上面注释掉的这个为什么不可以</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">// tlbi    vmalls12e1is       // invalidate tlb, all asid, el1.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="内存测试测试"><a href="#内存测试测试" class="headerlink" title="内存测试测试"></a>内存测试测试</h3><p>测试函数如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">debug_print_pgdir</span><span class="token punctuation">(</span>uint_64 <span class="token operator">*</span>pg_root<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"start to retrieval address: %lx\n"</span><span class="token punctuation">,</span> pg_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We only print the first 16 casting</span>
    <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">2048</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint_64 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// First Level</span>
        uint_64 pg_info <span class="token operator">=</span> pg_root<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pg_info <span class="token operator">&amp;</span> PTE_VALID<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"|-Level1 OK %lx|\n"</span><span class="token punctuation">,</span> pg_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// So we should go to level 2</span>
            uint_64 <span class="token operator">*</span>level2_root <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span>pg_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>uint_64 j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                uint_64 level2_info <span class="token operator">=</span> level2_root<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>level2_info <span class="token operator">&amp;</span> PTE_VALID<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"|-|-Level2 OK|\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// So we should go to level 3</span>
                    uint_64 <span class="token operator">*</span>level3_root <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span>level2_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint_64 k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        uint_64 level3_info <span class="token operator">=</span> level3_root<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>level3_info <span class="token operator">&amp;</span> PTE_VALID<span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"|-|-|-Level3 OK|\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// We should print our info here.</span>
                            uint_64 va <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint_64<span class="token punctuation">)</span>i <span class="token operator">&lt;&lt;</span> PUD_SHIFT<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint_64<span class="token punctuation">)</span>j <span class="token operator">&lt;&lt;</span> PMD_SHIFT<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint_64<span class="token punctuation">)</span>k <span class="token operator">&lt;&lt;</span> PTE_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            uint_64 pa <span class="token operator">=</span> level3_info<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>limit<span class="token operator">--</span><span class="token punctuation">)</span>
                                <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"cast from ...0x%016lx to 0x%016lx... %d %d %d\n"</span><span class="token punctuation">,</span> va<span class="token punctuation">,</span> pa<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test_pgdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n---test pgdir---\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Stage 1 - build up a page table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint_64 <span class="token operator">*</span>pgdir<span class="token punctuation">;</span>
    uint_32 <span class="token operator">*</span>data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>lut_page<span class="token punctuation">;</span>
    <span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lut_page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pgdir <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">page2kva</span><span class="token punctuation">(</span>lut_page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">Page</span> <span class="token operator">*</span>data_page<span class="token punctuation">;</span>
    <span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data_page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token punctuation">(</span>uint_32 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">page2kva</span><span class="token punctuation">(</span>data_page<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">// Fill data into the data page</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Insert data_page into lut_page</span>
    <span class="token keyword">extern</span> uint_64 <span class="token operator">*</span>kernel_pud<span class="token punctuation">;</span>
    <span class="token keyword">extern</span> uint_64 <span class="token operator">*</span>user_pud<span class="token punctuation">;</span>
    uint_64 <span class="token operator">*</span>kernel <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint_64<span class="token punctuation">)</span>kernel_pud<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint_64 <span class="token operator">*</span>user <span class="token operator">=</span> <span class="token punctuation">(</span>uint_64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint_64<span class="token punctuation">)</span>user_pud<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Kernel pud is %lx , User pud is %lx\n"</span><span class="token punctuation">,</span> kernel<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"kernel pud value is %lx\n"</span><span class="token punctuation">,</span> kernel<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">page_insert</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> data_page<span class="token punctuation">,</span> <span class="token number">0x400000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// page_insert(pgdir,lut_page,PADDR(pgdir),PTE_ISH | PTE_RO | PTE_AF | PTE_NON_CACHE);</span>
    <span class="token comment">// page_insert(user,data_page,0x80000,PTE_ISH | PTE_RO | PTE_AF | PTE_NON_CACHE);</span>
    <span class="token function">debug_print_pgdir</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_ttbr0</span><span class="token punctuation">(</span><span class="token function">page2pa</span><span class="token punctuation">(</span>lut_page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// set_ttbr0(PADDR(user));</span>
    <span class="token function">tlb_invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token punctuation">(</span>uint_32 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x400000</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"data is %d:%d @0x%lx,0x%lx\n"</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">800</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>data_page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="思考题-2"><a href="#思考题-2" class="headerlink" title="思考题"></a>思考题</h3><p><strong>在 “标准” MIPS 实验中,是如何进行地址翻译的呢?</strong></p>
<p>对于高地址区，MIPS 提供直接映射，对于低地址区，硬件查询 TLB，如果没有办法完成，那么就会触发异常调用 <code>do_refill</code> 函数完成 TLB 的填充和物理页面的插入。</p>
<hr>
<h2 id="Lab-3"><a href="#Lab-3" class="headerlink" title="Lab 3"></a>Lab 3</h2><h3 id="开启异常"><a href="#开启异常" class="headerlink" title="开启异常"></a>开启异常</h3><p>原有 MOS 是用软件完成的异常分发，通过异常编号用汇编语言查找异常向量表。在 arm 中，初步的分发是通过硬件实现的，我们只需要构建好异常向量表，如下所示</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.align 11
.global vectors
vectors:
    handler	sync_invalid_el1t			// Synchronous EL1t
	handler	irq_invalid_el1t			// IRQ EL1t
	handler	fiq_invalid_el1t			// FIQ EL1t
	handler	error_invalid_el1t			// Error EL1t

    // EL1 异常陷入 EL1 处理
	handler	el1_sync			        // Synchronous EL1h
	handler	el1_irq					    // IRQ EL1h
	handler	fiq_invalid_el1h			// FIQ EL1h
	handler	error_invalid_el1h			// Error EL1h

    // EL0 异常陷入 EL1 处理
	handler	el0_sync		            // Synchronous 64-bit EL0
	handler	el0_irq			            // IRQ 64-bit EL0
	handler	fiq_invalid_el0_64			// FIQ 64-bit EL0
	handler	error_invalid_el0_64	    // Error 64-bit EL0

	handler	sync_invalid_el0_32			// Synchronous 32-bit EL0
	handler	irq_invalid_el0_32			// IRQ 32-bit EL0
	handler	fiq_invalid_el0_32			// FIQ 32-bit EL0
	handler	error_invalid_el0_32		// Error 32-bit EL0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后只需要设置相应寄存器，就可以实现硬件查找异常向量表</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.globl irq_vector_init
irq_vector_init:
	ldr	x0,         =vectors		// load VBAR_EL1 with virtual
	msr	vbar_el1,   x0		        // vector table address
	ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除此之外，还需要利用 <code>MMIO</code> 打开平台的中断控制器，代码如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">enable_interrupt_controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// enable all kind of exception!</span>
    <span class="token comment">// as for the register mapping,see guidebook.</span>
    <span class="token function">put32</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xffffff8040000040</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">put32</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xffffff8040000044</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">put32</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xffffff8040000048</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">put32</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xffffff804000004c</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="时钟中断"><a href="#时钟中断" class="headerlink" title="时钟中断"></a>时钟中断</h3><p>时钟中断为 <code>IRQ</code>，分发后即可处理，对接 <code>env_sched</code> 即可。对于设置时钟，如下所示：</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.global reset_timer
reset_timer:
    mov x0,             #0x3
    msr cntkctl_el1,    x0
    ldr x0,             =(0x3b9aca0 &gt;&gt; 6)
    //when the qemu start,the frequency is 0x3b9aca0 HZ
    //i don't know why i cannot change the frquency of it
    //doing so to so set 1s per exception
    msr cntp_tval_el0,  x0
    mov x0,             #0x1
    msr cntp_ctl_el0,   x0
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="同步异常"><a href="#同步异常" class="headerlink" title="同步异常"></a>同步异常</h3><p>同步异常一共有三种，分别是系统调用，缺页异常，写时复制。三者属于同一种异常，所以需要进一步的分发，进一步的分发需要依靠 <code>ESR</code>，他类似与 <code>Cause</code> 寄存器，可以根据他来分析原因，具体方法如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">handle_sync</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Trapframe</span> <span class="token operator">*</span>tf<span class="token punctuation">,</span> uint_64 <span class="token operator">*</span>ttbr0<span class="token punctuation">,</span> uint_64 <span class="token operator">*</span>ttbr1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint_64 far <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>far<span class="token punctuation">;</span>
    uint_64 esr <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>esr<span class="token punctuation">;</span>
    uint_64 EC <span class="token operator">=</span> esr <span class="token operator">&gt;&gt;</span> <span class="token number">26</span><span class="token punctuation">;</span>

    <span class="token comment">// 异常是系统调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>EC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x15</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        uint_64 syscall_id <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Handling the syscall. Syscall id is %ld\n"</span><span class="token punctuation">,</span> syscall_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 这里保存一个系统调用的值, x0 承担了第一个参数和返回值两个任务</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>syscall_id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将返回值修改</span>
        tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>EC <span class="token operator">==</span> <span class="token number">0x20</span> <span class="token operator">||</span> EC <span class="token operator">==</span> <span class="token number">0x21</span> <span class="token operator">||</span> EC <span class="token operator">==</span> <span class="token number">0x24</span> <span class="token operator">||</span> EC <span class="token operator">==</span> <span class="token number">0x25</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        uint_64 DFSC <span class="token operator">=</span> esr <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">;</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"DFSC is %ld,\n"</span><span class="token punctuation">,</span> DFSC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 异常是页表缺失</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DFSC <span class="token operator">&gt;=</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> DFSC <span class="token operator">&lt;=</span> <span class="token number">7</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Handling the page lost.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>far <span class="token operator">&gt;</span> KERNEL_BASE<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">pageout</span><span class="token punctuation">(</span>far<span class="token punctuation">,</span> ttbr1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token function">pageout</span><span class="token punctuation">(</span>far<span class="token punctuation">,</span> ttbr0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 异常是 cow</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DFSC <span class="token operator">&gt;=</span> <span class="token number">13</span> <span class="token operator">&amp;&amp;</span> DFSC <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Hanlding the copy on write.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">page_fault_handler</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Unknown data sync.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Unkown sync\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据 <code>EC</code> 域区分出系统调用，再用 DFSC 域区分是缺页异常还是写时复制。</p>
<h3 id="栈帧的设计"><a href="#栈帧的设计" class="headerlink" title="栈帧的设计"></a>栈帧的设计</h3><p>与 MOS 的设计基本上类似，如下所示</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">Trapframe</span>
<span class="token punctuation">{</span>
    uint_64 x<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    uint_64 sp<span class="token punctuation">;</span>
    uint_64 elr<span class="token punctuation">;</span>
    uint_64 pstate<span class="token punctuation">;</span>
    uint_64 far<span class="token punctuation">;</span>
    uint_64 esr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了 31 个通用寄存器外，还保存着</p>
<ul>
<li><code>sp</code> 栈指针</li>
<li><code>elr</code> 异常返回地址</li>
<li><code>pstate</code>状态寄存器</li>
<li><code>far</code>错误地址</li>
<li><code>esr</code>同步异常的错误原因寄存器</li>
</ul>
<p>当时只是优化了掉了没用的 <code>pc</code>，但是后面发现似乎 <code>pstate</code> 也没用。</p>
<p>对于弹栈和压栈，一般有三个情景，不一一列举了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// stp 是同时存储两个寄存器值的意思，store pair </span>
<span class="token punctuation">.</span>macro SAVE_ALL
    sub	sp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span>     #TF_SIZE

	stp	x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">0</span><span class="token punctuation">]</span>
	stp	x2<span class="token punctuation">,</span> x3<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span>
	stp	x4<span class="token punctuation">,</span> x5<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span>
	stp	x6<span class="token punctuation">,</span> x7<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span>
	stp	x8<span class="token punctuation">,</span> x9<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span>
	stp	x10<span class="token punctuation">,</span> x11<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">]</span>
	stp	x12<span class="token punctuation">,</span> x13<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">]</span>
	stp	x14<span class="token punctuation">,</span> x15<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span>
	stp	x16<span class="token punctuation">,</span> x17<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">]</span>
	stp	x18<span class="token punctuation">,</span> x19<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">]</span>
	stp	x20<span class="token punctuation">,</span> x21<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">]</span>
	stp	x22<span class="token punctuation">,</span> x23<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">11</span><span class="token punctuation">]</span>
	stp	x24<span class="token punctuation">,</span> x25<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">12</span><span class="token punctuation">]</span>
	stp	x26<span class="token punctuation">,</span> x27<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">13</span><span class="token punctuation">]</span>
	stp	x28<span class="token punctuation">,</span> x29<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">14</span><span class="token punctuation">]</span>

    <span class="token comment">// store the LR</span>
	str	x30<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span>
    <span class="token comment">// store the SP</span>
	mrs x16<span class="token punctuation">,</span>        sp_el0
	str x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">31</span><span class="token punctuation">]</span>
    <span class="token comment">// store the ELR</span>
	mrs x16<span class="token punctuation">,</span>        elr_el1
	str x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">]</span>
    <span class="token comment">// store the PSTATE</span>
	mrs x16<span class="token punctuation">,</span>        spsr_el1
	str x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">33</span><span class="token punctuation">]</span>
    <span class="token comment">// store the FAR</span>
    mrs x16<span class="token punctuation">,</span>        far_el1
    str x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">34</span><span class="token punctuation">]</span>
    <span class="token comment">// store the ESR</span>
    mrs x16<span class="token punctuation">,</span>        esr_el1
    str x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">35</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span>endm

<span class="token punctuation">.</span>macro RESTORE
    ldp	x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">0</span><span class="token punctuation">]</span>
	ldp	x2<span class="token punctuation">,</span> x3<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span>
	ldp	x4<span class="token punctuation">,</span> x5<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span>
	ldp	x6<span class="token punctuation">,</span> x7<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span>
	ldp	x8<span class="token punctuation">,</span> x9<span class="token punctuation">,</span>     <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span>
	ldp	x10<span class="token punctuation">,</span> x11<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">]</span>
	ldp	x12<span class="token punctuation">,</span> x13<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">]</span>
	ldp	x14<span class="token punctuation">,</span> x15<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">]</span>
	ldp	x16<span class="token punctuation">,</span> x17<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">]</span>
	ldp	x18<span class="token punctuation">,</span> x19<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">]</span>
	ldp	x20<span class="token punctuation">,</span> x21<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">]</span>
	ldp	x22<span class="token punctuation">,</span> x23<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">11</span><span class="token punctuation">]</span>
	ldp	x24<span class="token punctuation">,</span> x25<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">12</span><span class="token punctuation">]</span>
	ldp	x26<span class="token punctuation">,</span> x27<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">13</span><span class="token punctuation">]</span>
	ldp	x28<span class="token punctuation">,</span> x29<span class="token punctuation">,</span>   <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">16</span> <span class="token operator">*</span> <span class="token number">14</span><span class="token punctuation">]</span>

    <span class="token comment">// restore LR</span>
	ldr	x30<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span>
    <span class="token comment">// restore SP，这里应该没有问题，因为恢复的是 sp_el0，而现在用的是 sp_el1</span>
	ldr x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">31</span><span class="token punctuation">]</span>
	msr sp_el0<span class="token punctuation">,</span>     x16
    <span class="token comment">// restore ELR</span>
	ldr x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">]</span>
	msr elr_el1<span class="token punctuation">,</span>    x16
    <span class="token comment">// restore PSTATE</span>
	ldr x16<span class="token punctuation">,</span>        <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span> <span class="token operator">*</span> <span class="token number">33</span><span class="token punctuation">]</span>
	msr spsr_el1<span class="token punctuation">,</span>   x16
    <span class="token comment">// 这里似乎没有必要恢复这俩寄存器</span>
    <span class="token comment">// restore FAR</span>
    <span class="token comment">// ldr x16,        [sp, #8 * 34]</span>
    <span class="token comment">// msr far_el1,    x16</span>
    <span class="token comment">// restore ESR</span>
    <span class="token comment">// ldr x16,        [sp, #8 * 35]</span>
    <span class="token comment">// msr esr_el1     x16</span>
	add	sp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span>     #TF_SIZE		
<span class="token punctuation">.</span>endm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ELF-64"><a href="#ELF-64" class="headerlink" title="ELF 64"></a>ELF 64</h3><p>因为是 64 位的机子，所以 ELF 的格式也由原来的 32 位变成了 64 位，有一个明显的区别，这里给出一个示例：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    uint_8 e_ident<span class="token punctuation">[</span>EI_NIDENT<span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment">/* Magic number and other info */</span>
    uint_16 e_type<span class="token punctuation">;</span>                     <span class="token comment">/* Object file type */</span>
	uint_16 e_machine<span class="token punctuation">;</span>					<span class="token comment">/* Architecture */</span>
	uint_32 e_version<span class="token punctuation">;</span>             		<span class="token comment">/* Object file version */</span>
	Elf64_Addr e_entry<span class="token punctuation">;</span>					<span class="token comment">/* Entry point virtual address */</span>
	Elf64_Off e_phoff<span class="token punctuation">;</span>					<span class="token comment">/* Program header table file offset */</span>
	Elf64_Off e_shoff<span class="token punctuation">;</span>                	<span class="token comment">/* Section header table file offset */</span>
    uint_32 e_flags<span class="token punctuation">;</span>               		<span class="token comment">/* Processor-specific flags */</span>
    uint_16 e_ehsize<span class="token punctuation">;</span>              		<span class="token comment">/* ELF header size in bytes */</span>
    uint_16 e_phentsize<span class="token punctuation">;</span>           		<span class="token comment">/* Program header table entry size */</span>
    uint_16 e_phnum<span class="token punctuation">;</span>               		<span class="token comment">/* Program header table entry count */</span>
    uint_16 e_shentsize<span class="token punctuation">;</span>           		<span class="token comment">/* Section header table entry size */</span>
    uint_16 e_shnum<span class="token punctuation">;</span>               		<span class="token comment">/* Section header table entry count */</span>
    uint_16 e_shstrndx<span class="token punctuation">;</span>            		<span class="token comment">/* Section header string table index */</span>
<span class="token punctuation">}</span> Elf64_Ehdr<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="思考题-3"><a href="#思考题-3" class="headerlink" title="思考题"></a>思考题</h3><p><strong>什么时候会发生 EL1 异常并陷入 EL1 来处理 EL1 的异常的情况?</strong></p>
<p>其实原有 MOS 中不会发生这种情况，因为在所有的中断和异常操作都是原子的，有 <code>CLI</code> 和 <code>STI</code> 保证，在 arm 中，考虑会发生内核栈过大导致的缺页异常。</p>
<hr>
<h2 id="Lab-4"><a href="#Lab-4" class="headerlink" title="Lab 4"></a>Lab 4</h2><h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><p>在 MOS 中系统调用需要通过系统调用表分发，在 arm 中，可以直接用 C 语言分发</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">switch</span> <span class="token punctuation">(</span>syscall_id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">case</span> SYS_putchar<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_putchar\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sys_putchar</span><span class="token punctuation">(</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_getenvid<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_get_envid\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_getenvid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_yield<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_yield\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sys_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_env_destroy<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_destroy\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_env_destroy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_set_pgfault_handler<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_set_pgfault_handler\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_set_pgfault_handler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_mem_alloc<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_mem_alloc\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_mem_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_mem_map<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_mem_map\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_mem_map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_mem_unmap<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_mem_umap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_mem_unmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_env_alloc<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_env_alloc\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_env_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_set_env_status<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_set_env_status\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_set_env_status</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_set_trapframe<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_set_trapframe\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_set_trapframe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Trapframe</span> <span class="token operator">*</span><span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_panic<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_panic\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sys_panic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_ipc_recv<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_ipc_recv\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sys_ipc_recv</span><span class="token punctuation">(</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_ipc_can_send<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_ipc_can_send\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_ipc_can_send</span><span class="token punctuation">(</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>u_int<span class="token punctuation">)</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_read_sd<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_read_dev\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_read_sd</span><span class="token punctuation">(</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_write_sd<span class="token operator">:</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"syscall is sys_read_dev\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token function">sys_write_sd</span><span class="token punctuation">(</span>tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SYS_cgetc<span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unknown syscall id %d.\n"</span><span class="token punctuation">,</span> syscall_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="用户态弹栈"><a href="#用户态弹栈" class="headerlink" title="用户态弹栈"></a>用户态弹栈</h3><p>弹栈最重要的问题是将栈指针从异常处理栈重定位回用户栈，可以用 <code>x16, x17</code> 寄存器作为中转，他们的作用类似于<code>k1,k2</code>。这里有一个至关重要的问题，就是在用户态下，是没有办法使用 <code>msr</code> 指令的，所以在调整栈指针的时候，需要这样</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov sp,         x16			// right
msr sp_el0,		x16			// wrong<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="用户态页表"><a href="#用户态页表" class="headerlink" title="用户态页表"></a>用户态页表</h3><p>改掉了让人深恶痛绝的指针的指针，改成指针，可以正常访问，如图所示</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">(</span>vpt<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">&amp;</span> PTE_VALID<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="写时复制机制实现"><a href="#写时复制机制实现" class="headerlink" title="写时复制机制实现"></a>写时复制机制实现</h3><p>首先，我们利用三重循环遍历所有的页表项</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vmd<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">&amp;</span> PTE_VALID<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vpt<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">]</span> <span class="token operator">&amp;</span> PTE_VALID<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> k <span class="token operator">&gt;=</span> USTACKTOP<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">duppage</span><span class="token punctuation">(</span>newenvid<span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后对于可以读写且不为共享页面的页面，需要打上 <code>RO</code> 和 <code>COW</code> 两个标记</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>perm <span class="token operator">&amp;</span> PTE_RO<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>perm <span class="token operator">&amp;</span> PTE_LIBRARY<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    perm <span class="token operator">|=</span> PTE_RO<span class="token punctuation">;</span>
    perm <span class="token operator">|=</span> PTE_COW<span class="token punctuation">;</span>
    flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 <code>RO</code> 是为了触发异常，<code>COW</code> 是为了与真正的 <code>RO</code> 进行区分。</p>
<h3 id="fork-的检验"><a href="#fork-的检验" class="headerlink" title="fork 的检验"></a>fork 的检验</h3><p>用以下测试程序即可完成检验。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lib.h"</span></span>

<span class="token keyword">void</span> <span class="token function">umain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            a <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">writef</span><span class="token punctuation">(</span><span class="token string">"\t\tthis is child2 :a:%d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        a <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">writef</span><span class="token punctuation">(</span><span class="token string">"\tthis is child :a:%d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    a<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">writef</span><span class="token punctuation">(</span><span class="token string">"this is father: a:%d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if (fork() == 0)</span>
    <span class="token comment">// {</span>
    <span class="token comment">//     writef("this is child.\n");</span>
    <span class="token comment">// }</span>
    <span class="token comment">// else</span>
    <span class="token comment">// {</span>
    <span class="token comment">//     writef("this is father.\n");</span>
    <span class="token comment">// }</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="Lab-5"><a href="#Lab-5" class="headerlink" title="Lab 5"></a>Lab 5</h2><h3 id="EMMC-SD卡-驱动"><a href="#EMMC-SD卡-驱动" class="headerlink" title="EMMC(SD卡)驱动"></a>EMMC(SD卡)驱动</h3><p>在树莓派中,我们不在拥有ide控制器了,取而代之的是树莓派soc内部的EMMC控制器.</p>
<p>Emmc是一个通用性比较强的flash memory控制传输协议,其具体内容非常复杂.有一大部分比较通用的emmc协议,其实是借助spi的接口实现的,而这种实现的控制也会比较复杂.好在树莓派的soc内部,提供了EMMC的控制器,可以通过soc的总线读写EMMC控制器的寄存器,实现对树莓派上sd卡/emmc闪存的读写.</p>
<p>具体关于树莓派的EMMC控制器信息,树莓派3使用的是BCM2837 soc, 我并没有找到这款soc的手册(BCM2837 ARM Peripherals), 但根据树莓派论坛上获得的信息,BCM283X系列的soc,使用的EMMC控制器都是相同的,区别只在于其MMIO映射的基址不同.于是我查看了BCM2835的手册<code>https://www.raspberrypi.org/app/uploads/2012/02/BCM2835-ARM-Peripherals.pdf</code></p>
<p>在手册中,可以知道,BCM283X系列EMMC控制器相关控制寄存器的mmio偏移地址. (BCM2835-ARM-Peripherals Pages 66)</p>
<p><img src="/posts/5955f5d7/image-20220704012243222.png" alt="image-20220704012243222"></p>
<p>BCM2837与BCM2835的差别还在于MMIO的基准地址. BCM2835的mmio基地址为0x7E000000,而BCM2837的则为0x3F000000. 故BCM2837控制Emmc控制器的基准地址是在0x3F300000.我们只需要这一点就可以完成EMMC驱动的适配.</p>
<p>虽然EMMC控制器大幅度减少了控制的复杂性,但EMMC的控制复杂度依然超高,很难短时间完成.因此,我们使用了针对树莓派1(BCM2835)开发的emmc驱动,并进行了简单的移植,使其能在树莓派3上正常的工作.(来源<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jncronin/rpi-boot">https://github.com/jncronin/rpi-boot</a>)</p>
<p>(相关代码在drivers/emmc.c中)</p>
<h3 id="字节序问题"><a href="#字节序问题" class="headerlink" title="字节序问题"></a>字节序问题</h3><p>之前MOS开发,是针对MIPS R3000这款古董处理器进行的.而MIPS R3000,与今天的主流设备不同,是Big-Endian的处理器.我们开发机的x86_64,和目标平台的AARCH64,在绝大多数情况下,都是使用Little-Endian的.故在生成MOS使用的文件镜像所使用的fsformat程序中,专门进行了字节序的转换.</p>
<p>而这个转换,在我们的实现中就完全没有必要了,因此我们修改了fsformat程序,将其中反转字节序的函数修改为不进行任何操作直接返回,就可以保证目标平台AARCH64中读写sd卡的功能完全正常.</p>
<h3 id="用户态emmc控制"><a href="#用户态emmc控制" class="headerlink" title="用户态emmc控制"></a>用户态emmc控制</h3><p>在之前的MOS实现中,实际上IDE的驱动是在fs_serv进程中实现的,只借助了读写设备内存的两个系统调用.这一点符合微内核系统的设计理念.但在我们的实现中这样进行移植,虽然确实是可以做到的,但是工作量会非常之大.因此,我们使用了传统宏内核的设计方式,将emmc的驱动在内核态中运行,并通过系统调用实现用户态的访问(系统调用分别为写sd卡和读sd卡).</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sys_write_sd</span><span class="token punctuation">(</span>uint_64 blockno<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data_addr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">sd_write_fixed</span><span class="token punctuation">(</span>blockno<span class="token punctuation">,</span> data_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">sys_read_sd</span><span class="token punctuation">(</span>uint_64 blockno<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data_addr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">sd_read_fixed</span><span class="token punctuation">(</span>blockno<span class="token punctuation">,</span> data_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="fs-serv的移植"><a href="#fs-serv的移植" class="headerlink" title="fs_serv的移植"></a>fs_serv的移植</h3><p>在实现之前那些前置准备之后,移植fs_serv就基本没有问题了.需要进行的工作主要是为文件系统重新划定内存的区域,并将之前设计用户态页表操作的位置从原有二级页表转换为三级页表,将原有文件读写对用户态ide驱动的依赖转为对内核态emmc驱动的依赖.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ide_read</span><span class="token punctuation">(</span>u_int diskno<span class="token punctuation">,</span> u_int secno<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> u_int nsecs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nsecs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">syscall_read_sd</span><span class="token punctuation">(</span>secno <span class="token operator">+</span> i<span class="token punctuation">,</span> dst <span class="token operator">+</span> <span class="token number">512</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ide_write</span><span class="token punctuation">(</span>u_int diskno<span class="token punctuation">,</span> u_int secno<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> u_int nsecs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nsecs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">syscall_write_sd</span><span class="token punctuation">(</span>secno <span class="token operator">+</span> i<span class="token punctuation">,</span> src <span class="token operator">+</span> <span class="token number">512</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="关于用户态驱动和内核态驱动优缺点的探讨"><a href="#关于用户态驱动和内核态驱动优缺点的探讨" class="headerlink" title="关于用户态驱动和内核态驱动优缺点的探讨"></a>关于用户态驱动和内核态驱动优缺点的探讨</h3><p>众所周知,在MOS系统中实现的文件系统, 对磁盘的读写是靠建立在fs_serv中的用户态ide驱动完成的.而在arm64的移植任务中,虽然也可以实现成用户态的emmc驱动,但可能会过于复杂,所以实际上我们是在内核中完成驱动,并通过系统调用传递数据的.</p>
<p>这两种关于驱动的不同实现思路,其实部分反应这操作系统的微内核路线与宏内核路线.微内核将系统的各种功能抽象化为服务的用户程序,包括驱动程序. 程序运行在用户态,通过系统调用与硬件进行交互,通过ipc向其他用户进程提供服务.这种实现的主要优势在于高稳定性.</p>
<p>用户态驱动的优势在于,如果某一服务程序崩溃了,系统内核还是可以正常工作的.只需要将崩溃的服务程序结束,并重新启动即可,并不会影响整个系统的稳定性.而宏内核在某一内核态驱动崩溃后,就完蛋了.但用户态驱动也存在劣势,驱动程序会频繁的访问硬件外设,而访问硬件外设往往需要进行系统调用.也就是用户态驱动会发出非常非常多的系统调用请求. 哪怕只是往硬件上写一个字节,也需要很多个周期.用户态驱动对于控制较为复杂的外设,很容易产生overhead的syscall,造成严重性能问题.而内核态驱动不存在这种问题.用户程序只需要将请求一次送达内核态驱动,内核态驱动执行是很快的.</p>
<p>可以看出,用户态驱动与内核态驱动,可以说优缺点是一个互补的关系.现代操作系统,往往驱动的实现是两者的结合,有一部分用户态驱动,有一部分内核态驱动.比如Windows NT下关于显卡驱动的WDDM模型,定义了用户侧负责处理图形接口(DX/OPENGL/VULKAN/CUDA)的用户侧驱动,用户侧会进行大部分的处理,包括对着色器的编译等等.处理完之后,需要发送的指令队列通过系统调用传递给内核态驱动,由内核态驱动进行对硬件的直接控制.Linux这边也是同样,NVIDIA的显示驱动也被分为了用户侧和内核侧两部分.不论是微内核操作系统还是宏内核,最后是殊途同归的.</p>
<p>这样,既不会因为复杂的驱动功能造成系统的易崩溃,不稳定,也不会因为用户态驱动频繁的系统调用产生过大的系统负载影响性能,在图形这种对性能非常敏感的场合,是非常有效的.    </p>
<hr>
<h2 id="Lab-6"><a href="#Lab-6" class="headerlink" title="Lab 6"></a>Lab 6</h2><h3 id="arm-的压栈方式"><a href="#arm-的压栈方式" class="headerlink" title="arm 的压栈方式"></a>arm 的压栈方式</h3><p>armv8是一个比较现代的指令集,而对应他的abi,也是比较复杂的.</p>
<p>在我们设计的MOS中,实际这种复杂性是可以大大降低的,因为我们并不使用armv8的浮点数以及其向量拓展功能,我们仅仅需要考虑整数参数.</p>
<p>具体特化到我们需要实现的功能,我们需要实现用户程序动态的加载,并带参数执行另一个用户程序.在这个过程中,需要手工的控制的实际上只有使用参数初始化另一个用户程序的寄存器值以及栈的内容.</p>
<p>具体而言,我们是要给下面这个函数传参</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">umain</span> <span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以看到参数分别为一个4字节的整型和一个8字节的指针.</p>
<p>传递这两个参数,在armv8的abi规定中,比较平凡,只需要使用x0寄存器的低32位存储argc参数,x1寄存器存储argv即可.相比与mips,主要的变化在于,mips的abi(mips32)中会由调用者为每一个参数分配栈空间,以保证被调用方存储参数值的需求. armv8的要求,对于放在寄存器中的参数,不会额外提供栈空间.</p>
<p>因此,在我们的需求中,只需要向栈中从高到低的填写参数字符串,参数指针数组,并保证参数指针数组开始位置按照16字节对齐(armv8推荐保持sp指针16字节对齐避免不必要的不对齐访问异常),最后将参数数量,指针数组地址填入寄存器即可。</p>
<h3 id="利用变长参数解决变长参数"><a href="#利用变长参数解决变长参数" class="headerlink" title="利用变长参数解决变长参数"></a>利用变长参数解决变长参数</h3><p>因为 arm 的压栈方式，所以原有的直接从栈上获取变长参数是不可能的，因为有很多参数之在寄存器上，而不在栈上，所以这种写法行不通</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">spawnl</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>prog<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">spawn</span><span class="token punctuation">(</span>prog<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是可以用变长参数来获得</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">spawnl</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>prog<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    va_list ap<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> prog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>args<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> uint_64<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        buf<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">spawn</span><span class="token punctuation">(</span>prog<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="寄存器传递值"><a href="#寄存器传递值" class="headerlink" title="寄存器传递值"></a>寄存器传递值</h3><p>因为较小的参数传递都是依靠寄存器的，第一个参数存储在 <code>x0</code> 中，第二个参数存储在 <code>x1</code> 中，所以只需要把这两个值写入栈帧即可，这样被运行的时候就可以回复到寄存器中，因为 <code>spawn</code> 是从用户态调用的，所以是没有直接修改栈帧的，所以需要增添一个系统调用，具体演示如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sys_init_stack</span><span class="token punctuation">(</span>uint_32 envid<span class="token punctuation">,</span> uint_64 esp<span class="token punctuation">,</span> uint_64 argc_in_reg<span class="token punctuation">,</span> uint_64 argv_in_reg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">Env</span> <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>
    r <span class="token operator">=</span> <span class="token function">envid2env</span><span class="token punctuation">(</span>envid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"sys_init_stack : Can't get env\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    e<span class="token operator">-&gt;</span>env_tf<span class="token punctuation">.</span>elr <span class="token operator">=</span> <span class="token number">0x00400000</span><span class="token punctuation">;</span>
    e<span class="token operator">-&gt;</span>env_tf<span class="token punctuation">.</span>sp <span class="token operator">=</span> esp<span class="token punctuation">;</span>
    e<span class="token operator">-&gt;</span>env_tf<span class="token punctuation">.</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> argc_in_reg<span class="token punctuation">;</span>
    e<span class="token operator">-&gt;</span>env_tf<span class="token punctuation">.</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv_in_reg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/S4%E8%AF%BE%E4%B8%8A/" rel="tag"><i class="fa fa-tag"></i> S4课上</a>
              <a href="/tags/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" rel="tag"><i class="fa fa-tag"></i> 知识总结</a>
              <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag"><i class="fa fa-tag"></i> 操作系统</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/8b373749/" rel="prev" title="面向对象-大宗师">
      <i class="fa fa-chevron-left"></i> 面向对象-大宗师
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/d2c1893a/" rel="next" title="吃喝玩乐-流浪南京">
      吃喝玩乐-流浪南京 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
<script src="https://utteranc.es/client.js"
        repo="Thysrael/blog-comment"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%B8%AA%E4%BA%BA%E6%84%9F%E5%8F%97"><span class="nav-text">一、个人感受</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%9D%83%E8%A1%A1"><span class="nav-text">1.1 权衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%97%A0%E9%97%AE%E8%A5%BF%E4%B8%9C"><span class="nav-text">1.2 无问西东</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%A7%BB%E6%A4%8D%E6%A6%82%E8%BF%B0"><span class="nav-text">1.3 移植概述</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Aarch64-%E6%B1%87%E7%BC%96"><span class="nav-text">二、Aarch64 汇编</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99"><span class="nav-text">2.1 学习资料</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">2.2 寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">2.2.1 通用寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-1-%E5%87%BD%E6%95%B0-ABI"><span class="nav-text">2.2.1.1 函数 ABI</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-2-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">2.2.1.2 异常处理寄存器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-3-%E8%B0%83%E7%94%A8%E8%80%85%E4%BF%9D%E5%AD%98%E5%92%8C%E8%A2%AB%E8%B0%83%E7%94%A8%E8%80%85%E4%BF%9D%E5%AD%98"><span class="nav-text">2.2.1.3 调用者保存和被调用者保存</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E7%89%B9%E6%AE%8A%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">2.2.2 特殊寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-1-%E9%9B%B6%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">2.2.2.1 零寄存器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-2-pc"><span class="nav-text">2.2.2.2 pc</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-3-sp"><span class="nav-text">2.2.2.3 sp</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-4-elr"><span class="nav-text">2.2.2.4 elr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-5-CurrentEL"><span class="nav-text">2.2.2.5 CurrentEL</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E7%B3%BB%E7%BB%9F%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">2.2.3 系统寄存器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-1-SCR"><span class="nav-text">2.2.3.1 SCR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-2-HCR"><span class="nav-text">2.2.3.2 HCR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-3-SPSR"><span class="nav-text">2.2.3.3 SPSR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-4-SCTLR"><span class="nav-text">2.2.3.4 SCTLR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-5-TCR"><span class="nav-text">2.2.3.5 TCR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-6-TTBR"><span class="nav-text">2.2.3.6 TTBR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-7-FAR"><span class="nav-text">2.2.3.7 FAR</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-8-ESR"><span class="nav-text">2.2.3.8 ESR</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4"><span class="nav-text">2.3 汇编指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96"><span class="nav-text">2.4 内联汇编</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7"><span class="nav-text">三、开发工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-manjaro"><span class="nav-text">3.1 manjaro</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%99%A8"><span class="nav-text">3.2 交叉编译器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab-0"><span class="nav-text">Lab 0</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#manjaro"><span class="nav-text">manjaro</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="nav-text">实验环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="nav-text">思考题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab-1"><span class="nav-text">Lab 1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8C"><span class="nav-text">内核编译运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UART"><span class="nav-text">UART</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8"><span class="nav-text">内核启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E8%84%9A%E6%9C%AC"><span class="nav-text">链接脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%A2%98-1"><span class="nav-text">思考题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab-2"><span class="nav-text">Lab 2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80%E5%B8%83%E5%B1%80"><span class="nav-text">内存地址布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Arm-%E7%9A%84%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84%E4%B8%8E%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-text">Arm 的地址映射与重定向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF-MMU"><span class="nav-text">开启 MMU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%BA%A7%E9%A1%B5%E8%A1%A8"><span class="nav-text">三级页表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E8%A1%A8%E6%9D%83%E9%99%90%E4%BD%8D"><span class="nav-text">页表权限位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TLB-%E5%88%B7%E6%96%B0"><span class="nav-text">TLB 刷新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B5%8B%E8%AF%95%E6%B5%8B%E8%AF%95"><span class="nav-text">内存测试测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%A2%98-2"><span class="nav-text">思考题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab-3"><span class="nav-text">Lab 3</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E5%BC%82%E5%B8%B8"><span class="nav-text">开启异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%92%9F%E4%B8%AD%E6%96%AD"><span class="nav-text">时钟中断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E5%BC%82%E5%B8%B8"><span class="nav-text">同步异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%88%E5%B8%A7%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-text">栈帧的设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ELF-64"><span class="nav-text">ELF 64</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%A2%98-3"><span class="nav-text">思考题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab-4"><span class="nav-text">Lab 4</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-text">系统调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%80%81%E5%BC%B9%E6%A0%88"><span class="nav-text">用户态弹栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%80%81%E9%A1%B5%E8%A1%A8"><span class="nav-text">用户态页表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0"><span class="nav-text">写时复制机制实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fork-%E7%9A%84%E6%A3%80%E9%AA%8C"><span class="nav-text">fork 的检验</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab-5"><span class="nav-text">Lab 5</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EMMC-SD%E5%8D%A1-%E9%A9%B1%E5%8A%A8"><span class="nav-text">EMMC(SD卡)驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="nav-text">字节序问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%80%81emmc%E6%8E%A7%E5%88%B6"><span class="nav-text">用户态emmc控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fs-serv%E7%9A%84%E7%A7%BB%E6%A4%8D"><span class="nav-text">fs_serv的移植</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E7%94%A8%E6%88%B7%E6%80%81%E9%A9%B1%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81%E9%A9%B1%E5%8A%A8%E4%BC%98%E7%BC%BA%E7%82%B9%E7%9A%84%E6%8E%A2%E8%AE%A8"><span class="nav-text">关于用户态驱动和内核态驱动优缺点的探讨</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab-6"><span class="nav-text">Lab 6</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#arm-%E7%9A%84%E5%8E%8B%E6%A0%88%E6%96%B9%E5%BC%8F"><span class="nav-text">arm 的压栈方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8F%98%E9%95%BF%E5%8F%82%E6%95%B0%E8%A7%A3%E5%86%B3%E5%8F%98%E9%95%BF%E5%8F%82%E6%95%B0"><span class="nav-text">利用变长参数解决变长参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E4%BC%A0%E9%80%92%E5%80%BC"><span class="nav-text">寄存器传递值</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Thysrael"
      src="/images/avatar2.png">
  <p class="site-author-name" itemprop="name">Thysrael</p>
  <div class="site-description" itemprop="description">Can you hear me ?</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">199</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="">
    <a target="_blank" class="social-link" href="/atom.xml" style="color: burlywood;">
      <span class="icon">
        <i class="fa fa-rss"></i>
      </span>
      <span class="label">RSS</span>
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/thysrael" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;thysrael" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:thysrael@163.com" title="E-Mail → mailto:thysrael@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021.12.18 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thysrael</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">20:20</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
